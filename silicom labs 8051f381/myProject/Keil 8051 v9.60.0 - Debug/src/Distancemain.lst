C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE DISTANCEMAIN
OBJECT MODULE PLACED IN .\src\Distancemain.OBJ
COMPILER INVOKED BY: F:\SiliconLabs\SimplicityStudio\v5\developer\toolchains\keil_8051\9.60\BIN\C51.exe C:\Users\52876\S
                    -implicityStudio\v5_workspace\myProject\src\Distancemain.c OMF2 SMALL DEBUG OBJECTEXTEND ROM(LARGE) WARNINGLEVEL(2) FLOAT
                    -FUZZY(3) OPTIMIZE(8,SPEED) DEFINE(DEBUG=1) INTVECTOR(0X0000) INTPROMOTE INCDIR(C:\Users\52876\SimplicityStudio\v5_worksp
                    -ace\myProject\external_copied_files;F:/SiliconLabs/SimplicityStudio/v5/developer/sdks/8051/v4.3.1//Device/shared/si8051B
                    -ase;F:/SiliconLabs/SimplicityStudio/v5/developer/sdks/8051/v4.3.1//Device/C8051F380/inc) PRINT(.\src\Distancemain.lst) C
                    -OND PAGEWIDTH(120) PAGELENGTH(65) OBJECT(.\src\Distancemain.OBJ)

line level    source

   1          ///********************************************************************************
   2          //* FILE NAME           : LMD(æŒ‰é”®å¼:å•ç‚¹/èŒƒå›´è¾“å‡ºRS232 å’ŒRS485ï¼‰.C
   3          //* Copyright           : 2012--2020 Lucheng Sensor Corporation,All Rights Reserved.
   4          //* Module Name         : æ¿€å…‰æµ‹è·ä»ª
   5          //* CPU                 : C8051F381
   6          //* Create Date         : 2013/09/05
   7          //* Author              : Kerry_Sun
   8          //* Abstract Description:
   9          //*
  10          //
  11          //**------------------------ Revision History ----------------------------------**
  12          //
  13          //* No     Version       Date          Revised By     Item    Description
  14          //* 1       V1.41         2015/03/13   Kerry                   first release
  15          //
  16          //* æ›´æ”¹è¾“å‡ºä¸ºä¸‰ç«¯å¼
  17          //*                       2015/04/13    Kerry                  æ›´æ”¹æ¿€å…‰æœºèŠ¯åˆå§‹åŒ– ï¼šå»æ‰PR
  18          //2         V1.42         2015/06/19    Kerry                  æ›´æ”¹ä¸²å£ä¸­æ–­ä¸ºé«˜ä¼˜å…ˆçº§
  19          //3         V1.351        2015/09/11    Kerry                  å»æ‰DIR0ï¼Œå¢åŠ ç»§ç”µå™¨å’ŒPNPçš„è¾“å‡º
             -é€‰æ‹©ï¼š=0 è·ç¦»æŠ¥è­¦è¾“å‡ºï¼Œ=1 é”™è¯¯æŠ¥è­¦è¾“å‡º
  20          //4         V2.0          2015/10/19    kerry                  å°†RS232å’ŒRS485åˆå¹¶åœ¨ä¸€ä¸ªç¨‹åºé‡Œé¢
  21          //5         V2.2          2016/4/21    kerry                  ä¿®æ”¹RS485é€šè®¯å¤šæœºæ­»æœºé—®é¢˜
  22          //6.        V3.0          2020.06.16    kerry                  ä¿®æ”¹å…ˆæŒ‰enteré”®ï¼Œå†æŒ‰SETé”®å‡ºç°é”
             -™è¯¯æ˜¾ç¤ºçš„bug
  23          //7         V3.1          2021/04/09    Mark Dresser          Correct comm lockup bug, rename b -> bx, up-
             ->upx for KEIL toolset
  24          //8         V3.2      2021/06/21    Mark Dresser          Correct distance overflow error above 65 m.
  25          //*********************************************************************************/
  26          ////#include <config_381.h>
  27          //
  28          //#include <math.h>
  29          //#include <stdio.h>
  30          //#include <absacc.h>
  31          //#include "compiler_defs.h"
  32          //#include "C8051F380_defs.h"
  33          //#include "SI_C8051F380_Defs.h"
  34          //
  35          //
  36          //#define  uchar  unsigned char
  37          //#define  uint  unsigned int
  38          //#define  ulint  unsigned long int
  39          //#define lint  long int
  40          //
  41          //#define version_major '3'
  42          //#define version_minor '2'
  43          //
  44          //uchar code par0[38] ={    0x00,0x00,0x02,0x00,0x00, //RB00.200---0,1,2,3,4
  45          //                          0x03,0x00,0x00,0x00,0x00, //RE30.000---5,6,7,8,9,
  46          //                0x01,0x00,0x00,0x00,0x00, //UP10.000----10,11,12,13,14
  47          //                          0x00,0x02,0x00,0x00,0x00, //LO02.000---15,16,17,18,19
  48          //                0x00,           //ADD--20,
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 2   

  49          //                0x00,0x00,0x02,0x00,0x00, //AH ---21,22,23,24,25
  50          //                0x01,0x02,0x03, //ä¸Šç”µè¯†åˆ«ä»£ç  26,27,28
  51          //                              0x00,0x02,0x05,0x00,0x00, // AC ---29,30,31,32,33,
  52          //                0x01,                      // OPT---34  1:<AL ;2:AL--AH;3:>AH
  53          //                              0x00,                      //ç»§ç”µå™¨çš„è¾“å‡ºå½¢å¼ï¼Œ=0ï¼š è·ç¦»è¾“å‡º
             -ï¼›=1ï¼šå‡ºé”™è¾“å‡º----35
  54          //                0x00,                        //PNPçš„è¾“å‡ºå½¢å¼ï¼Œ=0ï¼š è·ç¦»è¾“å‡ºï¼›=1ï¼šå‡ºé”™è¾“å
             -‡º------36
  55          //                0x01                          //0=rs232,1 =rs485
  56          //                         };
  57          //uchar idata par_buf[38];//ä»å•ç‰‡æœºå†…éƒ¨çš„flashè¯»å‡ºæ•°æ®åˆ°XRAM
  58          //
  59          ////flash
  60          //uchar xdata *pwrite;//å¤–éƒ¨æ•°æ®ç¼“å†²åŒº
  61          //uchar code *pread;
  62          //
  63          //uchar *par;
  64          //
  65          //sbit ALARM  = P2^0;
  66          //sbit m_clk  = P1^0;
  67          //sbit m_load = P1^2;
  68          //sbit m_din  =   P1^1;
  69          //sbit enter    = P1^7;
  70          //sbit shift_right= P1^6;
  71          //sbit upx      = P1^5;
  72          //sbit function = P1^4;
  73          //sbit Power = P1^3;
  74          //sbit OUT0 = P2^6;
  75          //sbit OUT1   =   P2^5;
  76          ////sbit OUT3 = P2^2;
  77          //sbit MODE         = P0^7;
  78          //sbit RXEN        = P0^3;
  79          //sbit DXEN        = P0^6;
  80          ////sbit ON           = P2^4;
  81          ////sbit SLEW         = P0^2;
  82          //
  83          //
  84          //
  85          //ulint data UP;
  86          //ulint data LO;
  87          //ulint data AH;
  88          //
  89          //uchar data CTR;
  90          //ulint data now_val;
  91          //uchar idata a,bx,c,d,e;
  92          //
  93          //
  94          //uchar data receive0_temp[10]={' ',' ',' ',' ',' ',' ',' ',' ',' ',' '};
  95          //
  96          //
  97          //uchar idata function_flag;
  98          //
  99          //uchar idata up_flag;
 100          //uchar idata shift_right_flag=0;
 101          //uchar idata enter_flag;
 102          //bit   idata   find_key;                   //åŠŸèƒ½æŒ‰é”®æŒ‰ä¸‹
 103          //
 104          //
 105          ////----------------------------UART1-----------------------------------------
 106          //uchar data receive1[12]={' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' '};
 107          //uchar data send_buf[12]={' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' '};
 108          //
 109          //volatile uchar data tl0timer0=0;//20msçš„æ—¶é—´åŸºå‡†
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 3   

 110          //bit b_head_sure= 0;
 111          //bit send_enable=0;
 112          ////uchar idata rcv1_end_flag = 0;
 113          //uchar idata rcv_count = 0;
 114          //bit uart1_receve_end = 0;
 115          //volatile uchar data txcount0=0;
 116          //volatile uchar data txptr0=0;//æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ªåœ°å€
 117          //
 118          ////---------------------------------------------------------------------------
 119          //
 120          //void trans0(char *str);
 121          //
 122          //void display(void);
 123          //
 124          //void display_add(void);
 125          //void  shift0_5(void);
 126          //void  shift_add(void);
 127          //void disp_emissivity_5(void);
 128          //void disp_emissivity0_5(void);
 129          //void disp_emissivity_2(void);
 130          //void disp_emissivity0_2(void);
 131          ////void display_uart0(void);
 132          //void rb1(void);
 133          //void send_rb(void);
 134          //void send_rb3();
 135          //void send_rb0();
 136          //void send_dt(void);
 137          //void send_dt1(void);
 138          ////void dt(void);
 139          //void send_re(void);
 140          //void re1();
 141          //void send_re3();
 142          //void send_re0();
 143          //
 144          //void send_ah(void);
 145          //void ah1(void);
 146          //
 147          //void send_dl();
 148          //void dl1();
 149          //void pa(void);
 150          ////void pr(void);
 151          //void send_dh();
 152          //void dh1();
 153          //
 154          //void send_opt();
 155          //void opt();
 156          //void po();
 157          //void send_po();
 158          //void rl();
 159          //void send_rl();
 160          //void alarm_state(void);
 161          //void direct_uart1();
 162          //void direct_uart0(void);
 163          //void send_ver();
 164          ////void send_error_code1();
 165          ////void send_error_code2();
 166          ////void display_dt();
 167          //void send_crc_buf(void);
 168          //
 169          ////-----------------------------------------------------------------------------
 170          //// SiLabs_Startup() Routine
 171          //// ----------------------------------------------------------------------------
 172          //// This function is called immediately after reset, before the initialization
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 4   

 173          //// code is run in SILABS_STARTUP.A51 (which runs before main() ). This is a
 174          //// useful place to disable the watchdog timer, which is enable by default
 175          //// and may trigger before main() in some instances.
 176          ////-----------------------------------------------------------------------------
 177          //void SiLabs_Startup (void)
 178          //{
 179          //  PCA0MD &= ~0x40;    //clear WD Timer Enable at beginning of initialization code or it may fire.
 180          //}
 181          //
 182          ///////////////////////////////////////
 183          ////  Generated Initialization File  //
 184          //
 185          //void PCA_Init()
 186          //{
 187          //    PCA0MD    &= ~0x40;
 188          //    PCA0MD    = 0x00;
 189          //    PCA0CPL4  = 0xC2;
 190          //    PCA0MD    |= 0x20;
 191          //}
 192          //
 193          //void UART0_Init()
 194          //{
 195          //    SCON0     = 0x10;
 196          //
 197          //    TCON      = 0x50; //timer1 enable
 198          //    TMOD      = 0x21; //8bit counter/timer autoreload
 199          //    CKCON     = 0x01; //timer1 clock = sysclock
 200          //    TH1       = 0x64; //bandrate 9600bit
 201          //  TL1       = TH1;
 202          //  ES0       = 1;
 203          //
 204          //  // IP |= 0x10;                         // Make UART high priority
 205          //}
 206          //
 207          //void UART1_Init()
 208          //{
 209          //
 210          //   SMOD1 = 0x0C;
 211          //
 212          //   SCON1 = 0x10;                       // SCON1: 8-bit variable bit rate
 213          //                                       //        level of STOP bit is ignored
 214          //                                       //        RX enabled
 215          //                                       //        ninth bits are zeros
 216          //                                       //        clear RI0 and TI0 bits
 217          //    SBRLL1    = 0x8F;  // 9600
 218          //    SBRLH1    = 0xFD;
 219          //
 220          //
 221          //    SBCON1 |= 0x43;                     // enable baud rate generator
 222          //
 223          //
 224          //  SCON1 |= 0x02;                      // indicate ready for TX
 225          //
 226          //   EIE2 |= 0x02;  //enable UART1 interrupt
 227          //     EIP2 |= 0x02;   // Make UART high priority
 228          //
 229          //
 230          //}
 231          //void timer0_init(void)
 232          //{
 233          //    TCON      = 0x00;
 234          //    TMOD      = 0x01;
 235          //   CKCON=0x00;        //timer0ä½¿ç”¨sysclk/12
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 5   

 236          //   ET0=1;         //ET0=1;
 237          //   TH0=(65536-20000)/256;//20mså®šæ—¶
 238          //   TL0=(65535-20000)%256;
 239          //   TR0=1;
 240          // //  PT0=1;             //ä¸ºé»˜è®¤ä¼˜å…ˆçº§
 241          //
 242          //}
 243          //void Port_IO_Init()
 244          //{
 245          // // P0.0  -  TX1 (UART1), Push-Pull,  Digital
 246          //    // P0.1  -  RX1 (UART1), Open-Drain, Digital
 247          //    // P0.2  -  Unassigned,  Open-Drain, Digital
 248          //    // P0.3  -  Unassigned,  Open-Drain, Digital
 249          //    // P0.4  -  TX0 (UART0), Push-Pull,  Digital
 250          //    // P0.5  -  RX0 (UART0), Open-Drain, Digital
 251          //    // P0.6  -  Unassigned,  Open-Drain, Digital
 252          //    // P0.7  -  Unassigned,  Open-Drain, Digital
 253          //
 254          //    // P1.0  -  Unassigned,  Open-Drain, Digital
 255          //    // P1.1  -  Unassigned,  Open-Drain, Digital
 256          //    // P1.2  -  Unassigned,  Open-Drain, Digital
 257          //    // P1.3  -  Unassigned,  Open-Drain, Digital
 258          //    // P1.4  -  Unassigned,  Open-Drain, Digital
 259          //    // P1.5  -  Unassigned,  Open-Drain, Digital
 260          //    // P1.6  -  Unassigned,  Open-Drain, Digital
 261          //    // P1.7  -  Unassigned,  Open-Drain, Digital
 262          //
 263          //    // P2.0  -  Unassigned,  Open-Drain, Digital
 264          //    // P2.1  -  Unassigned,  Open-Drain, Digital
 265          //    // P2.2  -  Unassigned,  Open-Drain, Digital
 266          //    // P2.3  -  Unassigned,  Open-Drain, Digital
 267          //    // P2.4  -  Unassigned,  Open-Drain, Digital
 268          //    // P2.5  -  Unassigned,  Open-Drain, Digital
 269          //    // P2.6  -  Unassigned,  Open-Drain, Digital
 270          //    // P2.7  -  Unassigned,  Open-Drain, Digital
 271          //
 272          //    // P3.0  -  Unassigned,  Open-Drain, Digital
 273          //
 274          //    P0MDOUT   = 0x11;    //TX0 TX1 push-pull
 275          //    XBR0      = 0x01;    //UART0 ENABLE
 276          //    XBR1      = 0x40;    //Crossbar Enable
 277          //    XBR2      = 0x01;    //UART1 ENABLE
 278          //
 279          //
 280          //}
 281          //
 282          //void Oscillator_Init()
 283          //{
 284          //    int i = 0;          //å»æ‰
 285          //    OSCICN    = 0xC3;
 286          //}
 287          //// Initialization function for device,
 288          //// Call Init_Device() from your main program
 289          //void Init_Device(void)
 290          //{
 291          //    PCA_Init();              //Programmable Counter Array
 292          //    timer0_init();
 293          //    UART0_Init();
 294          //  UART1_Init();
 295          //    Port_IO_Init();
 296          //    Oscillator_Init();
 297          //}
 298          //
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 6   

 299          //void trans0(char *str)
 300          //{
 301          //  uchar *p;
 302          //  p = str;
 303          //  while(*p!='\0')
 304          //  {
 305          //    PCA0CPH4 = 0xa0;
 306          //    SBUF0 = *p++;
 307          //    while(!TI0);
 308          //    TI0 = 0;
 309          //  }
 310          //}
 311          //
 312          ///////////////////////////////////////////////////////
 313          ///*                      DELAY                      */
 314          ///////////////////////////////////////////////////////
 315          //
 316          //void delay(int  n)
 317          //{
 318          //  int i;
 319          //  int j;
 320          //
 321          //  for (i=0;i<n;i++)
 322          //  {
 323          //
 324          //  for(j=0;j<1;j++)
 325          //  {PCA0CPH4 = 0xa0;}
 326          //  }
 327          //}
 328          //
 329          //
 330          //
 331          //void delay20ms(void)
 332          //{
 333          //    uchar j;
 334          //    for(j=0;j<100;j++)
 335          //    {
 336          //      PCA0CPH4 = 0xa0;
 337          //        delay(40);
 338          //
 339          //    }
 340          //}
 341          //
 342          //void delay1s(void)
 343          //{
 344          //  uchar l;
 345          //  for(l=0;l<10;l++)
 346          //  {
 347          //    PCA0CPH4 = 0xa0;
 348          //    delay20ms();
 349          //  }
 350          //}
 351          ///////////////////////////////////////////////////////
 352          ///*                    m_display                      */
 353          ///////////////////////////////////////////////////////
 354          //static  struct
 355          //{
 356          //  uchar ascii;
 357          //  uchar stroke;
 358          //}code led_stroke[]=
 359          //  {
 360          //    {0,0x7e},{1,0x30},{2,0x6d},{3,0x79},{4,0x33},
 361          //    {5,0x5b},{6,0x5f},{7,0x70},{8,0x7f},{9,0x7b},
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 7   

 362          //    {'0',0x7e},{'1',0x30},{'2',0x6d},{'3',0x79},{'4',0x33},
 363          //    {'5',0x5b},{'6',0x5f},{'7',0x70},{'8',0x7f},{'9',0x7b},
 364          //    {'A',0x77},{'B',0x1f},{'C',0x4e},{'D',0x3d},{'E',0x4f},
 365          //    {'F',0x47},{'H',0x37},{'I',0X06},{'L',0x0e},{'M',0x15},
 366          //    {'O',0x1d},{'P',0x67},{'R',0x05},{'S',0x5b},{'T',0x46},
 367          //    {'Y',0x3b},{'U',0x3E},{'-',0x01},{' ',0x00},{'\n',0x00},{'\r',0x00}
 368          //  };
 369          //
 370          //
 371          //
 372          //void  m_send(uchar addr,uchar da)
 373          //{
 374          //  uchar i,byte_out;
 375          //  byte_out=addr;
 376          //  m_clk=0;
 377          //  m_load=0;
 378          //  for(i=0;i<8;i++)                              //address
 379          //    {
 380          //      m_din=byte_out&0x80;
 381          //        m_clk = 0;
 382          //          PCA0CPH4 = 0xa0;    //160
 383          //      m_clk = 1;
 384          //      byte_out=byte_out<<1;
 385          //    }
 386          //  byte_out=da;
 387          //  for(i=0;i<8;i++)                             //data
 388          //    {
 389          //      m_din=byte_out&0x80;
 390          //      m_clk=0;
 391          //
 392          //        PCA0CPH4 = 0xa0;
 393          //      m_clk = 1;
 394          //      byte_out=byte_out<<1;
 395          //    }
 396          //
 397          //  m_load=1;
 398          //
 399          //}
 400          //
 401          //void  m_init(void)                      //ledæ˜¾ç¤º
 402          //{
 403          //  m_send(0x09,0x00);//no dcode
 404          //  m_send(0x0a,0x02);//light
 405          //  m_send(0x0b,0x04);//number 5
 406          //  m_send(0x0c,0x01);//start
 407          //  m_send(0x0f,0x00);
 408          //
 409          //}
 410          //
 411          //uchar get_stroke(uchar c)
 412          //{
 413          //  uchar i=0;
 414          //  while(led_stroke[i].ascii!=c)
 415          //  {
 416          //    i++;
 417          //      PCA0CPH4 = 0xa0;
 418          //    if(i>40)
 419          //    {
 420          //      return(' ');
 421          //    }
 422          //  }
 423          //  return(led_stroke[i].stroke);
 424          //}
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 8   

 425          //
 426          //
 427          ///////////////////////////////////////////////////////
 428          ///*               C8051F38X flash                   */
 429          ///////////////////////////////////////////////////////
 430          ///*
 431          //PSCTL:
 432          //ä½0 PSWE - ç½®ä½ï¼Œå…è®¸å†™FLASHï¼›
 433          //ä½1 PSEE - ç½®ä½ï¼Œå…è®¸æ“¦é™¤FLASHï¼›
 434          //ä½2 SFLE - ç½®ä½ï¼Œå…è®¸ç”¨æˆ·è½¯ä»¶è®¿é—®FLASHçš„128Bçš„ä¸´æ—¶å­˜å‚¨å™¨æ‰‡åŒº
 435          //å…¶ä»–ä½ç½®0
 436          //
 437          //FLSCLï¼š
 438          //ä½0 FLWE - ç½®ä½ï¼Œå…è®¸å†™FLASHï¼›
 439          //ä½1-5 ä¿ç•™ï¼Œ0000ï¼›
 440          //ä½6 FRAE - ç½®ä½ï¼Œé—ªå­˜æ€»æ˜¯å¤„äºè¯»æ–¹å¼
 441          //ä½7 FOSE - ç½®ä½ï¼Œå…è®¸é—ªå­˜å•ç¨³æ€å®šæ—¶å™¨
 442          //*/
 443          //
 444          //void erase_par(void)  //é¦–æ¬¡ä¸Šç”µåˆå§‹åŒ–,å°†å¤–éƒ¨æ•°æ®åˆå§‹åŒ–ä¸º0xff
 445          //{
 446          //  EA=0;
 447          //    FLKEY=0xA5;
 448          //  FLKEY=0xF1;
 449          //  PSCTL=0x03; //  bit1 PSEE =1 : permit erase; bit0 PSWE = 1 :permit write
 450          //  pwrite=0x7E00;
 451          //  *pwrite=0x00;
 452          //    PSCTL=0x00;   // å¤ä½ï¼Œç”¨æˆ·è½¯ä»¶è®¿é—®FLASHçš„64KBçš„ç¨‹åº/æ•°æ®FLASHæ‰‡åŒºï¼Œå¾ˆé‡è¦ï¼ï¼
             -ï¼
 453          //
 454          //}
 455          //
 456          //void read_par(void)
 457          //{
 458          //  uchar data i;
 459          //
 460          //  FLSCL=0xcf;       //ç¦æ­¢flashå†™
 461          //  PSCTL=0x00;
 462          //  pread=0x7E00;     //åˆå§‹åŒ–codeè¯»æŒ‡é’ˆä¸ºå­—ç¬¦ä¸²èµ·å§‹å˜é‡
 463          //  for(i=0;i<38;i++)
 464          //  {
 465          //    par_buf[i]=*pread++;    //å°†FLASHå†…æ•°æ®è¯»åˆ°XRAM
 466          //   PCA0CPH4 = 0xa0;
 467          //  }
 468          //
 469          //}
 470          //void init_par(void)
 471          //{
 472          //
 473          //  uchar data i;
 474          //   PFE0CN =0x00;        // select single-byte write mode.
 475          //  PSCTL=0x01;           //å…è®¸å†™å…¥flash
 476          //  par=&par0[0];
 477          //  pwrite=0x7E00;
 478          //  for (i=0;i<38;i++)
 479          //  {
 480          //         FLKEY=0xA5;            //Flash Lock and Key é¡ºåºè¦å¯¹
 481          //       FLKEY=0xF1;
 482          //      *pwrite=*par;
 483          //      pwrite++;
 484          //      par++;
 485          //      PCA0CPH4 = 0xa0;              //feed dog
 486          //    }
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 9   

 487          //    PSCTL=0x00;      //ç¦æ­¢å†™å…¥flash
 488          //
 489          //    read_par();
 490          //
 491          //}
 492          //
 493          //
 494          //
 495          //void write_par(void)
 496          //{
 497          //  uchar data i;
 498          //   PFE0CN =0x00;
 499          //  PSCTL=0x01;
 500          //  pwrite=0x7E00;
 501          //  for (i=0;i<38;i++)
 502          //  {
 503          //      FLKEY=0xA5;
 504          //       FLKEY=0xF1;
 505          //    *pwrite++=par_buf[i];
 506          //    PCA0CPH4 = 0xa0;
 507          //  }
 508          //    PSCTL=0x00;
 509          //    read_par();
 510          //
 511          //}
 512          //
 513          //void timer0_isr(void) interrupt 1 //using 1
 514          //
 515          //{
 516          //   uchar data key_value_temp;
 517          //
 518          //  if(tl0timer0<5)
 519          //  {tl0timer0++;}//ä¸PCé€šä¿¡ç©ºé—²çš„æ—¶é—´*/
 520          //
 521          //   key_value_temp=(~P1)&0xf0; // 0x00101110  P1^4:SET; P1^5:ADD; P1^6:REDUCE; P1^7:OK     //REDUCE or sh
             -iftï¼Ÿ
 522          //
 523          //  if (key_value_temp!=0)
 524          //   {
 525          //       delay(10);
 526          //
 527          //    if (key_value_temp!=0)
 528          //    {
 529          //     delay(10);
 530          //
 531          //      switch(key_value_temp)
 532          //    {
 533          ////        key_value_temp= (~P1)&0xf0;   // this isn't even executed (but even if it was, it wouldn't ret
             -roactively change the result of switch statement above?
 534          //      case 0x10:  function_flag++;
 535          //                     find_key=1;
 536          //                  if (function_flag==12)
 537          //              {
 538          //                function_flag=1;
 539          //              }
 540          //            do{ PCA0CPH4 = 0xa0;}
 541          //              while (function==0);
 542          //              delay(10);
 543          //
 544          //            break;
 545          //      case 0x40:  shift_right_flag++;
 546          //
 547          //            if (shift_right_flag==6)
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 10  

 548          //            {
 549          //              shift_right_flag=1;
 550          //                  }
 551          //              do{ PCA0CPH4 = 0xa0;}
 552          //            while (shift_right==0);
 553          //            delay(10);;
 554          //
 555          //            break;
 556          //      case 0x20:  up_flag++;
 557          //
 558          //            if (up_flag==10)
 559          //            {
 560          //              up_flag=0;
 561          //                }
 562          //              do{PCA0CPH4 = 0xa0; }
 563          //            while (upx==0);
 564          //            delay(10);;
 565          //
 566          //            break;
 567          //      case  0x80: if(function_flag!=0)
 568          //                   {enter_flag=1;}
 569          //              do{PCA0CPH4 = 0xa0; }
 570          //              while (enter==0);
 571          //              delay(10);;
 572          //
 573          //            break;
 574          //      default:  break;
 575          //      }
 576          //   }
 577          //  }
 578          //    TH0=(65535-20000)/256;    //20mså®šæ—¶é‡è½½65536-18432
 579          //    TL0=(65535-20000)%256;
 580          //
 581          //
 582          //
 583          //}
 584          //
 585          //void key_flag_init(void)
 586          //{
 587          //  function_flag=0;
 588          //  up_flag=0;
 589          //  shift_right_flag=0;
 590          //  enter_flag=0;
 591          //}
 592          //void scan_keyboard(void)
 593          //{
 594          // // if(function_flag==0) return ;
 595          //
 596          //  switch(function_flag)
 597          //  {
 598          //    case 1:
 599          //
 600          //                m_init();
 601          //          m_send(0x01,get_stroke('1'));
 602          //          m_send(0x02,get_stroke('-'));
 603          //          m_send(0x03,get_stroke('-'));
 604          //          m_send(0x04,get_stroke('R'));
 605          //          m_send(0x05,get_stroke('B'));
 606          //
 607          //            find_key=1;
 608          //
 609          //              a=par_buf[0];
 610          //                 bx=par_buf[1];
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 11  

 611          //                 c=par_buf[2];
 612          //               d=par_buf[3];
 613          //               e=par_buf[4];
 614          //        if  (enter_flag==1)
 615          //        {
 616          //          shift_right_flag=1;
 617          //                  up_flag=0;
 618          //                  enter_flag=0;
 619          //          display();
 620          //           do
 621          //                      {
 622          //                    PCA0CPH4 = 0xa0;
 623          //                        shift0_5(); //æ˜¾ç¤º5ä½
 624          //
 625          //                     }
 626          //                     while  (enter_flag==0);
 627          //                    {
 628          //
 629          //                      key_flag_init();
 630          //
 631          //                   display();
 632          //                      par_buf[0]=a;
 633          //                      par_buf[1]=bx;
 634          //                      par_buf[2]=c;
 635          //                    par_buf[3]=d;
 636          //                    par_buf[4]=e;
 637          //               EA=0;
 638          //                     erase_par();
 639          //                   write_par();     //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
 640          //                    EA=1;
 641          //
 642          //                      SBUF0 = 'R';  while(!TI0);TI0 = 0;
 643          //               SBUF0 = 'B';  while(!TI0);TI0 = 0;
 644          //                SBUF0 = par_buf[0]+0x30;while(!TI0);TI0 = 0;
 645          //                SBUF0 = par_buf[1]+0x30;while(!TI0);TI0 = 0;
 646          //                SBUF0 = '.';            while(!TI0);TI0 = 0;
 647          //                SBUF0 = par_buf[2]+0x30;while(!TI0);TI0 = 0;
 648          //                SBUF0 = par_buf[3]+0x30;while(!TI0);TI0 = 0;
 649          //                SBUF0 = par_buf[4]+0x30;while(!TI0);TI0 = 0;
 650          //                SBUF0 = 0x0d;           while(!TI0);TI0 = 0;
 651          //                SBUF0 = 0x0a;           while(!TI0);TI0 = 0;
 652          //                delay1s();
 653          //                delay1s();
 654          //
 655          //                trans0("DT\r\n");
 656          //                delay1s();
 657          //                delay1s();
 658          //
 659          //                find_key = 0;
 660          //                delay1s();
 661          //
 662          //
 663          //
 664          //                  }
 665          //
 666          //
 667          //        }
 668          //        break;
 669          //    case 2:
 670          //
 671          //                m_init();
 672          //          m_send(0x01,get_stroke('2'));
 673          //          m_send(0x02,get_stroke('-'));
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 12  

 674          //          m_send(0x03,get_stroke('-'));
 675          //          m_send(0x04,get_stroke('R'));
 676          //          m_send(0x05,get_stroke('E'));
 677          //
 678          //           find_key=1;
 679          //               a=par_buf[5];
 680          //                 bx=par_buf[6];
 681          //                 c=par_buf[7];
 682          //               d=par_buf[8];
 683          //               e=par_buf[9];
 684          //
 685          //        if  (enter_flag==1)
 686          //        {
 687          //          shift_right_flag=1;
 688          //                  up_flag=0;
 689          //                  enter_flag=0;
 690          //          display();
 691          //           do
 692          //                      {
 693          //                    PCA0CPH4 = 0xa0;
 694          //                        shift0_5(); //æ˜¾ç¤º5ä½
 695          //
 696          //                     }
 697          //                     while  (enter_flag==0);
 698          //                    {
 699          //
 700          //                      key_flag_init();
 701          //
 702          //                   display();
 703          //                     par_buf[5]=a;
 704          //                      par_buf[6]=bx;
 705          //                      par_buf[7]=c;
 706          //                    par_buf[8]=d;
 707          //                    par_buf[9]=e;
 708          //
 709          //                       EA=0;
 710          //                     erase_par();
 711          //                   write_par();     //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
 712          //                      EA=1;
 713          //            SBUF0 = 'R';           while(!TI0);TI0 = 0;
 714          //                SBUF0 = 'E';             while(!TI0);TI0 = 0;
 715          //                SBUF0 = par_buf[5]+0x30; while(!TI0);TI0 = 0;
 716          //                SBUF0 = par_buf[6]+0x30; while(!TI0);TI0 = 0;
 717          //                SBUF0 = '.';             while(!TI0);TI0 = 0;
 718          //                SBUF0 = par_buf[7]+0x30; while(!TI0);TI0 = 0;
 719          //                SBUF0 = par_buf[8]+0x30; while(!TI0);TI0 = 0;
 720          //                SBUF0 = par_buf[9]+0x30; while(!TI0);TI0 = 0;
 721          //                SBUF0 = 0x0d;            while(!TI0);TI0 = 0;
 722          //                SBUF0 = 0x0a;            while(!TI0);TI0 = 0;
 723          //                delay1s();
 724          //                delay1s();
 725          //                trans0("DT\r\n");
 726          //                  delay1s();
 727          //                delay1s();
 728          //
 729          //                  find_key = 0;
 730          //                  delay1s();
 731          //
 732          //
 733          //                  }
 734          //
 735          //        }
 736          //        break;
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 13  

 737          //           case 3:     //è¾“å‡ºæ§åˆ¶æ–¹å¼ï¼ˆå•ç‚¹æˆ–èŒƒå›´ï¼‰
 738          //
 739          //          m_init();
 740          //          m_send(0x01,get_stroke('3'));
 741          //          m_send(0x02,get_stroke('-'));
 742          //          m_send(0x03,get_stroke('O'));
 743          //          m_send(0x04,get_stroke('P'));
 744          //          m_send(0x05,get_stroke('T'));
 745          //            find_key=1;
 746          //
 747          //        if  (enter_flag==1)
 748          //        {
 749          //           a=par_buf[34];
 750          //                 up_flag = a;
 751          //                  enter_flag=0;
 752          //
 753          //                 do
 754          //           {
 755          //             PCA0CPH4 = 0xa0;
 756          //                  if (up_flag==1)
 757          //                      {
 758          //                        a=1;
 759          //                      }
 760          //                 else if (up_flag==2)
 761          //                  {
 762          //                    a=2;
 763          //                    }
 764          //            else if (up_flag==3)
 765          //                  {
 766          //                    a=3;
 767          //                    }
 768          //                      else if (up_flag==4)
 769          //                  {
 770          //                    a=1;up_flag=1;
 771          //                    }
 772          //
 773          //
 774          //                     m_init();
 775          //                     m_send(0x01,get_stroke(a));
 776          //                     m_send(0x02,get_stroke(' '));
 777          //                     m_send(0x03,get_stroke(' '));
 778          //                     m_send(0x04,get_stroke(' '));
 779          //                     m_send(0x05,get_stroke(' '));
 780          //                     }
 781          //          while(enter_flag==0);
 782          //          {
 783          //
 784          //
 785          //                     key_flag_init();
 786          //
 787          //             par_buf[34]=a;
 788          //
 789          //              EA=0;
 790          //             erase_par();
 791          //                   write_par();     //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
 792          //
 793          //            EA=1;
 794          //                  find_key = 0;
 795          //                        delay1s();//ç­‰å¾…UART0æ¥æ”¶æ•°æ®ï¼Œå¦åˆ™ä¼šæ˜¾ç¤ºä¹±ç 
 796          //
 797          //                  }
 798          //
 799          //        }
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 14  

 800          //        break;
 801          //
 802          //        case 4:
 803          //
 804          //
 805          //              m_init();
 806          //          m_send(0x01,get_stroke('4'));
 807          //          m_send(0x02,get_stroke('-'));
 808          //          m_send(0x03,get_stroke('-'));
 809          //          m_send(0x04,get_stroke('D'));
 810          //          m_send(0x05,get_stroke('L'));
 811          //         find_key=1;
 812          //               a=par_buf[15];
 813          //                 bx=par_buf[16];
 814          //                 c=par_buf[17];
 815          //               d=par_buf[18];
 816          //               e=par_buf[19];
 817          //        if  (enter_flag==1)
 818          //        {
 819          //          shift_right_flag=1;
 820          //                  up_flag=0;
 821          //                  enter_flag=0;
 822          //          display();
 823          //           do
 824          //                      {
 825          //                   PCA0CPH4 = 0xa0;
 826          //                        shift0_5(); //æ˜¾ç¤º5ä½
 827          //
 828          //                     }
 829          //                     while  (enter_flag==0);
 830          //                    {
 831          //
 832          //                     key_flag_init();
 833          //
 834          //                   display();
 835          //                      par_buf[15]=a;
 836          //                      par_buf[16]=bx;
 837          //                      par_buf[17]=c;
 838          //                    par_buf[18]=d;
 839          //                    par_buf[19]=e;
 840          //
 841          //               EA=0;
 842          //                     erase_par();
 843          //                   write_par();     //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
 844          //            EA=1;
 845          //                  find_key = 0;
 846          //                      delay1s();
 847          //                  }
 848          //
 849          //        }
 850          //        break;
 851          //
 852          //    case 5:
 853          //
 854          //          m_init();
 855          //          m_send(0x01,get_stroke('5'));
 856          //          m_send(0x02,get_stroke('-'));
 857          //          m_send(0x03,get_stroke('-'));
 858          //          m_send(0x04,get_stroke('D'));
 859          //          m_send(0x05,get_stroke('H'));
 860          //          find_key=1;
 861          //               a=par_buf[10];
 862          //                 bx=par_buf[11];
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 15  

 863          //                 c=par_buf[12];
 864          //               d=par_buf[13];
 865          //               e=par_buf[14];
 866          //        if  (enter_flag==1)
 867          //        {
 868          //          shift_right_flag=1;
 869          //                  up_flag=0;
 870          //                  enter_flag=0;
 871          //          display();
 872          //           do
 873          //                      {
 874          //                   PCA0CPH4 = 0xa0;
 875          //                        shift0_5(); //æ˜¾ç¤º5ä½
 876          //
 877          //                     }
 878          //                     while  (enter_flag==0);
 879          //                    {
 880          //
 881          //                      key_flag_init();
 882          //
 883          //                   display();
 884          //                      par_buf[10]=a;
 885          //                      par_buf[11]=bx;
 886          //                      par_buf[12]=c;
 887          //                    par_buf[13]=d;
 888          //                    par_buf[14]=e;
 889          //
 890          //               EA=0;
 891          //                     erase_par();
 892          //                   write_par();     //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
 893          //
 894          //
 895          //              EA=1;
 896          //                       find_key = 0;
 897          //                   delay1s();
 898          //                  }
 899          //
 900          //        }
 901          //        break;
 902          //
 903          //
 904          //           case 6:
 905          //
 906          //          m_init();
 907          //          m_send(0x01,get_stroke('6'));
 908          //          m_send(0x02,get_stroke('-'));
 909          //          m_send(0x03,get_stroke('-'));
 910          //          m_send(0x04,get_stroke('A'));
 911          //          m_send(0x05,get_stroke('H'));
 912          //              find_key = 1;
 913          //
 914          //               a=par_buf[21];
 915          //                 bx=par_buf[22];
 916          //                 c=par_buf[23];
 917          //               d=par_buf[24];
 918          //               e=par_buf[25];
 919          //
 920          //        if  (enter_flag==1)
 921          //        {
 922          //          shift_right_flag=1;
 923          //                  up_flag=0;
 924          //                  enter_flag=0;
 925          //          display();
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 16  

 926          //           do
 927          //                      {
 928          //                    PCA0CPH4 = 0xa0;
 929          //                        shift0_5(); //æ˜¾ç¤º5ä½
 930          //
 931          //                     }
 932          //                     while  (enter_flag==0);
 933          //                    {
 934          //
 935          //                      key_flag_init();
 936          //
 937          //                   display();
 938          //                      par_buf[21]=a;
 939          //                      par_buf[22]=bx;
 940          //                      par_buf[23]=c;
 941          //                    par_buf[24]=d;
 942          //                    par_buf[25]=e;
 943          //
 944          //              EA=0;
 945          //                     erase_par();
 946          //                   write_par();     //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
 947          //              EA=1;
 948          //                         find_key = 0;
 949          //                           delay1s();
 950          //
 951          //
 952          //                  }
 953          //
 954          //        }
 955          //        break;
 956          //       case 7:    //ç»§ç”µå™¨è¾“å‡ºé€‰æ‹©
 957          //
 958          //          m_init();
 959          //          m_send(0x01,get_stroke('7'));
 960          //          m_send(0x02,get_stroke('-'));
 961          //          m_send(0x03,get_stroke('R'));
 962          //          m_send(0x04,get_stroke('L'));
 963          //          m_send(0x05,get_stroke('Y'));
 964          //
 965          //               find_key=1;
 966          //        if  (enter_flag==1)
 967          //        {
 968          //           a=par_buf[35];
 969          //                 up_flag = a;
 970          //                  enter_flag=0;
 971          //
 972          //                 do
 973          //           {
 974          //             PCA0CPH4 = 0xa0;
 975          //                  if (up_flag==0)
 976          //                      {
 977          //                        a=0;
 978          //                      }
 979          //                 else if (up_flag==1)
 980          //                  {
 981          //                    a=1;
 982          //                    }
 983          //
 984          //                      else if (up_flag==2)
 985          //                  {
 986          //                    a=0;up_flag=0;
 987          //                    }
 988          //
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 17  

 989          //
 990          //                      m_init();
 991          //          m_send(0x01,get_stroke(a));
 992          //          m_send(0x02,get_stroke(' '));
 993          //          m_send(0x03,get_stroke(' '));
 994          //          m_send(0x04,get_stroke(' '));
 995          //          m_send(0x05,get_stroke(' '));
 996          //                     }
 997          //          while(enter_flag==0);
 998          //          {
 999          //             par_buf[35]=a;
1000          //
1001          //                     key_flag_init();
1002          //
1003          //             EA=0;
1004          //             erase_par();
1005          //                   write_par();     //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
1006          //                      EA=1;
1007          //              find_key = 0;
1008          //                        delay1s();
1009          //
1010          //
1011          //
1012          //                  }
1013          //
1014          //        }
1015          //        break;
1016          //        case 8:    //PNPè¾“å‡ºé€‰æ‹©
1017          //
1018          //          m_init();
1019          //          m_send(0x01,get_stroke('8'));
1020          //          m_send(0x02,get_stroke('-'));
1021          //          m_send(0x03,get_stroke('-'));
1022          //          m_send(0x04,get_stroke('P'));
1023          //          m_send(0x05,get_stroke('0'));
1024          //          find_key=1;
1025          //
1026          //
1027          //        if  (enter_flag==1)
1028          //        {
1029          //           a=par_buf[36];
1030          //                 up_flag = a;
1031          //                  enter_flag=0;
1032          //
1033          //                 do
1034          //           {
1035          //             PCA0CPH4 = 0xa0;
1036          //                  if (up_flag==0)
1037          //                      {
1038          //                        a=0;
1039          //                      }
1040          //                 else if (up_flag==1)
1041          //                  {
1042          //                    a=1;
1043          //                    }
1044          //
1045          //                      else if (up_flag==2)
1046          //                  {
1047          //                    a=0;up_flag=0;
1048          //                    }
1049          //
1050          //
1051          //                      m_init();
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 18  

1052          //          m_send(0x01,get_stroke(a));
1053          //          m_send(0x02,get_stroke(' '));
1054          //          m_send(0x03,get_stroke(' '));
1055          //          m_send(0x04,get_stroke(' '));
1056          //          m_send(0x05,get_stroke(' '));
1057          //                     }
1058          //          while(enter_flag==0);
1059          //          {
1060          //             par_buf[36]=a;
1061          //
1062          //                     key_flag_init();
1063          //
1064          //             EA=0;
1065          //             erase_par();
1066          //                   write_par();     //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
1067          //              EA=1;
1068          //            find_key = 0;
1069          //                        delay1s();
1070          //
1071          //
1072          //                  }
1073          //
1074          //        }
1075          //        break;
1076          //        case 9:    //RS232/RS485é€‰æ‹©
1077          //
1078          //          m_init();
1079          //          m_send(0x01,get_stroke('9'));
1080          //          m_send(0x02,get_stroke('-'));
1081          //          m_send(0x03,get_stroke('-'));
1082          //          m_send(0x04,get_stroke('C'));
1083          //          m_send(0x05,get_stroke('P'));
1084          //            find_key=1;
1085          //
1086          //        if  (enter_flag==1)
1087          //        {
1088          //           a=par_buf[37];
1089          //                 up_flag = a;
1090          //                  enter_flag=0;
1091          //
1092          //                 do
1093          //           {
1094          //             PCA0CPH4 = 0xa0;
1095          //                  if (up_flag==0)
1096          //                      {
1097          //                        a=0;
1098          //                      }
1099          //                 else if (up_flag==1)
1100          //                  {
1101          //                    a=1;
1102          //                    }
1103          //
1104          //                      else if (up_flag==2)
1105          //                  {
1106          //                    a=0;up_flag=0;
1107          //                    }
1108          //
1109          //
1110          //                      m_init();
1111          //          m_send(0x01,get_stroke(a));
1112          //          m_send(0x02,get_stroke(' '));
1113          //          m_send(0x03,get_stroke(' '));
1114          //          m_send(0x04,get_stroke(' '));
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 19  

1115          //          m_send(0x05,get_stroke(' '));
1116          //                     }
1117          //          while(enter_flag==0);
1118          //          {
1119          //             par_buf[37]=a;
1120          //
1121          //                     key_flag_init();
1122          //
1123          //              EA=0;
1124          //             erase_par();
1125          //                   write_par();     //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
1126          //            EA=1;
1127          //                find_key = 0;
1128          //                        delay1s();
1129          //
1130          //                  }
1131          //
1132          //        }
1133          //        break;
1134          //        case 10:    //ADD
1135          //
1136          //          m_init();
1137          //          m_send(0x01,get_stroke('1'));
1138          //          m_send(0x02,get_stroke('0'));
1139          //          m_send(0x03,get_stroke('-'));
1140          //          m_send(0x04,get_stroke('-'));
1141          //          m_send(0x05,get_stroke('A'));
1142          //
1143          //          find_key=1;
1144          //
1145          //        if  (enter_flag==1)
1146          //        {
1147          //           a=par_buf[20];
1148          //           bx=par_buf[20]/10;
1149          //           c=par_buf[20]%10;
1150          //                  shift_right_flag=1;
1151          //                  up_flag=0;
1152          //                  enter_flag=0;
1153          //          display_add();
1154          //           do
1155          //                      {
1156          //                    PCA0CPH4 = 0xa0;
1157          //                        shift_add();  //æ˜¾ç¤º2ä½
1158          //
1159          //                     }
1160          //                     while  (enter_flag==0);
1161          //                    {
1162          //
1163          //                      key_flag_init();
1164          //
1165          //                   display_add();
1166          //                     a=bx*10+c;
1167          //
1168          //                     if (a<=25)//A-Z(65-90)
1169          //                   {
1170          //                  par_buf[20]=a;
1171          //             EA=0;
1172          //                     erase_par();
1173          //                   write_par();     //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
1174          //                      EA=1;
1175          //                     }
1176          //
1177          //                        find_key = 0;
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 20  

1178          //              delay1s();
1179          //
1180          //
1181          //
1182          //                  }
1183          //
1184          //        }
1185          //        break;
1186          //         case 11:
1187          //
1188          //          m_init();
1189          //          m_send(0x01,get_stroke('1'));
1190          //          m_send(0x02,get_stroke('1'));
1191          //          m_send(0x03,get_stroke('-'));
1192          //          m_send(0x04,get_stroke('U'));
1193          //          m_send(0x05,get_stroke('R'));
1194          //
1195          //         find_key=1;
1196          //
1197          //        if  (enter_flag==1)
1198          //        {
1199          //
1200          //                 enter_flag=0;
1201          //
1202          //                 do
1203          //           {
1204          //                      m_init();
1205          //          m_send(0x01,get_stroke(' '));
1206          //          m_send(0x02,(get_stroke(version_major-0x30)|0x80));  //Display Version Number
1207          //          m_send(0x03,get_stroke(version_minor-0x30));
1208          //          m_send(0x04,get_stroke(' '));
1209          //          m_send(0x05,get_stroke(' '));
1210          //                     }
1211          //          while(enter_flag==0);
1212          //          {
1213          //                     key_flag_init();
1214          //
1215          //            find_key = 0;
1216          //             delay1s();
1217          //
1218          //
1219          //
1220          //
1221          //                  }
1222          //
1223          //        }
1224          //        break;
1225          //
1226          //
1227          //    default: break;
1228          //  }
1229          //}
1230          //
1231          //void display(void)
1232          //{
1233          // m_init();
1234          //m_send(0x01,get_stroke(a));
1235          //m_send(0x02,(get_stroke(bx)|0x80));
1236          //m_send(0x03,get_stroke(c));
1237          //m_send(0x04,get_stroke(d));
1238          //m_send(0x05,get_stroke(e));
1239          //}
1240          //
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 21  

1241          //void display_add(void)
1242          //{
1243          // m_init();
1244          //m_send(0x01,get_stroke(bx));
1245          //m_send(0x02,get_stroke(c));
1246          //m_send(0x03,get_stroke(' '));
1247          //m_send(0x04,get_stroke(' '));
1248          //m_send(0x05,get_stroke(' '));
1249          //}
1250          //void  shift_add(void)
1251          //{
1252          //    if (shift_right_flag==1)      //ç¬¬ä¸€ä½é—ªçƒ
1253          //    {
1254          //
1255          //      up_flag=bx;
1256          //    do
1257          //    { PCA0CPH4 = 0xa0;
1258          //      switch(up_flag)
1259          //      {
1260          //          case 0: bx=0; break;
1261          //        case 1: bx=1; break;
1262          //        case 2: bx=2; break;
1263          //        case 3: bx=3; break;
1264          //        case 4: bx=4; break;
1265          //        case 5: bx=5; break;
1266          //        case 6: bx=6; break;
1267          //        case 7: bx=7; break;
1268          //        case 8: bx=8; break;
1269          //        case 9: bx=9; break;
1270          //        case 10: bx=0; break;
1271          //            }
1272          //      disp_emissivity_2();
1273          //         }
1274          //      while ( (shift_right_flag==1)&&(enter_flag==0) );
1275          //    }
1276          //    else if (shift_right_flag==2)
1277          //    {
1278          //       up_flag=c;
1279          //       do
1280          //     {
1281          //      PCA0CPH4 = 0xa0;
1282          //      switch(up_flag)
1283          //      {
1284          //          case 0: c=0; break;
1285          //        case 1: c=1; break;
1286          //        case 2: c=2; break;
1287          //        case 3: c=3; break;
1288          //        case 4: c=4; break;
1289          //        case 5: c=5; break;
1290          //        case 6: c=6; break;
1291          //        case 7: c=7; break;
1292          //        case 8: c=8; break;
1293          //        case 9: c=9; break;
1294          //        case 10: c=0; break;
1295          //            }
1296          //      disp_emissivity_2();
1297          //         }
1298          //      while ( (shift_right_flag==2)&&(enter_flag==0) );
1299          //   }
1300          //
1301          //   else if (shift_right_flag==3)
1302          //   {
1303          //    shift_right_flag=1;
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 22  

1304          //   }
1305          //}
1306          //void disp_emissivity_2(void)
1307          //{
1308          //   if (shift_right_flag==1)     //ç¬¬ä¸€ä½é—ªçƒæ˜¾ç¤º
1309          //   {
1310          //       disp_emissivity0_2();
1311          //      // delay(100);
1312          //     delay1s();
1313          //
1314          //    m_init();
1315          //    m_send(0x01,get_stroke(' '));
1316          //    m_send(0x02,get_stroke(c));
1317          //    m_send(0x03,get_stroke(' '));
1318          //    m_send(0x04,get_stroke(' '));
1319          //    m_send(0x05,get_stroke(' '));
1320          //    // delay(100);
1321          //     delay1s();
1322          //
1323          //      }
1324          //  else if (shift_right_flag==2)       //ç¬¬äºŒä½é—ªçƒæ˜¾ç¤º
1325          //  {
1326          //       disp_emissivity0_2();
1327          //    // delay(100);
1328          //     delay1s();
1329          //
1330          //    m_init();
1331          //    m_send(0x01,get_stroke(bx));
1332          //    m_send(0x02,get_stroke(' '));
1333          //    m_send(0x03,get_stroke(' '));
1334          //    m_send(0x04,get_stroke(' '));
1335          //    m_send(0x05,get_stroke(' '));
1336          //  //   delay(100);
1337          //    delay1s();
1338          //
1339          //      }
1340          //
1341          //    else if (shift_right_flag==3)
1342          //    {
1343          //             shift_right_flag=1;
1344          //       }
1345          //}
1346          //
1347          //
1348          //void disp_emissivity0_2(void)     //æ­£å¸¸æ˜¾ç¤ºï¼Œä¸é—ª
1349          //{
1350          //    m_init();
1351          //  m_send(0x01,get_stroke(bx));
1352          //  m_send(0x02,get_stroke(c));
1353          //  m_send(0x03,get_stroke(' '));
1354          //  m_send(0x04,get_stroke(' '));
1355          //  m_send(0x05,get_stroke(' '));
1356          //}
1357          //void  shift0_5(void)
1358          //{
1359          //    if (shift_right_flag==1)      //ç¬¬ä¸€ä½é—ªçƒ
1360          //    {
1361          //       up_flag=a;
1362          //       do
1363          //     {
1364          //        PCA0CPH4 = 0xa0;
1365          //      switch(up_flag)
1366          //      {
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 23  

1367          //          case 0: a=0; break;
1368          //        case 1: a=1; break;
1369          //        case 2: a=2; break;
1370          //        case 3: a=3; break;
1371          //        case 4: a=4; break;
1372          //        case 5: a=5; break;
1373          //        case 6: a=6; break;
1374          //        case 7: a=7; break;
1375          //        case 8: a=8; break;
1376          //        case 9: a=9; break;
1377          //        case 10: a=0; break;
1378          //            }
1379          //      disp_emissivity_5();
1380          //      }
1381          //          while ( (shift_right_flag==1)&&(enter_flag==0) );
1382          //    }
1383          //    else if (shift_right_flag==2)     //ç¬¬äºŒä½é—ªçƒ
1384          //    {
1385          //      up_flag=bx;
1386          //    do
1387          //    { PCA0CPH4 = 0xa0;
1388          //      switch(up_flag)
1389          //      {
1390          //          case 0: bx=0; break;
1391          //        case 1: bx=1; break;
1392          //        case 2: bx=2; break;
1393          //        case 3: bx=3; break;
1394          //        case 4: bx=4; break;
1395          //        case 5: bx=5; break;
1396          //        case 6: bx=6; break;
1397          //        case 7: bx=7; break;
1398          //        case 8: bx=8; break;
1399          //        case 9: bx=9; break;
1400          //        case 10: bx=0; break;
1401          //            }
1402          //      disp_emissivity_5();
1403          //         }
1404          //      while ( (shift_right_flag==2)&&(enter_flag==0) );
1405          //    }
1406          //    else if (shift_right_flag==3)
1407          //    {
1408          //       up_flag=c;
1409          //       do
1410          //     {
1411          //      PCA0CPH4 = 0xa0;
1412          //      switch(up_flag)
1413          //      {
1414          //          case 0: c=0; break;
1415          //        case 1: c=1; break;
1416          //        case 2: c=2; break;
1417          //        case 3: c=3; break;
1418          //        case 4: c=4; break;
1419          //        case 5: c=5; break;
1420          //        case 6: c=6; break;
1421          //        case 7: c=7; break;
1422          //        case 8: c=8; break;
1423          //        case 9: c=9; break;
1424          //        case 10: c=0; break;
1425          //            }
1426          //      disp_emissivity_5();
1427          //         }
1428          //      while ( (shift_right_flag==3)&&(enter_flag==0) );
1429          //   }
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 24  

1430          //  else if (shift_right_flag==4)
1431          //  {
1432          //       up_flag=d;
1433          //       do
1434          //     {
1435          //      PCA0CPH4 = 0xa0;
1436          //      switch(up_flag)
1437          //      {
1438          //          case 0: d=0; break;
1439          //        case 1: d=1; break;
1440          //        case 2: d=2; break;
1441          //        case 3: d=3; break;
1442          //        case 4: d=4; break;
1443          //        case 5: d=5; break;
1444          //        case 6: d=6; break;
1445          //        case 7: d=7; break;
1446          //        case 8: d=8; break;
1447          //        case 9: d=9; break;
1448          //        case 10: d=0; break;
1449          //            }
1450          //      disp_emissivity_5();
1451          //         }
1452          //      while ( (shift_right_flag==4)&&(enter_flag==0) );
1453          //   }
1454          //    else if (shift_right_flag==5)
1455          //  {
1456          //       up_flag=e;
1457          //       do
1458          //     {
1459          //        PCA0CPH4 = 0xa0;
1460          //      switch(up_flag)
1461          //      {
1462          //          case 0: e=0; break;
1463          //        case 1: e=1; break;
1464          //        case 2: e=2; break;
1465          //        case 3: e=3; break;
1466          //        case 4: e=4; break;
1467          //        case 5: e=5; break;
1468          //        case 6: e=6; break;
1469          //        case 7: e=7; break;
1470          //        case 8: e=8; break;
1471          //        case 9: e=9; break;
1472          //        case 10: e=0; break;
1473          //            }
1474          //      disp_emissivity_5();
1475          //         }
1476          //      while ( (shift_right_flag==5)&&(enter_flag==0) );
1477          //   }
1478          //   else if (shift_right_flag==6)
1479          //   {
1480          //    shift_right_flag=1;
1481          //   }
1482          //}
1483          //
1484          //
1485          //void disp_emissivity_5(void)
1486          //{
1487          //   if (shift_right_flag==1)     //ç¬¬ä¸€ä½é—ªçƒæ˜¾ç¤º
1488          //   {
1489          //       disp_emissivity0_5();
1490          //      // delay(100);
1491          //     delay1s();
1492          //
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 25  

1493          //    m_init();
1494          //    m_send(0x01,get_stroke(' '));
1495          //    m_send(0x02,(get_stroke(bx)|0x80));
1496          //    m_send(0x03,get_stroke(c));
1497          //    m_send(0x04,get_stroke(d));
1498          //    m_send(0x05,get_stroke(e));
1499          //    // delay(100);
1500          //     delay1s();
1501          //
1502          //      }
1503          //  else if (shift_right_flag==2)       //ç¬¬äºŒä½é—ªçƒæ˜¾ç¤º
1504          //  {
1505          //       disp_emissivity0_5();
1506          //    // delay(100);
1507          //     delay1s();
1508          //
1509          //    m_init();
1510          //    m_send(0x01,get_stroke(a));
1511          //    m_send(0x02,(get_stroke(' ')|0x80));
1512          //    m_send(0x03,get_stroke(c));
1513          //    m_send(0x04,get_stroke(d));
1514          //    m_send(0x05,get_stroke(e));
1515          //  //   delay(100);
1516          //    delay1s();
1517          //
1518          //      }
1519          //    else if (shift_right_flag==3)     //ç¬¬ä¸‰ä½é—ªçƒæ˜¾ç¤º
1520          //    {
1521          //         disp_emissivity0_5();
1522          //     //  delay(100);
1523          //       delay1s();
1524          //       m_init();
1525          //
1526          //    m_send(0x01,get_stroke(a));
1527          //    m_send(0x02,(get_stroke(bx)|0x80));
1528          //    m_send(0x03,get_stroke(' '));
1529          //    m_send(0x04,get_stroke(d));
1530          //    m_send(0x05,get_stroke(e));
1531          //     //  delay(100);
1532          //       delay1s();
1533          //
1534          //  }
1535          //  else if (shift_right_flag==4)     //ç¬¬4ä½é—ªçƒæ˜¾ç¤º
1536          //   {
1537          //         disp_emissivity0_5();
1538          //      // delay(100);
1539          //      delay1s();
1540          //
1541          //       m_init();
1542          //    m_send(0x01,get_stroke(a));
1543          //    m_send(0x02,(get_stroke(bx)|0x80));
1544          //    m_send(0x03,get_stroke(c));
1545          //    m_send(0x04,get_stroke(' '));
1546          //    m_send(0x05,get_stroke(e));
1547          //     //  delay(100);
1548          //       delay1s();
1549          //
1550          //  }
1551          //  else if (shift_right_flag==5)
1552          //  {
1553          //        disp_emissivity0_5();
1554          //    //   delay(100);
1555          //      delay1s();
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 26  

1556          //
1557          //       m_init();
1558          //    m_send(0x01,get_stroke(a));
1559          //    m_send(0x02,(get_stroke(bx)|0x80));
1560          //    m_send(0x03,get_stroke(c));
1561          //    m_send(0x04,get_stroke(d));
1562          //    m_send(0x05,get_stroke(' '));
1563          //     //  delay(100);
1564          //      delay1s();
1565          //
1566          //  }
1567          //    else if (shift_right_flag==6)
1568          //    {
1569          //             shift_right_flag=1;
1570          //       }
1571          //}
1572          //
1573          //
1574          //void disp_emissivity0_5(void)     //æ­£å¸¸æ˜¾ç¤ºï¼Œä¸é—ª
1575          //{
1576          //    m_init();
1577          //  m_send(0x01,get_stroke(a));
1578          //  m_send(0x02,(get_stroke(bx)|0x80));
1579          //  m_send(0x03,get_stroke(c));
1580          //  m_send(0x04,get_stroke(d));
1581          //  m_send(0x05,get_stroke(e));
1582          //}
1583          //
1584          //char data receive0[10]={' ',' ',' ',' ',' ',' ',' ',' ',' ',' '};
1585          //
1586          //bit nors=0;
1587          //bit err_flag=0;
1588          //bit uart0_rcv_ok= 0;
1589          //void uart0(void) interrupt 4
1590          //{
1591          //  uchar  i;
1592          //
1593          //
1594          //  if(RI0==1)
1595          //    {
1596          //    for(i=0;i<10;i++)
1597          //    {
1598          //      while(!RI0)
1599          //      { PCA0CPH4 = 0xa0; }
1600          //
1601          //      receive0[i] = SBUF0;
1602          //      RI0 = 0;
1603          //
1604          //      if(receive0[i]==0x0a)
1605          //      {
1606          //         uart0_rcv_ok =1;
1607          //      //  ES0 = 0;
1608          //        break;
1609          //      }
1610          //        }
1611          // }
1612          //}
1613          //
1614          //void direct_uart0(void)
1615          //{
1616          //    uchar  i, rd1,rd2,rd3,rd4,rd5;
1617          //   if(find_key!=0)return;
1618          //   if(uart0_rcv_ok==0)return;
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 27  

1619          //    uart0_rcv_ok=0;
1620          //
1621          //
1622          //
1623          //    if((receive0[3]=='.')&&(receive0[0]>=0x30)&&(receive0[0]<=0x39)&&(receive0[1]>=0x30)&&(receive0[1]<=
             -0x39)&&(receive0[2]>=0x30)&&(receive0[2]<=0x39)&&(receive0[4]>=0x30)&&(receive0[4]<=0x39)&&(receive0[5]>=0x30)&&(receive
             -0[5]<=0x39)&&(receive0[6]>=0x30)&&(receive0[6]<=0x39) )
1624          //    {
1625          //      err_flag=0;
1626          //
1627          //
1628          //      receive0[0]=receive0[0]-0x30;
1629          //      receive0[1]=receive0[1]-0x30;
1630          //      receive0[2]=receive0[2]-0x30;
1631          //      receive0[4]=receive0[4]-0x30;
1632          //      receive0[5]=receive0[5]-0x30;
1633          //      receive0[6]=receive0[6]-0x30;
1634          //
1635          //
1636          //            rd1 = receive0[1];
1637          //            rd2 = receive0[2];
1638          //            rd3 = receive0[4];
1639          //            rd4 = receive0[5];
1640          //            rd5 = receive0[6];
1641          //
1642          ////            now_val = rd1*10000+rd2*1000+rd3*100+rd4*10+rd5;  // original code-- intermediate values a
             -re not unsigned long int!
1643          //            now_val = rd1;
1644          //            now_val = now_val*10 + rd2;
1645          //            now_val = now_val*10 + rd3;
1646          //            now_val = now_val*10 + rd4;
1647          //            now_val = now_val*10 + rd5;
1648          //
1649          //            rd1 = rd1+0x30;
1650          //            rd2 = rd2+0x30;
1651          //            rd3 = rd3+0x30;
1652          //            rd4 = rd4+0x30;
1653          //            rd5 = rd5+0x30;
1654          //
1655          //             m_init();
1656          //                 m_send(0x01,get_stroke(rd1));
1657          //                 m_send(0x02,(get_stroke(rd2))|0x80);
1658          //                 m_send(0x03,get_stroke(rd3));
1659          //                 m_send(0x04,get_stroke(rd4));
1660          //                 m_send(0x05,get_stroke(rd5));
1661          //
1662          //    }
1663          //
1664          //         else
1665          //      {
1666          //
1667          //          for(i=0;i<10;i++)
1668          //          {
1669          //           receive0_temp[i]=receive0[i];
1670          //         }
1671          //         if(receive0_temp[0]=='+')
1672          //        {
1673          //
1674          //        m_init();
1675          //        m_send(0x01,get_stroke(receive0_temp[1]));
1676          //        m_send(0x02,get_stroke(receive0_temp[2]));
1677          //        m_send(0x03,0x63);
1678          //        m_send(0x04,0x00);
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 28  

1679          //        m_send(0x05,0x00);
1680          //
1681          //
1682          //        }
1683          //      else if(receive0_temp[0]=='E')
1684          //      {
1685          //         err_flag=1;
1686          //        m_init();
1687          //        m_send(0x01,get_stroke(receive0_temp[0]));
1688          //        m_send(0x02,get_stroke(receive0_temp[1]));
1689          //        m_send(0x03,get_stroke(receive0_temp[2]));
1690          //        m_send(0x04,get_stroke(receive0_temp[3]));
1691          //        m_send(0x05,get_stroke(receive0_temp[4]));
1692          //         }
1693          //         }
1694          //
1695          //
1696          //
1697          //    alarm_state();
1698          //
1699          //
1700          //}
1701          //
1702          //
1703          //
1704          //
1705          //void alarm_state(void)
1706          //
1707          //{
1708          //
1709          //  ulint idata alarm_over_vhh,alarm_over_vll;
1710          //  ulint idata alarm_low_vhh,alarm_low_vll;
1711          //  ulint idata upper_val,lower_val;
1712          //
1713          //  UP=(par_buf[10]*1000+par_buf[11]*100+par_buf[12]*10+par_buf[13])*10+par_buf[14];
1714          //  LO=(par_buf[15]*1000+par_buf[16]*100+par_buf[17]*10+par_buf[18])*10+par_buf[19];
1715          //  AH = (par_buf[21]*1000+par_buf[22]*100+par_buf[23]*10+par_buf[24])*10+par_buf[25];
1716          //
1717          //  CTR = par_buf[34];
1718          //
1719          //
1720          //
1721          ////ç»§ç”µå™¨ä½œä¸ºå‡ºé”™æ—¶æŠ¥è­¦
1722          //   if(par_buf[35]==1)
1723          //      {
1724          //      if(err_flag==1)
1725          //        {
1726          //
1727          //       ALARM  = 0;
1728          //       delay1s();
1729          //       ALARM  = 1;
1730          //         delay1s();
1731          //         OUT0=1;
1732          //       }
1733          //     else
1734          //     {
1735          //       OUT0=0;
1736          //         }
1737          //    }
1738          //
1739          //
1740          ////ç»§ç”µå™¨ä½œä¸ºè·ç¦»æŠ¥è­¦
1741          // else if(par_buf[35]==0)
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 29  

1742          //  {
1743          //  if(err_flag==1)
1744          //        {
1745          //
1746          //       ALARM  = 0;
1747          //       delay1s();
1748          //       ALARM  = 1;
1749          //         delay1s();
1750          //        OUT0 =1;
1751          //       }
1752          //   else if (err_flag==0)
1753          //   {
1754          //    if(CTR ==1)
1755          //   {
1756          //     upper_val = LO+(AH/2);
1757          //     lower_val = LO-(AH/2);
1758          //
1759          //   if(now_val>=upper_val)
1760          //   {
1761          //    OUT0 = 1;
1762          //   // OUT1 = 1;
1763          //   ALARM  = 1;
1764          //   }
1765          //
1766          //   else if(now_val<=lower_val)
1767          //    {
1768          //      OUT0 = 0;
1769          //    //  OUT1 = 0;
1770          //      ALARM = 0;
1771          //  //   OUT3=!OUT3;
1772          //    }
1773          //
1774          //  }
1775          //
1776          //
1777          //  else if(CTR ==2)
1778          //  {
1779          //  alarm_over_vhh = UP+AH/2;
1780          //  alarm_over_vll = UP-AH/2;
1781          //  alarm_low_vhh  = LO+AH/2;
1782          //  alarm_low_vll  = LO-AH/2;
1783          //
1784          //     if((now_val>=alarm_low_vhh)&&(now_val<=alarm_over_vll))
1785          //     {
1786          //      ALARM = 0;
1787          //    OUT0 = 0;
1788          //   // OUT1 = 0;
1789          //    }
1790          //     else if((now_val<alarm_low_vll)||(now_val>alarm_over_vhh))
1791          //     {
1792          //      ALARM = 1;
1793          //    OUT0 = 1;
1794          //  //  OUT1 = 1;
1795          //    }
1796          //
1797          //  }
1798          //else if (CTR ==3)
1799          //{
1800          //   upper_val = UP+(AH/2);
1801          //   lower_val = UP-(AH/2);
1802          //
1803          //
1804          //   if(now_val>=upper_val)
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 30  

1805          //   {
1806          //    OUT0 = 0;
1807          //   // OUT1 = 0;
1808          //   ALARM  = 0;
1809          //   }
1810          //
1811          //   else if(now_val<=lower_val)
1812          //    {
1813          //      OUT0 = 1;
1814          //    //  OUT1 = 1;
1815          //      ALARM = 1;
1816          //
1817          //    }
1818          //  }
1819          //  }
1820          //}
1821          //
1822          // //PNPä½œä¸ºå‡ºé”™æ—¶æŠ¥è­¦
1823          // if(par_buf[36]==1)
1824          //  {
1825          //
1826          //   if(err_flag==1)
1827          //        {
1828          //
1829          //       ALARM  = 0;
1830          //       delay1s();
1831          //       ALARM  = 1;
1832          //         delay1s();
1833          //         OUT1=0;
1834          //       }
1835          //     else
1836          //     {
1837          //       OUT1=1;
1838          //         }
1839          //    }
1840          //
1841          //
1842          //
1843          ////PNPä½œä¸ºè·ç¦»æŠ¥è­¦
1844          //else if(par_buf[36]==0)
1845          //{
1846          // if(err_flag==1)
1847          //        {
1848          //
1849          //       ALARM  = 0;
1850          //       delay1s();
1851          //       ALARM  = 1;
1852          //         delay1s();
1853          //          OUT1 =0;
1854          //       }
1855          //
1856          // else if (err_flag==0)
1857          // {
1858          //  if(CTR ==1)
1859          // {
1860          //   upper_val = LO+(AH/2);
1861          //   lower_val = LO-(AH/2);
1862          //
1863          //   if(now_val>=upper_val)
1864          //   {
1865          //    //OUT0 = 1;
1866          //    OUT1 = 0;
1867          //   ALARM  = 1;
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 31  

1868          //   }
1869          //
1870          //   else if(now_val<=lower_val)
1871          //    {
1872          //    //  OUT0 = 0;
1873          //      OUT1 = 1;
1874          //      ALARM = 0;
1875          //
1876          //    }
1877          //
1878          //  }
1879          //
1880          //
1881          //else if(CTR ==2)
1882          //{
1883          //  alarm_over_vhh = UP+AH/2;
1884          //  alarm_over_vll = UP-AH/2;
1885          //  alarm_low_vhh  = LO+AH/2;
1886          //  alarm_low_vll  = LO-AH/2;
1887          //
1888          //     if((now_val>=alarm_low_vhh)&&(now_val<=alarm_over_vll))
1889          //     {
1890          //      ALARM = 0;
1891          //   // OUT0 = 0;
1892          //    OUT1 = 1;
1893          //    }
1894          //     else if((now_val<alarm_low_vll)||(now_val>alarm_over_vhh))
1895          //     {
1896          //      ALARM = 1;
1897          //   // OUT0 = 1;
1898          //    OUT1 = 0;
1899          //    }
1900          //
1901          //  }
1902          //else if (CTR ==3)
1903          //{
1904          //   upper_val = UP+(AH/2);
1905          //   lower_val = UP-(AH/2);
1906          //
1907          //
1908          //   if(now_val>=upper_val)
1909          //   {
1910          //    //OUT0 = 0;
1911          //    OUT1 = 1;
1912          //   ALARM  = 0;
1913          //   }
1914          //
1915          //   else if(now_val<=lower_val)
1916          //    {
1917          //    //  OUT0 = 1;
1918          //      OUT1 = 0;
1919          //      ALARM = 1;
1920          //
1921          //    }
1922          //  }
1923          //  }
1924          // }
1925          //}
1926          //
1927          //
1928          //
1929          //void uart1(void) interrupt 16                          //ä¸­æ–­å‡½æ•° ä¸­æ–­å‘é‡å·
1930          //{
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 32  

1931          //  uchar data i;
1932          //
1933          //  if((SCON1 & 0x01)==1)
1934          //  {
1935          //      tl0timer0=0;//å®šæ—¶å™¨0ç´¯åŠ æ¸…0
1936          //      SCON1 &= ~0x10;//REN1=0;RI1=0;å…³æ¥æ”¶
1937          //
1938          //    i=SBUF1;//è¯»æ•°æ®
1939          //
1940          //    if(uart1_receve_end==0)//ä¸Šæ¬¡çš„æ•°æ®è¿˜æ²¡æœ‰å¤„ç†ï¼Œä¸å†æ¥æ”¶
1941          //    {
1942          //      if(i=='#')
1943          //      {
1944          //        b_head_sure=1;//æ•°æ®å¸§æ­£ç¡®
1945          //        rcv_count=1;//é‡æ–°è®¡æ•°
1946          //        receive1[0]=i;//ä¿å­˜æ•°æ®
1947          //      }
1948          //      else if(b_head_sure==1)
1949          //      {
1950          //        if(rcv_count<12)//åªæ¥æ”¶12ä¸ªå­—èŠ‚
1951          //        {
1952          //
1953          //          receive1[rcv_count]=i;//ä¿å­˜æ•°æ®
1954          //
1955          //          rcv_count++;
1956          //          if(rcv_count==12)
1957          //          {uart1_receve_end=1;
1958          //          b_head_sure=0;}//æ¥æ”¶å®Œæˆ
1959          //        }
1960          //      }
1961          //    }
1962          //   SCON1 |= 0x10;//å¼€å¯æ¥æ”¶REN1=1
1963          //   SCON1 &= ~0x01;//æ¸…é›¶RI1
1964          //
1965          //  }
1966          //
1967          //    if((SCON1&0x02)==0x02)//å‘é€æ•°æ®
1968          //  {
1969          //
1970          //    if(txcount0!=0)//è¿˜æœ‰æ•°æ®éœ€è¦å‘é€
1971          //    {
1972          //      SBUF1=send_buf[txptr0];//è£…æ•°æ®
1973          //      txptr0++;//æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ªåœ°å€
1974          //      txcount0--;//å·²å‘é€æ•°æ®æ•°é‡+1
1975          //    }
1976          //      else//å·²ç»å‘é€å®Œçš„å¤„ç†
1977          //    {
1978          //      if(par_buf[37]==1)
1979          //       {
1980          //      RXEN=1;//å¼€å¯485æ¥æ”¶
1981          //            DXEN=0;//
1982          //      }
1983          //    tl0timer0=0;//å®šæ—¶å™¨0ç´¯åŠ æ¸…0
1984          //    }
1985          //    SCON1 &= ~0x02;//æ¸…é›¶TI1;
1986          //  }
1987          //}
1988          //void direct_uart1()
1989          //{
1990          //  uchar i;
1991          //  uchar data ADD;
1992          //  // uchar check_sum = 0;
1993          //   bit  check_ok  = 0;
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 33  

1994          //   uchar order_val1 = 0;
1995          //   uchar order_val2 = 0;
1996          //
1997          //    if(tl0timer0<5)return;
1998          //  if(find_key!=0)return;
1999          //  if(uart1_receve_end==0)return;
2000          //     uart1_receve_end = 0;
2001          ////check_sum=receive1[1]^receive1[2]^receive1[3]^receive1[4]^receive1[5]^receive1[6]^receive1[7]^receive1
             -[8]^receive1[9];
2002          //    ADD = par_buf[20]+0x41;
2003          //   if((receive1[11]==0x0a)&&(receive1[1]==ADD))
2004          //   {
2005          //     check_ok=1;
2006          //
2007          //   }
2008          //   else
2009          //   {
2010          //      check_ok=0;
2011          //  }
2012          //
2013          //
2014          // if(check_ok==1)
2015          //   {
2016          //      order_val1=receive1[2];
2017          //      order_val2=receive1[3];
2018          //
2019          //      if (( order_val1=='D')&&(order_val2=='T'))
2020          //    {
2021          //
2022          //       send_enable = 1;
2023          //           if(par_buf[37]==1)
2024          //       {
2025          //      send_dt();
2026          //         }
2027          //
2028          //    }
2029          //    else if ((order_val1=='R')&&(order_val2=='B'))
2030          //    {
2031          //
2032          //          send_enable = 0;
2033          //      rb1();
2034          //      send_rb();
2035          //
2036          //    }
2037          //    else if ((order_val1=='R')&&(order_val2=='E'))
2038          //    {
2039          //
2040          //        send_enable = 0;
2041          //      re1();
2042          //        send_re();
2043          //
2044          //    }
2045          //    else if ((order_val1=='O')&&(order_val2=='P'))
2046          //    {
2047          //
2048          //      send_enable = 0;
2049          //      opt();
2050          //      send_opt();
2051          //
2052          //
2053          //
2054          //    }
2055          //    else if ((order_val1=='D')&&(order_val2=='L'))
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 34  

2056          //    {
2057          //
2058          //      send_enable = 0;
2059          //      dl1();
2060          //      send_dl();
2061          //
2062          //
2063          //
2064          //    }
2065          //    else if ((order_val1=='D')&&(order_val2=='H'))
2066          //    {
2067          //
2068          //      send_enable = 0;
2069          //      dh1();
2070          //      send_dh();
2071          //    }
2072          //
2073          //    else if ((order_val1=='A')&&(order_val2=='H'))
2074          //    {
2075          //
2076          //      send_enable = 0;
2077          //      ah1();
2078          //      send_ah();
2079          //
2080          //    }
2081          //       else if ((order_val1=='R')&&(order_val2=='L'))
2082          //    {
2083          //
2084          //      send_enable = 0;
2085          //      rl();
2086          //      send_rl();
2087          //
2088          //    }
2089          //    else if ((order_val1=='P')&&(order_val2=='O'))
2090          //    {
2091          //
2092          //      send_enable = 0;
2093          //      po();
2094          //      send_po();
2095          //
2096          //    }
2097          //    else if ((order_val1=='P')&&(order_val2=='A'))  //æ˜¾ç¤ºå‚æ•°
2098          //    {
2099          //
2100          //      send_enable = 0;
2101          //
2102          //      pa();
2103          //
2104          //
2105          //    }
2106          //      else if ((order_val1=='P')&&(order_val2=='R'))  //å¤ä½å‚æ•°
2107          //    {
2108          //
2109          //          send_enable = 0;
2110          //
2111          //            EA=0;
2112          //          erase_par();
2113          //           init_par();
2114          //       EA =1;
2115          //
2116          //    }
2117          //         for(i=0;i<10;i++)
2118          //   {
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 35  

2119          //     receive1[i]=' ';
2120          //
2121          //      }
2122          //
2123          //  }
2124          //}
2125          //void pa(void)                                  //æ˜¾ç¤ºå‚æ•°
2126          //{
2127          //
2128          //      send_rb();
2129          //          delay1s();
2130          //      send_re();
2131          //          delay1s();
2132          //      send_opt();
2133          //          delay1s();
2134          //      send_dl();
2135          //          delay1s();
2136          //      send_dh();
2137          //          delay1s();
2138          //      send_ah();
2139          //          delay1s();
2140          //      send_rl();
2141          //          delay1s();
2142          //      send_po();
2143          //          delay1s();
2144          //      send_ver();
2145          //
2146          //}
2147          //
2148          //void send_crc_buf(void)//å‘å›ºå®šçš„12å­—èŠ‚çš„æ•°æ®
2149          //{
2150          //  send_buf[0]='#';                      // åœ¨send_bufæ•°ç»„çš„ç¬¬ä¸€ä¸ªä½ç½®æ”¾å…¥å­—ç¬¦ '#'
2151          //    send_buf[1]=par_buf[20]+0x41;       // æ ¹æ®par_bufæ•°ç»„ä¸­çš„æŸä¸ªå…ƒç´ ï¼Œè®¡ç®—å‡ºè¦å‘é€çš„
             -ç¬¬äºŒä¸ªå­—èŠ‚
2152          //  send_buf[10]=0x0d;                    // è®¾ç½®æ•°æ®åŒ…çš„å€’æ•°ç¬¬äºŒä¸ªå­—èŠ‚ä¸º 0x0dï¼ˆå›è½¦ç¬¦ï¼
             -‰
2153          //    //send_buf[10]=send_buf[1]^send_buf[2]^send_buf[3]^send_buf[4]^send_buf[5]^send_buf[6]^send_buf[7]^s
             -end_buf[8]^send_buf[9];
2154          //  send_buf[11]=0x0a;                    // è®¾ç½®æ•°æ®åŒ…çš„æœ€åä¸€ä¸ªå­—èŠ‚ä¸º 0x0aï¼ˆæ¢è¡Œç¬¦ï¼‰
2155          //   if(par_buf[37]==0x01)                // å¦‚æœpar_bufæ•°ç»„ä¸­çš„ç¬¬37ä¸ªå…ƒç´ ç­‰äº 0x01
2156          //  {
2157          //    DXEN = 1;                           // å°† DXEN ç½® 1ï¼Œå‘é€ä½¿èƒ½æ ‡å¿—ä½
2158          //    RXEN = 0;                           // å°† RXEN ç½® 0ï¼Œæ¥æ”¶ä½¿èƒ½æ ‡å¿—ä½
2159          //   }
2160          //
2161          //  txcount0=11;
2162          //  txptr0=1;//ä»ç¬¬1ä¸ªå­—èŠ‚å¼€å§‹å‘é€     //æ­¤å¤„æ˜¯å¦éœ€è¦ä¿®æ”¹ï¼Œæ•°æ®ä¸å¯¹ï¼Œå†åšä¿®æ”¹
2163          //  SBUF1=send_buf[0];//å‘æ•°æ®
2164          //}
2165          //
2166          //
2167          // void send_dt(void)
2168          //{
2169          //  uchar idata  rd1,rd2,rd3,rd4,rd5;
2170          //
2171          //  ulint data now_val_temp;
2172          //
2173          //  if(find_key!=0) return;
2174          //
2175          //    now_val_temp = now_val;
2176          //
2177          //  rd1 = now_val_temp/10000;
2178          //  rd2 = (now_val_temp%10000)/1000;
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 36  

2179          //  rd3 = (now_val_temp%1000)/100;
2180          //  rd4 = (now_val_temp%100)/10;
2181          //  rd5 = now_val_temp%10;
2182          //
2183          //    rd1 = rd1+0x30;
2184          //    rd2 = rd2+0x30;
2185          //    rd3 = rd3+0x30;
2186          //    rd4 = rd4+0x30;
2187          //    rd5 = rd5+0x30;
2188          //
2189          //
2190          //if(send_enable==1)
2191          //{
2192          //
2193          //      send_buf[2]= 'D';
2194          //      send_buf[3]= 'T';
2195          //   if(err_flag==0)
2196          //   {
2197          //
2198          //      send_buf[4]=rd1;
2199          //      send_buf[5]=rd2;
2200          //      send_buf[6]='.';
2201          //      send_buf[7]= rd3;
2202          //      send_buf[8]=rd4;
2203          //      send_buf[9]=rd5;
2204          //  }
2205          //  else if(err_flag==1)
2206          //    {
2207          //      send_buf[4]=receive0_temp[0];
2208          //      send_buf[5]= receive0_temp[1];
2209          //      send_buf[6]=receive0_temp[2];
2210          //      send_buf[7]=' ';
2211          //      send_buf[8]=' ';
2212          //      send_buf[9]=' ';
2213          //
2214          //
2215          //    }
2216          //  send_crc_buf();
2217          //
2218          //
2219          //
2220          //
2221          //  }
2222          //
2223          //
2224          //
2225          //}
2226          //
2227          // void send_dt1(void)
2228          //{
2229          //  uchar idata  rd1,rd2,rd3,rd4,rd5;
2230          //
2231          //  ulint data now_val_temp;
2232          //    if(tl0timer0<5)return;//æ­¤å€¼ä¸º5æ¯”è¾ƒå¥½ï¼Œå¤ªå°äº†ï¼Œå‘é€å€¼å¤ªå¿«ï¼Œä¼šå½±å“UART0çš„æ¥æ”¶ã
             -€‚
2233          //  if(find_key!=0) return;
2234          //
2235          //    now_val_temp = now_val;
2236          //
2237          //  rd1 = now_val_temp/10000;
2238          //  rd2 = (now_val_temp%10000)/1000;
2239          //  rd3 = (now_val_temp%1000)/100;
2240          //  rd4 = (now_val_temp%100)/10;
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 37  

2241          //  rd5 = now_val_temp%10;
2242          //
2243          //    rd1 = rd1+0x30;
2244          //    rd2 = rd2+0x30;
2245          //    rd3 = rd3+0x30;
2246          //    rd4 = rd4+0x30;
2247          //    rd5 = rd5+0x30;
2248          //
2249          //
2250          //if(send_enable==1)
2251          //{
2252          //
2253          //
2254          //   if(err_flag==0)
2255          //   {
2256          //
2257          //      send_buf[0]=rd1;
2258          //      send_buf[1]=rd2;
2259          //      send_buf[2]='.';
2260          //      send_buf[3]= rd3;
2261          //      send_buf[4]=rd4;
2262          //      send_buf[5]=rd5;
2263          //  }
2264          //  else if(err_flag==1)
2265          //    {
2266          //      send_buf[0]=receive0_temp[0];
2267          //      send_buf[1]= receive0_temp[1];
2268          //      send_buf[2]=receive0_temp[2];
2269          //      send_buf[3]=' ';
2270          //      send_buf[4]=' ';
2271          //      send_buf[5]=' ';
2272          //
2273          //
2274          //    }
2275          //    send_buf[6]=0x0d;
2276          //    send_buf[7]=0x0a;
2277          //  txcount0=7;
2278          //  txptr0=1;//ä»ç¬¬1ä¸ªå­—èŠ‚å¼€å§‹å‘é€
2279          //  SBUF1=send_buf[0];//å‘æ•°æ®
2280          //  delay1s();
2281          //
2282          //
2283          //
2284          //  }
2285          //
2286          //
2287          //
2288          //}
2289          //void rb1(void)
2290          //{
2291          //
2292          //
2293          //        if((receive1[6]=='.')&&(receive1[4]>=0x30)&&(receive1[4]<=0x39)&&(receive1[5]>=0x30)&&(receive1[
             -5]<=0x39)&&(receive1[7]>=0x30)&&(receive1[7]<=0x39)&&(receive1[8]>=0x30)&&(receive1[8]<=0x39)&&(receive1[9]>=0x30)&&(rec
             -eive1[9]<=0x39))
2294          //      {
2295          //      receive1[4]=receive1[4]-0x30;
2296          //      receive1[5]=receive1[5]-0x30;
2297          //      receive1[7]=receive1[7]-0x30;
2298          //      receive1[8]=receive1[8]-0x30;
2299          //      receive1[9]=receive1[9]-0x30;
2300          //
2301          //      par_buf[0]=receive1[4];
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 38  

2302          //      par_buf[1]=receive1[5];
2303          //      par_buf[2]=receive1[7];
2304          //      par_buf[3]=receive1[8];
2305          //      par_buf[4]=receive1[9];
2306          //
2307          //
2308          //
2309          //        EA=0;
2310          //
2311          //        erase_par();
2312          //        write_par();  //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
2313          //         EA =1;
2314          //
2315          //          send_rb0();
2316          //        }
2317          //
2318          //
2319          //}
2320          //
2321          //void send_rb(void)
2322          //{
2323          //      send_buf[2]= 'R';
2324          //      send_buf[3]= 'B';
2325          //      send_buf[4]=par_buf[0]+0x30;
2326          //      send_buf[5]=par_buf[1]+0x30;
2327          //      send_buf[6]='.';
2328          //      send_buf[7]=par_buf[2]+0x30;
2329          //      send_buf[8]=par_buf[3]+0x30;
2330          //      send_buf[9]=par_buf[4]+0x30;
2331          //
2332          //      send_crc_buf();
2333          //
2334          //}
2335          //void send_rb0()
2336          //{
2337          //  // SCON0 = 0x00;
2338          //  ES0=0;
2339          //   PCA0CPH4 = 0xa0;
2340          //  SBUF0 = 'R';  while(!TI0);TI0 = 0;
2341          //SBUF0 = 'B';  while(!TI0);TI0 = 0;
2342          //SBUF0 = par_buf[0]+0x30;while(!TI0);TI0 = 0;
2343          //SBUF0 = par_buf[1]+0x30;while(!TI0);TI0 = 0;
2344          //SBUF0 = '.';            while(!TI0);TI0 = 0;
2345          //SBUF0 = par_buf[2]+0x30;while(!TI0);TI0 = 0;
2346          //SBUF0 = par_buf[3]+0x30;while(!TI0);TI0 = 0;
2347          //SBUF0 = par_buf[4]+0x30;while(!TI0);TI0 = 0;
2348          //SBUF0 = 0x0d;           while(!TI0);TI0 = 0;
2349          //SBUF0 = 0x0a;           while(!TI0);TI0 = 0;
2350          //delay1s();
2351          //delay1s();
2352          //SBUF0 = 'D';while(!TI0);TI0 = 0;
2353          //SBUF0 = 'T';while(!TI0);TI0 = 0;
2354          //SBUF0 = 0x0d;           while(!TI0);TI0 = 0;
2355          //SBUF0 = 0x0a;           while(!TI0);TI0 = 0;
2356          //
2357          //delay1s();
2358          //delay1s();
2359          //
2360          //  // SCON0 = 0x10;
2361          //   ES0=1;
2362          //}
2363          //void send_rb3()                         //æ¨¡æ‹Ÿé‡3èµ·å§‹å€¼
2364          //{
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 39  

2365          //  // SCON0 = 0x00;
2366          //  ES0=0;
2367          //   PCA0CPH4 = 0xa0;
2368          //  SBUF0 = 'R';  while(!TI0);TI0 = 0;
2369          //SBUF0 = 'B';  while(!TI0);TI0 = 0;
2370          //SBUF0 = par_buf[0]+0x30;while(!TI0);TI0 = 0;
2371          //SBUF0 = par_buf[1]+0x30;while(!TI0);TI0 = 0;
2372          //SBUF0 = '.';            while(!TI0);TI0 = 0;
2373          //SBUF0 = par_buf[2]+0x30;while(!TI0);TI0 = 0;
2374          //SBUF0 = par_buf[3]+0x30;while(!TI0);TI0 = 0;
2375          //SBUF0 = par_buf[4]+0x30;while(!TI0);TI0 = 0;
2376          //SBUF0 = 0x0d;           while(!TI0);TI0 = 0;
2377          //SBUF0 = 0x0a;           while(!TI0);TI0 = 0;
2378          //delay1s();
2379          //delay1s();
2380          //
2381          //   ES0=1;
2382          //}
2383          //void re1(void)                           //æ¨¡æ‹Ÿé‡1çš„ç»ˆç‚¹å€¼
2384          //{
2385          //
2386          //
2387          //
2388          //        if((receive1[6]=='.')&&(receive1[4]>=0x30)&&(receive1[4]<=0x39)&&(receive1[5]>=0x30)&&(receive1[
             -5]<=0x39)&&(receive1[7]>=0x30)&&(receive1[7]<=0x39)&&(receive1[8]>=0x30)&&(receive1[8]<=0x39)&&(receive1[9]>=0x30)&&(rec
             -eive1[9]<=0x39))
2389          //      {
2390          //      receive1[4]=receive1[4]-0x30;
2391          //      receive1[5]=receive1[5]-0x30;
2392          //      receive1[7]=receive1[7]-0x30;
2393          //      receive1[8]=receive1[8]-0x30;
2394          //      receive1[9]=receive1[9]-0x30;
2395          //
2396          //      par_buf[5]=receive1[4];
2397          //      par_buf[6]=receive1[5];
2398          //      par_buf[7]=receive1[7];
2399          //      par_buf[8]=receive1[8];
2400          //      par_buf[9]=receive1[9];
2401          //
2402          //
2403          //
2404          //
2405          //
2406          //
2407          //        EA=0;
2408          //
2409          //        erase_par();
2410          //        write_par();  //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
2411          //          EA =1;
2412          //          send_re0();
2413          //      }
2414          //
2415          //
2416          //}
2417          //void send_re(void)
2418          //{
2419          //
2420          //
2421          //      send_buf[2]= 'R';
2422          //      send_buf[3]= 'E';
2423          //      send_buf[4]=par_buf[5]+0x30;
2424          //      send_buf[5]=par_buf[6]+0x30;
2425          //      send_buf[6]='.';
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 40  

2426          //      send_buf[7]=par_buf[7]+0x30;
2427          //      send_buf[8]=par_buf[8]+0x30;
2428          //      send_buf[9]=par_buf[9]+0x30;
2429          //
2430          //      send_crc_buf();
2431          //
2432          //}
2433          //void send_re0()
2434          //{
2435          //  // SCON0 = 0x00;
2436          //   ES0=0;
2437          //   PCA0CPH4 = 0xa0;
2438          //SBUF0 = 'R';           while(!TI0);TI0 = 0;
2439          //SBUF0 = 'E';             while(!TI0);TI0 = 0;
2440          //SBUF0 = par_buf[5]+0x30; while(!TI0);TI0 = 0;
2441          //SBUF0 = par_buf[6]+0x30; while(!TI0);TI0 = 0;
2442          //SBUF0 = '.';             while(!TI0);TI0 = 0;
2443          //SBUF0 = par_buf[7]+0x30; while(!TI0);TI0 = 0;
2444          //SBUF0 = par_buf[8]+0x30; while(!TI0);TI0 = 0;
2445          //SBUF0 = par_buf[9]+0x30; while(!TI0);TI0 = 0;
2446          //SBUF0 = 0x0d;            while(!TI0);TI0 = 0;
2447          //SBUF0 = 0x0a;            while(!TI0);TI0 = 0;
2448          //delay1s();
2449          //delay1s();
2450          //SBUF0 = 'D';while(!TI0);TI0 = 0;
2451          //SBUF0 = 'T';while(!TI0);TI0 = 0;
2452          //SBUF0 = 0x0d;           while(!TI0);TI0 = 0;
2453          //SBUF0 = 0x0a;           while(!TI0);TI0 = 0;
2454          //delay1s();
2455          //delay1s();
2456          //// SCON0 = 0x10;
2457          // ES0=1;
2458          //}
2459          //void send_re3()
2460          //{
2461          //  // SCON0 = 0x00;
2462          //   ES0=0;
2463          //   PCA0CPH4 = 0xa0;
2464          //SBUF0 = 'R';           while(!TI0);TI0 = 0;
2465          //SBUF0 = 'E';             while(!TI0);TI0 = 0;
2466          //SBUF0 = par_buf[5]+0x30; while(!TI0);TI0 = 0;
2467          //SBUF0 = par_buf[6]+0x30; while(!TI0);TI0 = 0;
2468          //SBUF0 = '.';             while(!TI0);TI0 = 0;
2469          //SBUF0 = par_buf[7]+0x30; while(!TI0);TI0 = 0;
2470          //SBUF0 = par_buf[8]+0x30; while(!TI0);TI0 = 0;
2471          //SBUF0 = par_buf[9]+0x30; while(!TI0);TI0 = 0;
2472          //SBUF0 = 0x0d;            while(!TI0);TI0 = 0;
2473          //SBUF0 = 0x0a;            while(!TI0);TI0 = 0;
2474          //delay1s();
2475          //delay1s();
2476          //
2477          // ES0=1;
2478          //}
2479          //
2480          //void dl1(void)
2481          //{
2482          //
2483          //
2484          //
2485          //        if((receive1[6]=='.')&&(receive1[4]>=0x30)&&(receive1[4]<=0x39)&&(receive1[5]>=0x30)&&(receive1[
             -5]<=0x39)&&(receive1[7]>=0x30)&&(receive1[7]<=0x39)&&(receive1[8]>=0x30)&&(receive1[8]<=0x39)&&(receive1[9]>=0x30)&&(rec
             -eive1[9]<=0x39))
2486          //      {
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 41  

2487          //      receive1[4]=receive1[4]-0x30;
2488          //      receive1[5]=receive1[5]-0x30;
2489          //      receive1[7]=receive1[7]-0x30;
2490          //      receive1[8]=receive1[8]-0x30;
2491          //      receive1[9]=receive1[9]-0x30;
2492          //
2493          //      par_buf[15]=receive1[4];
2494          //      par_buf[16]=receive1[5];
2495          //      par_buf[17]=receive1[7];
2496          //      par_buf[18]=receive1[8];
2497          //      par_buf[19]=receive1[9];
2498          //
2499          //
2500          //
2501          //
2502          //        EA=0;
2503          //
2504          //        erase_par();
2505          //        write_par();  //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
2506          //          EA=1;
2507          //
2508          //  }
2509          //
2510          //}
2511          //
2512          //void send_dl(void)                                    //æŠ¥è­¦ç‚¹1å€¼
2513          //{
2514          //
2515          //      send_buf[2]= 'D';
2516          //      send_buf[3]= 'L';
2517          //      send_buf[4]=par_buf[15]+0x30;
2518          //      send_buf[5]=par_buf[16]+0x30;
2519          //      send_buf[6]='.';
2520          //      send_buf[7]=par_buf[17]+0x30;
2521          //      send_buf[8]=par_buf[18]+0x30;
2522          //      send_buf[9]=par_buf[19]+0x30;
2523          //
2524          //        send_crc_buf();
2525          //
2526          //}
2527          //void dh1(void)
2528          //{
2529          //
2530          //
2531          //
2532          //        if((receive1[6]=='.')&&(receive1[4]>=0x30)&&(receive1[4]<=0x39)&&(receive1[5]>=0x30)&&(receive1[
             -5]<=0x39)&&(receive1[7]>=0x30)&&(receive1[7]<=0x39)&&(receive1[8]>=0x30)&&(receive1[8]<=0x39)&&(receive1[9]>=0x30)&&(rec
             -eive1[9]<=0x39))
2533          //      {
2534          //      receive1[4]=receive1[4]-0x30;
2535          //      receive1[5]=receive1[5]-0x30;
2536          //      receive1[7]=receive1[7]-0x30;
2537          //      receive1[8]=receive1[8]-0x30;
2538          //      receive1[9]=receive1[9]-0x30;
2539          //
2540          //      par_buf[10]=receive1[4];
2541          //      par_buf[11]=receive1[5];
2542          //      par_buf[12]=receive1[7];
2543          //      par_buf[13]=receive1[8];
2544          //      par_buf[14]=receive1[9];
2545          //        EA=0;
2546          //
2547          //        erase_par();
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 42  

2548          //        write_par();  //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
2549          //          EA=1;
2550          //      }
2551          //
2552          //
2553          //
2554          //
2555          //}
2556          //void send_dh(void)                                   //æŠ¥è­¦ç‚¹2å€¼
2557          //{
2558          //
2559          //      send_buf[2]= 'D';
2560          //      send_buf[3]= 'H';
2561          //      send_buf[4]=par_buf[10]+0x30;
2562          //      send_buf[5]=par_buf[11]+0x30;
2563          //      send_buf[6]='.';
2564          //      send_buf[7]=par_buf[12]+0x30;
2565          //      send_buf[8]=par_buf[13]+0x30;
2566          //      send_buf[9]=par_buf[14]+0x30;
2567          //        send_crc_buf();
2568          //
2569          //}
2570          //
2571          //void ah1(void)
2572          //{
2573          //
2574          //
2575          //
2576          //        if((receive1[6]=='.')&&(receive1[4]>=0x30)&&(receive1[4]<=0x39)&&(receive1[5]>=0x30)&&(receive1[
             -5]<=0x39)&&(receive1[7]>=0x30)&&(receive1[7]<=0x39)&&(receive1[8]>=0x30)&&(receive1[8]<=0x39)&&(receive1[9]>=0x30)&&(rec
             -eive1[9]<=0x39))
2577          //      {
2578          //      receive1[4]=receive1[4]-0x30;
2579          //      receive1[5]=receive1[5]-0x30;
2580          //      receive1[7]=receive1[7]-0x30;
2581          //      receive1[8]=receive1[8]-0x30;
2582          //      receive1[9]=receive1[9]-0x30;
2583          //
2584          //      par_buf[21]=receive1[4];
2585          //      par_buf[22]=receive1[5];
2586          //      par_buf[23]=receive1[7];
2587          //      par_buf[24]=receive1[8];
2588          //      par_buf[25]=receive1[9];
2589          //
2590          //
2591          //
2592          //
2593          //
2594          //        EA=0;
2595          //
2596          //        erase_par();
2597          //        write_par();  //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
2598          //         EA=1;
2599          //  }
2600          //
2601          //
2602          //
2603          //
2604          //}
2605          //void send_ah(void)                                //è¯»æŠ¥è­¦è¿Ÿæ»å€¼
2606          //{
2607          //
2608          //      send_buf[2]= 'A';
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 43  

2609          //      send_buf[3]= 'H';
2610          //      send_buf[4]=par_buf[21]+0x30;
2611          //      send_buf[5]=par_buf[22]+0x30;
2612          //      send_buf[6]='.';
2613          //      send_buf[7]=par_buf[23]+0x30;
2614          //      send_buf[8]=par_buf[24]+0x30;
2615          //      send_buf[9]=par_buf[25]+0x30;
2616          //        send_crc_buf();
2617          //}
2618          //
2619          //
2620          //void opt(void)
2621          //{
2622          //
2623          //    if((receive1[4]>=0x31)&&(receive1[4]<=0x33)&&(receive1[5]==0x30)&&(receive1[6]==0x30)&&(receive1[7]=
             -=0x30)&&(receive1[8]==0x30)&&(receive1[9]==0x30))
2624          //      {
2625          //      receive1[4]=receive1[4]-0x30;
2626          //
2627          //      par_buf[34]=receive1[4];
2628          //
2629          //
2630          //
2631          //         EA=0;
2632          //
2633          //        erase_par();
2634          //        write_par();  //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
2635          //        EA=1;
2636          //
2637          //        }
2638          //}
2639          //
2640          //
2641          //void send_opt(void)                      //æŠ¥è­¦ç‚¹é€‰æ‹©
2642          //{
2643          //      send_buf[2]= 'O';
2644          //      send_buf[3]= 'P';
2645          //      send_buf[4]=par_buf[34]+0x30;
2646          //      send_buf[5]=' ';
2647          //      send_buf[6]=' ';
2648          //      send_buf[7]=' ';
2649          //      send_buf[8]=' ';
2650          //      send_buf[9]=' ';
2651          //        send_crc_buf();
2652          //}
2653          // void rl(void)                    //RELAY
2654          //{
2655          //
2656          //    if((receive1[4]>=0x30)&&(receive1[4]<=0x31)&&(receive1[5]==0x30)&&(receive1[6]==0x30)&&(receive1[7]=
             -=0x30)&&(receive1[8]==0x30)&&(receive1[9]==0x30))
2657          //      {
2658          //      receive1[4]=receive1[4]-0x30;
2659          //
2660          //      par_buf[35]=receive1[4];
2661          //
2662          //
2663          //
2664          //         EA=0;
2665          //
2666          //        erase_par();
2667          //        write_par();  //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
2668          //        EA=1;
2669          //
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 44  

2670          //        }
2671          //}
2672          //
2673          //
2674          //void send_rl(void)                    //ç»§ç”µå™¨
2675          //{
2676          //      send_buf[2]= 'R';
2677          //      send_buf[3]= 'L';
2678          //      send_buf[4]=par_buf[35]+0x30;
2679          //      send_buf[5]=' ';
2680          //      send_buf[6]=' ';
2681          //      send_buf[7]=' ';
2682          //      send_buf[8]=' ';
2683          //      send_buf[9]=' ';
2684          //        send_crc_buf();
2685          //}
2686          //void po(void)                       //PNP
2687          //{
2688          //
2689          //    if((receive1[4]>=0x30)&&(receive1[4]<=0x31)&&(receive1[5]==0x30)&&(receive1[6]==0x30)&&(receive1[7]=
             -=0x30)&&(receive1[8]==0x30)&&(receive1[9]==0x30))
2690          //      {
2691          //      receive1[4]=receive1[4]-0x30;
2692          //
2693          //      par_buf[36]=receive1[4];
2694          //
2695          //
2696          //
2697          //         EA=0;
2698          //
2699          //        erase_par();
2700          //        write_par();  //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
2701          //
2702          //           EA=1;
2703          //        }
2704          //}
2705          //
2706          //
2707          //void send_po(void)                   //PNP
2708          //{
2709          //      send_buf[2]= 'P';
2710          //      send_buf[3]= 'O';
2711          //      send_buf[4]=par_buf[36]+0x30;
2712          //      send_buf[5]=' ';
2713          //      send_buf[6]=' ';
2714          //      send_buf[7]=' ';
2715          //      send_buf[8]=' ';
2716          //      send_buf[9]=' ';
2717          //        send_crc_buf();
2718          //}
2719          //void send_ver()                    //version
2720          //{
2721          //      send_buf[2]= 'V';
2722          //      send_buf[3]= 'e';
2723          //      send_buf[4]='r';
2724          //      send_buf[5]=version_major;
2725          //      send_buf[6]='.';
2726          //      send_buf[7]=version_minor;
2727          //      send_buf[8]='0';
2728          //      send_buf[9]='0';
2729          //      send_crc_buf();
2730          //
2731          //}
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 45  

2732          //
2733          //
2734          ///////////////////////////////////////////////////////
2735          ///*                     ä¸»ç¨‹åº                      */
2736          ///////////////////////////////////////////////////////
2737          //void main(void)
2738          //{
2739          //    uchar i;
2740          //
2741          //    Init_Device();
2742          //
2743          //  delay1s();
2744          //  delay1s();
2745          //  delay1s();
2746          //
2747          //  m_init();
2748          //  m_send(0x01,0xff);                  //8.8.8 8 8
2749          //  m_send(0x02,0xff);
2750          //  m_send(0x03,0x7f);
2751          //  m_send(0x04,0x7f);
2752          //  m_send(0x05,0x7f);
2753          //
2754          //
2755          //    Power = 0;
2756          //    EA = 0;              //ç¦ç”¨æ‰€æœ‰ä¸­æ–­æº
2757          //   read_par();
2758          //
2759          //  if (( (par_buf[26]==0x01)&&(par_buf[27]==0x02)&&(par_buf[28]==0x03))==0)
2760          //  {
2761          //    erase_par();
2762          //    init_par();
2763          //
2764          //  }
2765          //
2766          //  for (i=0;i<38;i++)                     //éªŒè¯
2767          //  {
2768          //    if ( par_buf[i]>9)
2769          //    {
2770          //        PCA0CPH4 = 0xa0;
2771          //        erase_par();
2772          //        init_par();
2773          //
2774          //    }
2775          //  }
2776          //
2777          //
2778          //
2779          //  //STC1387init
2780          ////    SLEW = 1;
2781          ////  if(par_buf[37]==0x00)
2782          ////  {
2783          ////  MODE = 0;//RS232 mode
2784          ////  }
2785          ////  else if(par_buf[37]==0x01)
2786          ////  {MODE = 1;}//RS485 mode
2787          //
2788          //
2789          //  RXEN = 1;
2790          //  DXEN = 0;
2791          //
2792          //
2793          //  UP = par_buf[10]*10000+par_buf[11]*1000+par_buf[12]*100+par_buf[13]*10+par_buf[14];
2794          //  LO = par_buf[15]*10000+par_buf[16]*1000+par_buf[17]*100+par_buf[18]*10+par_buf[19];
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 46  

2795          //  AH = par_buf[21]*10000+par_buf[22]*1000+par_buf[23]*100+par_buf[24]*10+par_buf[25];
2796          //
2797          //
2798          //  CTR = par_buf[34];
2799          //
2800          //
2801          //
2802          //    read_par();
2803          //
2804          //
2805          //  // æ¿€å…‰æµ‹è·ä»ªåˆå§‹åŒ–æ—¶é—´
2806          //
2807          //  delay1s();
2808          //  delay1s();
2809          //    delay1s();
2810          //  delay1s();
2811          //  delay1s();
2812          //  delay1s();
2813          //
2814          //
2815          //  trans0("ASdt\r\n");
2816          //  delay1s();
2817          //  delay1s();
2818          //  trans0("ASdt\r\n");
2819          //  delay1s();
2820          //  delay1s();
2821          //
2822          //  trans0("SE2\r\n");
2823          //  delay1s();
2824          //  delay1s();
2825          //
2826          //  send_rb3();
2827          //  send_re3();
2828          //
2829          //  trans0("DT\r\n");
2830          //
2831          //  delay1s();
2832          //  delay1s();
2833          //    trans0("DT\r\n");
2834          //  delay1s();
2835          //
2836          //    function_flag = 0;
2837          //  find_key = 0;
2838          //
2839          //  //Added to fix Comm lockup problem MD 20210409
2840          //  i=SBUF1;        // flush UART1 input buffer
2841          //  i=SBUF1;        // flush UART1 input buffer
2842          //  rcv_count = 0;      // state: waiting for '#'
2843          //  uart1_receve_end = 0; // state: no complete message received
2844          //  b_head_sure=0;      // state: no '#' found
2845          //  UART1_Init();     // reinitialize UART1
2846          //  RXEN = 1;       // RS-485 driver receive enable
2847          //  DXEN = 0;       // RS-485 driver transmit disable
2848          //
2849          //  EA = 1;                 //all interrupt enable
2850          //  RI0 = 0;                //receive flag
2851          //  ES0 = 1;        //Enable UART0 Interrupt
2852          //  SCON1 |= 0x01;//å¼€å¯ä¸€æ¬¡ä¸­æ–­ï¼Œè§£å†³UART1ä¼˜å…ˆçº§é«˜å¯¼è‡´UART0ä¸å·¥ä½œçš„æƒ…å†µï¼ˆUART1ä¸­æ–
             -­ä¸€æ¬¡åUART0æ‰èƒ½è¿›å…¥ä¸­æ–­ï¼‰
2853          //  i=SBUF1;        // flush UART1 input buffer
2854          //  i=SBUF1;        // flush UART1 input buffer
2855          //  // delay1s();
2856          //
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 47  

2857          //    delay20ms();
2858          //  while(1)
2859          //  {
2860          //       PCA0CPH4 = 0xa0;
2861          //
2862          //     scan_keyboard();
2863          //
2864          //      direct_uart0();
2865          //
2866          //     direct_uart1();
2867          //     if(par_buf[37]==1)
2868          //     {send_dt1();  }
2869          //
2870          //  }
2871          //}
2872          
2873          /********************************************************************************
2874          * FILE NAME           : LMD(æŒ‰é”®å¼:å•ç‚¹/èŒƒå›´è¾“å‡ºRS232 å’ŒRS485ï¼‰.C
2875          * Copyright           : 2012--2020 Lucheng Sensor Corporation,All Rights Reserved.
2876          * Module Name         : æ¿€å…‰æµ‹è·ä»ª
2877          * CPU                 : C8051F381
2878          * Create Date         : 2013/09/05
2879          * Author              : Kerry_Sun
2880          * Abstract Description:
2881          *
2882          
2883          **------------------------ Revision History ----------------------------------**
2884          
2885          * No     Version       Date          Revised By     Item    Description
2886          * 1       V1.41         2015/03/13   Kerry                   first release
2887          
2888          * æ›´æ”¹è¾“å‡ºä¸ºä¸‰ç«¯å¼
2889          *                       2015/04/13    Kerry                  æ›´æ”¹æ¿€å…‰æœºèŠ¯åˆå§‹åŒ– ï¼šå»æ‰PR
2890          2         V1.42         2015/06/19    Kerry                  æ›´æ”¹ä¸²å£ä¸­æ–­ä¸ºé«˜ä¼˜å…ˆçº§
2891          3         V1.351        2015/09/11    Kerry                  å»æ‰DIR0ï¼Œå¢åŠ ç»§ç”µå™¨å’ŒPNPçš„è¾“å‡ºé€
             -‰æ‹©ï¼š=0 è·ç¦»æŠ¥è­¦è¾“å‡ºï¼Œ=1 é”™è¯¯æŠ¥è­¦è¾“å‡º
2892          4         V2.0          2015/10/19    kerry                  å°†RS232å’ŒRS485åˆå¹¶åœ¨ä¸€ä¸ªç¨‹åºé‡Œé¢
2893          5         V2.2          2016/4/21    kerry                  ä¿®æ”¹RS485é€šè®¯å¤šæœºæ­»æœºé—®é¢˜
2894          6.        V3.0          2020.06.16    kerry                  ä¿®æ”¹å…ˆæŒ‰enteré”®ï¼Œå†æŒ‰SETé”®å‡ºç°é”™è
             -¯¯æ˜¾ç¤ºçš„bug
2895          7         V3.1          2021/04/09    Mark Dresser          Correct comm lockup bug, rename b -> bx, up->u
             -px for KEIL toolset
2896          8         V3.2      2021/06/21    Mark Dresser          Correct distance overflow error above 65 m.
2897          *********************************************************************************/
2898          //#include <config_381.h>
2899          
2900          #include <math.h>
2901          #include <stdio.h>
2902          #include <absacc.h>
2903          #include "compiler_defs.h"
2904          #include "C8051F380_defs.h"
2905          
2906          
2907          #define  uchar  unsigned char
2908          #define  uint  unsigned int
2909          #define  ulint  unsigned long int
2910          #define lint  long int
2911          
2912          #define version_major '3'
2913          #define version_minor '2'
2914          
2915          uchar code par0[38] ={    0x00,0x00,0x02,0x00,0x00, //RB00.200---0,1,2,3,4
2916                                    0x03,0x00,0x00,0x00,0x00, //RE30.000---5,6,7,8,9,
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 48  

2917                          0x01,0x00,0x00,0x00,0x00, //UP10.000----10,11,12,13,14
2918                                    0x00,0x02,0x00,0x00,0x00, //LO02.000---15,16,17,18,19
2919                          0x00,           //ADD--20,
2920                          0x00,0x00,0x02,0x00,0x00, //AH ---21,22,23,24,25
2921                          0x01,0x02,0x03, //ä¸Šç”µè¯†åˆ«ä»£ç  26,27,28
2922                                        0x00,0x02,0x05,0x00,0x00, // AC ---29,30,31,32,33,
2923                          0x01,                      // OPT---34  1:<AL ;2:AL--AH;3:>AH
2924                                        0x00,                      //ç»§ç”µå™¨çš„è¾“å‡ºå½¢å¼ï¼Œ=0ï¼š è·ç¦»è¾“å‡ºï¼
             -›=1ï¼šå‡ºé”™è¾“å‡º----35
2925                          0x00,                        //PNPçš„è¾“å‡ºå½¢å¼ï¼Œ=0ï¼š è·ç¦»è¾“å‡ºï¼›=1ï¼šå‡ºé”™è¾“å‡º
             -------36
2926                          0x01                          //0=rs232,1 =rs485
2927                                   };
2928          uchar idata par_buf[38];//ä»å•ç‰‡æœºå†…éƒ¨çš„flashè¯»å‡ºæ•°æ®åˆ°XRAM
2929          
2930          //flash
2931          uchar xdata *pwrite;//å¤–éƒ¨æ•°æ®ç¼“å†²åŒº
2932          uchar code *pread;
2933          
2934          uchar *par;
2935          
2936          sbit ALARM  = P2^0;
2937          sbit m_clk  = P1^0;
2938          sbit m_load = P1^2;
2939          sbit m_din  =   P1^1;
2940          sbit enter    = P1^7;
2941          sbit shift_right= P1^6;
2942          sbit upx      = P1^5;
2943          sbit function = P1^4;
2944          sbit POWER  = P1^3;
2945          sbit OUT0 = P2^6;
2946          sbit OUT1   =   P2^5;
2947          //sbit OUT3 = P2^2;
2948          sbit MODE         = P0^7;
2949          sbit RXEN        = P0^3;
2950          sbit DXEN        = P0^6;
2951          //sbit ON           = P2^4;
2952          sbit SLEW         = P0^2;
2953          
2954          
2955          
2956          ulint data UP;
2957          ulint data LO;
2958          ulint data AH;
2959          
2960          uchar data CTR;
2961          ulint data now_val;
2962          uchar idata a,bx,c,d,e;
2963          
2964          
2965          uchar data receive0_temp[10]={' ',' ',' ',' ',' ',' ',' ',' ',' ',' '};
2966          
2967          
2968          uchar idata function_flag;
2969          
2970          uchar idata up_flag;
2971          uchar idata shift_right_flag=0;
2972          uchar idata enter_flag;
2973          bit idata   find_key;
2974          
2975          
2976          //----------------------------UART1-----------------------------------------
2977          uchar data receive1[12]={' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' '};
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 49  

2978          uchar data send_buf[12]={' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' '};
2979          volatile uchar data tl0timer0=0;//20msçš„æ—¶é—´åŸºå‡†
2980          bit b_head_sure= 0;
2981          bit send_enable=0;
2982          //uchar idata rcv1_end_flag = 0;
2983          uchar idata rcv_count = 0;
2984          bit uart1_receve_end = 0;
2985          volatile uchar data txcount0=0;
2986          volatile uchar data txptr0=0;//æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ªåœ°å€
2987          
2988          //---------------------------------------------------------------------------
2989          
2990          void trans0(char *str);
2991          void display(void);
2992          
2993          void display_add(void);
2994          void  shift0_5(void);
2995          void  shift_add(void);
2996          void disp_emissivity_5(void);
2997          void disp_emissivity0_5(void);
2998          void disp_emissivity_2(void);
2999          void disp_emissivity0_2(void);
3000          //void display_uart0(void);
3001          void rb1(void);
3002          void send_rb(void);
3003          void send_rb3();
3004          void send_rb0();
3005          void send_dt(void);
3006          void send_dt1(void);
3007          //void dt(void);
3008          void send_re(void);
3009          void re1();
3010          void send_re3();
3011          void send_re0();
3012          
3013          void send_ah(void);
3014          void ah1(void);
3015          
3016          void send_dl();
3017          void dl1();
3018          void pa(void);
3019          //void pr(void);
3020          void send_dh();
3021          void dh1();
3022          
3023          void send_opt();
3024          void opt();
3025          void po();
3026          void send_po();
3027          void rl();
3028          void send_rl();
3029          void alarm_state(void);
3030          void direct_uart1();
3031          void direct_uart0(void);
3032          void send_ver();
3033          //void send_error_code1();
3034          //void send_error_code2();
3035          //void display_dt();
3036          void send_crc_buf(void);
3037          
3038          //-----------------------------------------------------------------------------
3039          // SiLabs_Startup() Routine
3040          // ----------------------------------------------------------------------------
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 50  

3041          // This function is called immediately after reset, before the initialization
3042          // code is run in SILABS_STARTUP.A51 (which runs before main() ). This is a
3043          // useful place to disable the watchdog timer, which is enable by default
3044          // and may trigger before main() in some instances.
3045          //-----------------------------------------------------------------------------
3046          void SiLabs_Startup (void)
3047          {
3048   1        PCA0MD &= ~0x40;    //clear WD Timer Enable at beginning of initialization code or it may fire.
3049   1      }
3050          
3051          /////////////////////////////////////
3052          //  Generated Initialization File  //
3053          
3054          void PCA_Init()
3055          {
3056   1          PCA0MD    &= ~0x40;
3057   1          PCA0MD    = 0x00;
3058   1          PCA0CPL4  = 0xC2;
3059   1          PCA0MD    |= 0x20;
3060   1      }
3061          
3062          void UART0_Init()
3063          {
3064   1          SCON0     = 0x10;
3065   1      
3066   1          TCON      = 0x50; //timer1 enable
3067   1          TMOD      = 0x21; //8bit counter/timer autoreload
3068   1          CKCON     = 0x01; //timer1 clock = sysclock
3069   1          TH1       = 0x64; //bandrate 38400bit
3070   1        TL1       = TH1;
3071   1        ES0       = 1;
3072   1      
3073   1        // IP |= 0x10;                         // Make UART high priority
3074   1      }
3075          
3076          void UART1_Init()
3077          {
3078   1      
3079   1         SMOD1 = 0x0C;
3080   1      
3081   1         SCON1 = 0x10;                       // SCON1: 8-bit variable bit rate
3082   1                                             //        level of STOP bit is ignored
3083   1                                             //        RX enabled
3084   1                                             //        ninth bits are zeros
3085   1                                             //        clear RI0 and TI0 bits
3086   1          SBRLL1    = 0x8F;  // 9600
3087   1          SBRLH1    = 0xFD;
3088   1      
3089   1      
3090   1          SBCON1 |= 0x43;                     // enable baud rate generator
3091   1      
3092   1      
3093   1        SCON1 |= 0x02;                      // indicate ready for TX
3094   1      
3095   1         EIE2 |= 0x02;  //enable UART1 interrupt
3096   1           EIP2 |= 0x02;   // Make UART high priority
3097   1      
3098   1      
3099   1      }
3100          void timer0_init(void)
3101          {
3102   1          TCON      = 0x00;
3103   1          TMOD      = 0x01;
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 51  

3104   1         CKCON=0x00;        //timer0ä½¿ç”¨sysclk/12
3105   1         ET0=1;         //ET0=1;
3106   1         TH0=(65536-20000)/256;//20mså®šæ—¶
3107   1         TL0=(65535-20000)%256;
3108   1         TR0=1;
3109   1       //  PT0=1;             //ä¸ºé»˜è®¤ä¼˜å…ˆçº§
3110   1      
3111   1      }
3112          void Port_IO_Init()
3113          {
3114   1       // P0.0  -  TX1 (UART1), Push-Pull,  Digital
3115   1          // P0.1  -  RX1 (UART1), Open-Drain, Digital
3116   1          // P0.2  -  Unassigned,  Open-Drain, Digital
3117   1          // P0.3  -  Unassigned,  Open-Drain, Digital
3118   1          // P0.4  -  TX0 (UART0), Push-Pull,  Digital
3119   1          // P0.5  -  RX0 (UART0), Open-Drain, Digital
3120   1          // P0.6  -  Unassigned,  Open-Drain, Digital
3121   1          // P0.7  -  Unassigned,  Open-Drain, Digital
3122   1      
3123   1          // P1.0  -  Unassigned,  Open-Drain, Digital
3124   1          // P1.1  -  Unassigned,  Open-Drain, Digital
3125   1          // P1.2  -  Unassigned,  Open-Drain, Digital
3126   1          // P1.3  -  Unassigned,  Open-Drain, Digital
3127   1          // P1.4  -  Unassigned,  Open-Drain, Digital
3128   1          // P1.5  -  Unassigned,  Open-Drain, Digital
3129   1          // P1.6  -  Unassigned,  Open-Drain, Digital
3130   1          // P1.7  -  Unassigned,  Open-Drain, Digital
3131   1      
3132   1          // P2.0  -  Unassigned,  Open-Drain, Digital
3133   1          // P2.1  -  Unassigned,  Open-Drain, Digital
3134   1          // P2.2  -  Unassigned,  Open-Drain, Digital
3135   1          // P2.3  -  Unassigned,  Open-Drain, Digital
3136   1          // P2.4  -  Unassigned,  Open-Drain, Digital
3137   1          // P2.5  -  Unassigned,  Open-Drain, Digital
3138   1          // P2.6  -  Unassigned,  Open-Drain, Digital
3139   1          // P2.7  -  Unassigned,  Open-Drain, Digital
3140   1      
3141   1          // P3.0  -  Unassigned,  Open-Drain, Digital
3142   1      
3143   1          P0MDOUT   = 0x11;
3144   1          XBR0      = 0x01;
3145   1          XBR1      = 0x40;
3146   1          XBR2      = 0x01;
3147   1      
3148   1      
3149   1      }
3150          
3151          void Oscillator_Init()
3152          {
3153   1          int i = 0;
3154   1          OSCICN    = 0xC3;
3155   1      }
3156          // Initialization function for device,
3157          // Call Init_Device() from your main program
3158          void Init_Device(void)
3159          {
3160   1          PCA_Init();
3161   1          timer0_init();
3162   1          UART0_Init();
3163   1        UART1_Init();
3164   1          Port_IO_Init();
3165   1          Oscillator_Init();
3166   1      }
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 52  

3167          
3168          void trans0(char *str)
3169          {
3170   1        uchar *p;
3171   1        p = str;
3172   1        while(*p!='\0')
3173   1        {
3174   2          PCA0CPH4 = 0xa0;
3175   2          SBUF0 = *p++;
3176   2          while(!TI0);
3177   2          TI0 = 0;
3178   2        }
3179   1      }
3180          
3181          /////////////////////////////////////////////////////
3182          /*                      DELAY                      */
3183          /////////////////////////////////////////////////////
3184          
3185          void delay(int  n)
3186          {
3187   1        int i;
3188   1        int j;
3189   1      
3190   1        for (i=0;i<n;i++)
3191   1        {
3192   2      
3193   2        for(j=0;j<1;j++)
3194   2        {PCA0CPH4 = 0xa0;}
3195   2        }
3196   1      }
3197          
3198          
3199          
3200          void delay20ms(void)
3201          {
3202   1          uchar j;
3203   1          for(j=0;j<100;j++)
3204   1          {
3205   2            PCA0CPH4 = 0xa0;
3206   2              delay(40);
3207   2      
3208   2          }
3209   1      }
3210          
3211          void delay1s(void)
3212          {
3213   1        uchar l;
3214   1        for(l=0;l<10;l++)
3215   1        {
3216   2          PCA0CPH4 = 0xa0;
3217   2          delay20ms();
3218   2        }
3219   1      }
3220          /////////////////////////////////////////////////////
3221          /*                    m_display                      */
3222          /////////////////////////////////////////////////////
3223          static  struct
3224          {
3225            uchar ascii;
3226            uchar stroke;
3227          }code led_stroke[]=
3228            {
3229              {0,0x7e},{1,0x30},{2,0x6d},{3,0x79},{4,0x33},
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 53  

3230              {5,0x5b},{6,0x5f},{7,0x70},{8,0x7f},{9,0x7b},
3231              {'0',0x7e},{'1',0x30},{'2',0x6d},{'3',0x79},{'4',0x33},
3232              {'5',0x5b},{'6',0x5f},{'7',0x70},{'8',0x7f},{'9',0x7b},
3233              {'A',0x77},{'B',0x1f},{'C',0x4e},{'D',0x3d},{'E',0x4f},
3234              {'F',0x47},{'H',0x37},{'I',0X06},{'L',0x0e},{'M',0x15},
3235              {'O',0x1d},{'P',0x67},{'R',0x05},{'S',0x5b},{'T',0x46},
3236              {'Y',0x3b},{'U',0x3E},{'-',0x01},{' ',0x00},{'\n',0x00},{'\r',0x00}
3237            };
3238          
3239          
3240          
3241          void  m_send(uchar addr,uchar da)
3242          {
3243   1        uchar i,byte_out;
3244   1        byte_out=addr;
3245   1        m_clk=0;
3246   1        m_load=0;
3247   1        for(i=0;i<8;i++)
3248   1          {
3249   2            m_din=byte_out&0x80;
3250   2              m_clk = 0;
3251   2                PCA0CPH4 = 0xa0;
3252   2            m_clk = 1;
3253   2            byte_out=byte_out<<1;
3254   2          }
3255   1        byte_out=da;
3256   1        for(i=0;i<8;i++)
3257   1          {
3258   2            m_din=byte_out&0x80;
3259   2            m_clk=0;
3260   2      
3261   2              PCA0CPH4 = 0xa0;
3262   2            m_clk = 1;
3263   2            byte_out=byte_out<<1;
3264   2          }
3265   1      
3266   1        m_load=1;
3267   1      
3268   1      }
3269          
3270          void  m_init(void)
3271          {
3272   1        m_send(0x09,0x00);//no dcode
3273   1        m_send(0x0a,0x02);//light
3274   1        m_send(0x0b,0x04);//number 5
3275   1        m_send(0x0c,0x01);//start
3276   1        m_send(0x0f,0x00);
3277   1      
3278   1      }
3279          
3280          uchar get_stroke(uchar c)
3281          {
3282   1        uchar i=0;
3283   1        while(led_stroke[i].ascii!=c)
3284   1        {
3285   2          i++;
3286   2            PCA0CPH4 = 0xa0;
3287   2          if(i>40)
3288   2          {
3289   3            return(' ');
3290   3          }
3291   2        }
3292   1        return(led_stroke[i].stroke);
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 54  

3293   1      }
3294          
3295          
3296          /////////////////////////////////////////////////////
3297          /*               C8051F38X flash                   */
3298          /////////////////////////////////////////////////////
3299          /*
3300          PSCTL:
3301          ä½0 PSWE - ç½®ä½ï¼Œå…è®¸å†™FLASHï¼›
3302          ä½1 PSEE - ç½®ä½ï¼Œå…è®¸æ“¦é™¤FLASHï¼›
3303          ä½2 SFLE - ç½®ä½ï¼Œå…è®¸ç”¨æˆ·è½¯ä»¶è®¿é—®FLASHçš„128Bçš„ä¸´æ—¶å­˜å‚¨å™¨æ‰‡åŒº
3304          å…¶ä»–ä½ç½®0
3305          
3306          FLSCLï¼š
3307          ä½0 FLWE - ç½®ä½ï¼Œå…è®¸å†™FLASHï¼›
3308          ä½1-5 ä¿ç•™ï¼Œ0000ï¼›
3309          ä½6 FRAE - ç½®ä½ï¼Œé—ªå­˜æ€»æ˜¯å¤„äºè¯»æ–¹å¼
3310          ä½7 FOSE - ç½®ä½ï¼Œå…è®¸é—ªå­˜å•ç¨³æ€å®šæ—¶å™¨
3311          */
3312          
3313          void erase_par(void)  //é¦–æ¬¡ä¸Šç”µåˆå§‹åŒ–,å°†å¤–éƒ¨æ•°æ®åˆå§‹åŒ–ä¸º0xff
3314          {
3315   1        EA=0;
3316   1          FLKEY=0xA5;
3317   1        FLKEY=0xF1;
3318   1        PSCTL=0x03; //  bit1 PSEE =1 : permit erase; bit0 PSWE = 1 :permit write
3319   1        pwrite=0x7E00;
3320   1        *pwrite=0x00;
3321   1          PSCTL=0x00;   // å¤ä½ï¼Œç”¨æˆ·è½¯ä»¶è®¿é—®FLASHçš„64KBçš„ç¨‹åº/æ•°æ®FLASHæ‰‡åŒºï¼Œå¾ˆé‡è¦ï¼ï¼ï
             -¼
3322   1      
3323   1      }
3324          
3325          void read_par(void)
3326          {
3327   1        uchar data i;
3328   1      
3329   1        FLSCL=0xcf;       //ç¦æ­¢flashå†™
3330   1        PSCTL=0x00;
3331   1        pread=0x7E00;     //åˆå§‹åŒ–codeè¯»æŒ‡é’ˆä¸ºå­—ç¬¦ä¸²èµ·å§‹å˜é‡
3332   1        for(i=0;i<38;i++)
3333   1        {
3334   2          par_buf[i]=*pread++;    //å°†FLASHå†…æ•°æ®è¯»åˆ°XRAM
3335   2         PCA0CPH4 = 0xa0;
3336   2        }
3337   1      
3338   1      }
3339          void init_par(void)
3340          {
3341   1      
3342   1        uchar data i;
3343   1         PFE0CN =0x00;        // select single-byte write mode.
3344   1        PSCTL=0x01;
3345   1        par=&par0[0];
3346   1        pwrite=0x7E00;
3347   1        for (i=0;i<38;i++)
3348   1        {
3349   2               FLKEY=0xA5;
3350   2             FLKEY=0xF1;
3351   2            *pwrite=*par;
3352   2            pwrite++;
3353   2            par++;
3354   2            PCA0CPH4 = 0xa0;
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 55  

3355   2          }
3356   1          PSCTL=0x00;
3357   1      
3358   1          read_par();
3359   1      
3360   1      }
3361          
3362          
3363          
3364          void write_par(void)
3365          {
3366   1        uchar data i;
3367   1         PFE0CN =0x00;
3368   1        PSCTL=0x01;
3369   1        pwrite=0x7E00;
3370   1        for (i=0;i<38;i++)
3371   1        {
3372   2            FLKEY=0xA5;
3373   2             FLKEY=0xF1;
3374   2          *pwrite++=par_buf[i];
3375   2          PCA0CPH4 = 0xa0;
3376   2        }
3377   1          PSCTL=0x00;
3378   1          read_par();
3379   1      
3380   1      }
3381          
3382          void timer0_isr(void) interrupt 1 //using 1
3383          
3384          {
3385   1         uchar data key_value_temp;
3386   1      
3387   1        if(tl0timer0<5)
3388   1        {tl0timer0++;}//ä¸PCé€šä¿¡ç©ºé—²çš„æ—¶é—´*/
3389   1      
3390   1         key_value_temp=(~P1)&0xf0; // 0x00101110  P1^4:SET; P1^5:ADD; P1^6:REDUCE; P1^7:OK
3391   1      
3392   1        if (key_value_temp!=0)
3393   1         {
3394   2             delay(10);
3395   2      
3396   2          if (key_value_temp!=0)
3397   2          {
3398   3           delay(10);
3399   3      
3400   3            switch(key_value_temp)
3401   3          {
3402   4      //        key_value_temp= (~P1)&0xf0;   // this isn't even executed (but even if it was, it wouldn't retro
             -actively change the result of switch statement above?
3403   4            case 0x10:  function_flag++;
3404   4                           find_key=1;
3405   4                        if (function_flag==12)
3406   4                    {
3407   5                      function_flag=1;
3408   5                    }
3409   4                  do{ PCA0CPH4 = 0xa0;}
3410   4                    while (function==0);
3411   4                    delay(10);
3412   4      
3413   4                  break;
3414   4            case 0x40:  shift_right_flag++;
3415   4      
3416   4                  if (shift_right_flag==6)
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 56  

3417   4                  {
3418   5                    shift_right_flag=1;
3419   5                        }
3420   4                    do{ PCA0CPH4 = 0xa0;}
3421   4                  while (shift_right==0);
3422   4                  delay(10);;
3423   4      
3424   4                  break;
3425   4            case 0x20:  up_flag++;
3426   4      
3427   4                  if (up_flag==10)
3428   4                  {
3429   5                    up_flag=0;
3430   5                      }
3431   4                    do{PCA0CPH4 = 0xa0; }
3432   4                  while (upx==0);
3433   4                  delay(10);;
3434   4      
3435   4                  break;
3436   4            case  0x80: if(function_flag!=0)
3437   4                         {enter_flag=1;}
3438   4                    do{PCA0CPH4 = 0xa0; }
3439   4                    while (enter==0);
3440   4                    delay(10);;
3441   4      
3442   4                  break;
3443   4            default:  break;
3444   4            }
3445   3         }
3446   2        }
3447   1          TH0=(65535-20000)/256;    //20mså®šæ—¶é‡è½½65536-18432
3448   1          TL0=(65535-20000)%256;
3449   1      
3450   1      
3451   1      
3452   1      }
3453          
3454          void key_flag_init(void)
3455          {
3456   1        function_flag=0;
3457   1        up_flag=0;
3458   1        shift_right_flag=0;
3459   1        enter_flag=0;
3460   1      }
3461          void scan_keyboard(void)
3462          {
3463   1       // if(function_flag==0) return ;
3464   1      
3465   1        switch(function_flag)
3466   1        {
3467   2          case 1:
3468   2      
3469   2                      m_init();
3470   2                m_send(0x01,get_stroke('1'));
3471   2                m_send(0x02,get_stroke('-'));
3472   2                m_send(0x03,get_stroke('-'));
3473   2                m_send(0x04,get_stroke('R'));
3474   2                m_send(0x05,get_stroke('B'));
3475   2      
3476   2                  find_key=1;
3477   2      
3478   2                    a=par_buf[0];
3479   2                       bx=par_buf[1];
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 57  

3480   2                       c=par_buf[2];
3481   2                     d=par_buf[3];
3482   2                     e=par_buf[4];
3483   2              if  (enter_flag==1)
3484   2              {
3485   3                shift_right_flag=1;
3486   3                        up_flag=0;
3487   3                        enter_flag=0;
3488   3                display();
3489   3                 do
3490   3                            {
3491   4                          PCA0CPH4 = 0xa0;
3492   4                              shift0_5(); //æ˜¾ç¤º5ä½
3493   4      
3494   4                           }
3495   3                           while  (enter_flag==0);
3496   3                          {
3497   4      
3498   4                            key_flag_init();
3499   4      
3500   4                         display();
3501   4                            par_buf[0]=a;
3502   4                            par_buf[1]=bx;
3503   4                            par_buf[2]=c;
3504   4                          par_buf[3]=d;
3505   4                          par_buf[4]=e;
3506   4                     EA=0;
3507   4                           erase_par();
3508   4                         write_par();     //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
3509   4                          EA=1;
3510   4      
3511   4                            SBUF0 = 'R';  while(!TI0);TI0 = 0;
3512   4                     SBUF0 = 'B';  while(!TI0);TI0 = 0;
3513   4                      SBUF0 = par_buf[0]+0x30;while(!TI0);TI0 = 0;
3514   4                      SBUF0 = par_buf[1]+0x30;while(!TI0);TI0 = 0;
3515   4                      SBUF0 = '.';            while(!TI0);TI0 = 0;
3516   4                      SBUF0 = par_buf[2]+0x30;while(!TI0);TI0 = 0;
3517   4                      SBUF0 = par_buf[3]+0x30;while(!TI0);TI0 = 0;
3518   4                      SBUF0 = par_buf[4]+0x30;while(!TI0);TI0 = 0;
3519   4                      SBUF0 = 0x0d;           while(!TI0);TI0 = 0;
3520   4                      SBUF0 = 0x0a;           while(!TI0);TI0 = 0;
3521   4                      delay1s();
3522   4                      delay1s();
3523   4      
3524   4                      trans0("DT\r\n");
3525   4                      delay1s();
3526   4                      delay1s();
3527   4      
3528   4                      find_key = 0;
3529   4                      delay1s();
3530   4      
3531   4      
3532   4      
3533   4                        }
3534   3      
3535   3      
3536   3              }
3537   2              break;
3538   2          case 2:
3539   2      
3540   2                      m_init();
3541   2                m_send(0x01,get_stroke('2'));
3542   2                m_send(0x02,get_stroke('-'));
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 58  

3543   2                m_send(0x03,get_stroke('-'));
3544   2                m_send(0x04,get_stroke('R'));
3545   2                m_send(0x05,get_stroke('E'));
3546   2      
3547   2                 find_key=1;
3548   2                     a=par_buf[5];
3549   2                       bx=par_buf[6];
3550   2                       c=par_buf[7];
3551   2                     d=par_buf[8];
3552   2                     e=par_buf[9];
3553   2      
3554   2              if  (enter_flag==1)
3555   2              {
3556   3                shift_right_flag=1;
3557   3                        up_flag=0;
3558   3                        enter_flag=0;
3559   3                display();
3560   3                 do
3561   3                            {
3562   4                          PCA0CPH4 = 0xa0;
3563   4                              shift0_5(); //æ˜¾ç¤º5ä½
3564   4      
3565   4                           }
3566   3                           while  (enter_flag==0);
3567   3                          {
3568   4      
3569   4                            key_flag_init();
3570   4      
3571   4                         display();
3572   4                           par_buf[5]=a;
3573   4                            par_buf[6]=bx;
3574   4                            par_buf[7]=c;
3575   4                          par_buf[8]=d;
3576   4                          par_buf[9]=e;
3577   4      
3578   4                             EA=0;
3579   4                           erase_par();
3580   4                         write_par();     //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
3581   4                            EA=1;
3582   4                  SBUF0 = 'R';           while(!TI0);TI0 = 0;
3583   4                      SBUF0 = 'E';             while(!TI0);TI0 = 0;
3584   4                      SBUF0 = par_buf[5]+0x30; while(!TI0);TI0 = 0;
3585   4                      SBUF0 = par_buf[6]+0x30; while(!TI0);TI0 = 0;
3586   4                      SBUF0 = '.';             while(!TI0);TI0 = 0;
3587   4                      SBUF0 = par_buf[7]+0x30; while(!TI0);TI0 = 0;
3588   4                      SBUF0 = par_buf[8]+0x30; while(!TI0);TI0 = 0;
3589   4                      SBUF0 = par_buf[9]+0x30; while(!TI0);TI0 = 0;
3590   4                      SBUF0 = 0x0d;            while(!TI0);TI0 = 0;
3591   4                      SBUF0 = 0x0a;            while(!TI0);TI0 = 0;
3592   4                      delay1s();
3593   4                      delay1s();
3594   4                      trans0("DT\r\n");
3595   4                        delay1s();
3596   4                      delay1s();
3597   4      
3598   4                        find_key = 0;
3599   4                        delay1s();
3600   4      
3601   4      
3602   4                        }
3603   3      
3604   3              }
3605   2              break;
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 59  

3606   2                 case 3:     //è¾“å‡ºæ§åˆ¶æ–¹å¼ï¼ˆå•ç‚¹æˆ–èŒƒå›´ï¼‰
3607   2      
3608   2                m_init();
3609   2                m_send(0x01,get_stroke('3'));
3610   2                m_send(0x02,get_stroke('-'));
3611   2                m_send(0x03,get_stroke('O'));
3612   2                m_send(0x04,get_stroke('P'));
3613   2                m_send(0x05,get_stroke('T'));
3614   2                  find_key=1;
3615   2      
3616   2              if  (enter_flag==1)
3617   2              {
3618   3                 a=par_buf[34];
3619   3                       up_flag = a;
3620   3                        enter_flag=0;
3621   3      
3622   3                       do
3623   3                 {
3624   4                   PCA0CPH4 = 0xa0;
3625   4                        if (up_flag==1)
3626   4                            {
3627   5                              a=1;
3628   5                            }
3629   4                       else if (up_flag==2)
3630   4                        {
3631   5                          a=2;
3632   5                          }
3633   4                  else if (up_flag==3)
3634   4                        {
3635   5                          a=3;
3636   5                          }
3637   4                            else if (up_flag==4)
3638   4                        {
3639   5                          a=1;up_flag=1;
3640   5                          }
3641   4      
3642   4      
3643   4                           m_init();
3644   4                           m_send(0x01,get_stroke(a));
3645   4                           m_send(0x02,get_stroke(' '));
3646   4                           m_send(0x03,get_stroke(' '));
3647   4                           m_send(0x04,get_stroke(' '));
3648   4                           m_send(0x05,get_stroke(' '));
3649   4                           }
3650   3                while(enter_flag==0);
3651   3                {
3652   4      
3653   4      
3654   4                           key_flag_init();
3655   4      
3656   4                   par_buf[34]=a;
3657   4      
3658   4                    EA=0;
3659   4                   erase_par();
3660   4                         write_par();     //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
3661   4      
3662   4                  EA=1;
3663   4                        find_key = 0;
3664   4                              delay1s();//ç­‰å¾…UART0æ¥æ”¶æ•°æ®ï¼Œå¦åˆ™ä¼šæ˜¾ç¤ºä¹±ç 
3665   4      
3666   4                        }
3667   3      
3668   3              }
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 60  

3669   2              break;
3670   2      
3671   2              case 4:
3672   2      
3673   2      
3674   2                    m_init();
3675   2                m_send(0x01,get_stroke('4'));
3676   2                m_send(0x02,get_stroke('-'));
3677   2                m_send(0x03,get_stroke('-'));
3678   2                m_send(0x04,get_stroke('D'));
3679   2                m_send(0x05,get_stroke('L'));
3680   2               find_key=1;
3681   2                     a=par_buf[15];
3682   2                       bx=par_buf[16];
3683   2                       c=par_buf[17];
3684   2                     d=par_buf[18];
3685   2                     e=par_buf[19];
3686   2              if  (enter_flag==1)
3687   2              {
3688   3                shift_right_flag=1;
3689   3                        up_flag=0;
3690   3                        enter_flag=0;
3691   3                display();
3692   3                 do
3693   3                            {
3694   4                         PCA0CPH4 = 0xa0;
3695   4                              shift0_5(); //æ˜¾ç¤º5ä½
3696   4      
3697   4                           }
3698   3                           while  (enter_flag==0);
3699   3                          {
3700   4      
3701   4                           key_flag_init();
3702   4      
3703   4                         display();
3704   4                            par_buf[15]=a;
3705   4                            par_buf[16]=bx;
3706   4                            par_buf[17]=c;
3707   4                          par_buf[18]=d;
3708   4                          par_buf[19]=e;
3709   4      
3710   4                     EA=0;
3711   4                           erase_par();
3712   4                         write_par();     //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
3713   4                  EA=1;
3714   4                        find_key = 0;
3715   4                            delay1s();
3716   4                        }
3717   3      
3718   3              }
3719   2              break;
3720   2      
3721   2          case 5:
3722   2      
3723   2                m_init();
3724   2                m_send(0x01,get_stroke('5'));
3725   2                m_send(0x02,get_stroke('-'));
3726   2                m_send(0x03,get_stroke('-'));
3727   2                m_send(0x04,get_stroke('D'));
3728   2                m_send(0x05,get_stroke('H'));
3729   2                find_key=1;
3730   2                     a=par_buf[10];
3731   2                       bx=par_buf[11];
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 61  

3732   2                       c=par_buf[12];
3733   2                     d=par_buf[13];
3734   2                     e=par_buf[14];
3735   2              if  (enter_flag==1)
3736   2              {
3737   3                shift_right_flag=1;
3738   3                        up_flag=0;
3739   3                        enter_flag=0;
3740   3                display();
3741   3                 do
3742   3                            {
3743   4                         PCA0CPH4 = 0xa0;
3744   4                              shift0_5(); //æ˜¾ç¤º5ä½
3745   4      
3746   4                           }
3747   3                           while  (enter_flag==0);
3748   3                          {
3749   4      
3750   4                            key_flag_init();
3751   4      
3752   4                         display();
3753   4                            par_buf[10]=a;
3754   4                            par_buf[11]=bx;
3755   4                            par_buf[12]=c;
3756   4                          par_buf[13]=d;
3757   4                          par_buf[14]=e;
3758   4      
3759   4                     EA=0;
3760   4                           erase_par();
3761   4                         write_par();     //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
3762   4      
3763   4      
3764   4                    EA=1;
3765   4                             find_key = 0;
3766   4                         delay1s();
3767   4                        }
3768   3      
3769   3              }
3770   2              break;
3771   2      
3772   2      
3773   2                 case 6:
3774   2      
3775   2                m_init();
3776   2                m_send(0x01,get_stroke('6'));
3777   2                m_send(0x02,get_stroke('-'));
3778   2                m_send(0x03,get_stroke('-'));
3779   2                m_send(0x04,get_stroke('A'));
3780   2                m_send(0x05,get_stroke('H'));
3781   2                    find_key = 1;
3782   2      
3783   2                     a=par_buf[21];
3784   2                       bx=par_buf[22];
3785   2                       c=par_buf[23];
3786   2                     d=par_buf[24];
3787   2                     e=par_buf[25];
3788   2      
3789   2              if  (enter_flag==1)
3790   2              {
3791   3                shift_right_flag=1;
3792   3                        up_flag=0;
3793   3                        enter_flag=0;
3794   3                display();
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 62  

3795   3                 do
3796   3                            {
3797   4                          PCA0CPH4 = 0xa0;
3798   4                              shift0_5(); //æ˜¾ç¤º5ä½
3799   4      
3800   4                           }
3801   3                           while  (enter_flag==0);
3802   3                          {
3803   4      
3804   4                            key_flag_init();
3805   4      
3806   4                         display();
3807   4                            par_buf[21]=a;
3808   4                            par_buf[22]=bx;
3809   4                            par_buf[23]=c;
3810   4                          par_buf[24]=d;
3811   4                          par_buf[25]=e;
3812   4      
3813   4                    EA=0;
3814   4                           erase_par();
3815   4                         write_par();     //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
3816   4                    EA=1;
3817   4                               find_key = 0;
3818   4                                 delay1s();
3819   4      
3820   4      
3821   4                        }
3822   3      
3823   3              }
3824   2              break;
3825   2             case 7:    //ç»§ç”µå™¨è¾“å‡ºé€‰æ‹©
3826   2      
3827   2                m_init();
3828   2                m_send(0x01,get_stroke('7'));
3829   2                m_send(0x02,get_stroke('-'));
3830   2                m_send(0x03,get_stroke('R'));
3831   2                m_send(0x04,get_stroke('L'));
3832   2                m_send(0x05,get_stroke('Y'));
3833   2      
3834   2                     find_key=1;
3835   2              if  (enter_flag==1)
3836   2              {
3837   3                 a=par_buf[35];
3838   3                       up_flag = a;
3839   3                        enter_flag=0;
3840   3      
3841   3                       do
3842   3                 {
3843   4                   PCA0CPH4 = 0xa0;
3844   4                        if (up_flag==0)
3845   4                            {
3846   5                              a=0;
3847   5                            }
3848   4                       else if (up_flag==1)
3849   4                        {
3850   5                          a=1;
3851   5                          }
3852   4      
3853   4                            else if (up_flag==2)
3854   4                        {
3855   5                          a=0;up_flag=0;
3856   5                          }
3857   4      
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 63  

3858   4      
3859   4                            m_init();
3860   4                m_send(0x01,get_stroke(a));
3861   4                m_send(0x02,get_stroke(' '));
3862   4                m_send(0x03,get_stroke(' '));
3863   4                m_send(0x04,get_stroke(' '));
3864   4                m_send(0x05,get_stroke(' '));
3865   4                           }
3866   3                while(enter_flag==0);
3867   3                {
3868   4                   par_buf[35]=a;
3869   4      
3870   4                           key_flag_init();
3871   4      
3872   4                   EA=0;
3873   4                   erase_par();
3874   4                         write_par();     //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
3875   4                            EA=1;
3876   4                    find_key = 0;
3877   4                              delay1s();
3878   4      
3879   4      
3880   4      
3881   4                        }
3882   3      
3883   3              }
3884   2              break;
3885   2              case 8:    //PNPè¾“å‡ºé€‰æ‹©
3886   2      
3887   2                m_init();
3888   2                m_send(0x01,get_stroke('8'));
3889   2                m_send(0x02,get_stroke('-'));
3890   2                m_send(0x03,get_stroke('-'));
3891   2                m_send(0x04,get_stroke('P'));
3892   2                m_send(0x05,get_stroke('0'));
3893   2                find_key=1;
3894   2      
3895   2      
3896   2              if  (enter_flag==1)
3897   2              {
3898   3                 a=par_buf[36];
3899   3                       up_flag = a;
3900   3                        enter_flag=0;
3901   3      
3902   3                       do
3903   3                 {
3904   4                   PCA0CPH4 = 0xa0;
3905   4                        if (up_flag==0)
3906   4                            {
3907   5                              a=0;
3908   5                            }
3909   4                       else if (up_flag==1)
3910   4                        {
3911   5                          a=1;
3912   5                          }
3913   4      
3914   4                            else if (up_flag==2)
3915   4                        {
3916   5                          a=0;up_flag=0;
3917   5                          }
3918   4      
3919   4      
3920   4                            m_init();
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 64  

3921   4                m_send(0x01,get_stroke(a));
3922   4                m_send(0x02,get_stroke(' '));
3923   4                m_send(0x03,get_stroke(' '));
3924   4                m_send(0x04,get_stroke(' '));
3925   4                m_send(0x05,get_stroke(' '));
3926   4                           }
3927   3                while(enter_flag==0);
3928   3                {
3929   4                   par_buf[36]=a;
3930   4      
3931   4                           key_flag_init();
3932   4      
3933   4                   EA=0;
3934   4                   erase_par();
3935   4                         write_par();     //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
3936   4                    EA=1;
3937   4                  find_key = 0;
3938   4                              delay1s();
3939   4      
3940   4      
3941   4                        }
3942   3      
3943   3              }
3944   2              break;
3945   2              case 9:    //RS232/RS485é€‰æ‹©
3946   2      
3947   2                m_init();
3948   2                m_send(0x01,get_stroke('9'));
3949   2                m_send(0x02,get_stroke('-'));
3950   2                m_send(0x03,get_stroke('-'));
3951   2                m_send(0x04,get_stroke('C'));
3952   2                m_send(0x05,get_stroke('P'));
3953   2                  find_key=1;
3954   2      
3955   2              if  (enter_flag==1)
3956   2              {
3957   3                 a=par_buf[37];
3958   3                       up_flag = a;
3959   3                        enter_flag=0;
3960   3      
3961   3                       do
3962   3                 {
3963   4                   PCA0CPH4 = 0xa0;
3964   4                        if (up_flag==0)
3965   4                            {
3966   5                              a=0;
3967   5                            }
3968   4                       else if (up_flag==1)
3969   4                        {
3970   5                          a=1;
3971   5                          }
3972   4      
3973   4                            else if (up_flag==2)
3974   4                        {
3975   5                          a=0;up_flag=0;
3976   5                          }
3977   4      
3978   4      
3979   4                            m_init();
3980   4                m_send(0x01,get_stroke(a));
3981   4                m_send(0x02,get_stroke(' '));
3982   4                m_send(0x03,get_stroke(' '));
3983   4                m_send(0x04,get_stroke(' '));
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 65  

3984   4                m_send(0x05,get_stroke(' '));
3985   4                           }
3986   3                while(enter_flag==0);
3987   3                {
3988   4                   par_buf[37]=a;
3989   4      
3990   4                           key_flag_init();
3991   4      
3992   4                    EA=0;
3993   4                   erase_par();
3994   4                         write_par();     //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
3995   4                  EA=1;
3996   4                      find_key = 0;
3997   4                              delay1s();
3998   4      
3999   4                        }
4000   3      
4001   3              }
4002   2              break;
4003   2              case 10:    //ADD
4004   2      
4005   2                m_init();
4006   2                m_send(0x01,get_stroke('1'));
4007   2                m_send(0x02,get_stroke('0'));
4008   2                m_send(0x03,get_stroke('-'));
4009   2                m_send(0x04,get_stroke('-'));
4010   2                m_send(0x05,get_stroke('A'));
4011   2      
4012   2                find_key=1;
4013   2      
4014   2              if  (enter_flag==1)
4015   2              {
4016   3                 a=par_buf[20];
4017   3                 bx=par_buf[20]/10;
4018   3                 c=par_buf[20]%10;
4019   3                        shift_right_flag=1;
4020   3                        up_flag=0;
4021   3                        enter_flag=0;
4022   3                display_add();
4023   3                 do
4024   3                            {
4025   4                          PCA0CPH4 = 0xa0;
4026   4                              shift_add();  //æ˜¾ç¤º2ä½
4027   4      
4028   4                           }
4029   3                           while  (enter_flag==0);
4030   3                          {
4031   4      
4032   4                            key_flag_init();
4033   4      
4034   4                         display_add();
4035   4                           a=bx*10+c;
4036   4      
4037   4                           if (a<=25)//A-Z(65-90)
4038   4                         {
4039   5                        par_buf[20]=a;
4040   5                   EA=0;
4041   5                           erase_par();
4042   5                         write_par();     //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
4043   5                            EA=1;
4044   5                           }
4045   4      
4046   4                              find_key = 0;
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 66  

4047   4                    delay1s();
4048   4      
4049   4      
4050   4      
4051   4                        }
4052   3      
4053   3              }
4054   2              break;
4055   2               case 11:
4056   2      
4057   2                m_init();
4058   2                m_send(0x01,get_stroke('1'));
4059   2                m_send(0x02,get_stroke('1'));
4060   2                m_send(0x03,get_stroke('-'));
4061   2                m_send(0x04,get_stroke('U'));
4062   2                m_send(0x05,get_stroke('R'));
4063   2      
4064   2               find_key=1;
4065   2      
4066   2              if  (enter_flag==1)
4067   2              {
4068   3      
4069   3                       enter_flag=0;
4070   3      
4071   3                       do
4072   3                 {
4073   4                            m_init();
4074   4                m_send(0x01,get_stroke(' '));
4075   4                m_send(0x02,(get_stroke(version_major-0x30)|0x80));  //Display Version Number
4076   4                m_send(0x03,get_stroke(version_minor-0x30));
4077   4                m_send(0x04,get_stroke(' '));
4078   4                m_send(0x05,get_stroke(' '));
4079   4                           }
4080   3                while(enter_flag==0);
4081   3                {
4082   4                           key_flag_init();
4083   4      
4084   4                  find_key = 0;
4085   4                   delay1s();
4086   4      
4087   4      
4088   4      
4089   4      
4090   4                        }
4091   3      
4092   3              }
4093   2              break;
4094   2      
4095   2      
4096   2          default: break;
4097   2        }
4098   1      }
4099          
4100          void display(void)
4101          {
4102   1       m_init();
4103   1      m_send(0x01,get_stroke(a));
4104   1      m_send(0x02,(get_stroke(bx)|0x80));
4105   1      m_send(0x03,get_stroke(c));
4106   1      m_send(0x04,get_stroke(d));
4107   1      m_send(0x05,get_stroke(e));
4108   1      }
4109          
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 67  

4110          void display_add(void)
4111          {
4112   1       m_init();
4113   1      m_send(0x01,get_stroke(bx));
4114   1      m_send(0x02,get_stroke(c));
4115   1      m_send(0x03,get_stroke(' '));
4116   1      m_send(0x04,get_stroke(' '));
4117   1      m_send(0x05,get_stroke(' '));
4118   1      }
4119          void  shift_add(void)
4120          {
4121   1          if (shift_right_flag==1)      //ç¬¬ä¸€ä½é—ªçƒ
4122   1          {
4123   2      
4124   2            up_flag=bx;
4125   2          do
4126   2          { PCA0CPH4 = 0xa0;
4127   3            switch(up_flag)
4128   3            {
4129   4                case 0: bx=0; break;
4130   4              case 1: bx=1; break;
4131   4              case 2: bx=2; break;
4132   4              case 3: bx=3; break;
4133   4              case 4: bx=4; break;
4134   4              case 5: bx=5; break;
4135   4              case 6: bx=6; break;
4136   4              case 7: bx=7; break;
4137   4              case 8: bx=8; break;
4138   4              case 9: bx=9; break;
4139   4              case 10: bx=0; break;
4140   4                  }
4141   3            disp_emissivity_2();
4142   3               }
4143   2            while ( (shift_right_flag==1)&&(enter_flag==0) );
4144   2          }
4145   1          else if (shift_right_flag==2)
4146   1          {
4147   2             up_flag=c;
4148   2             do
4149   2           {
4150   3            PCA0CPH4 = 0xa0;
4151   3            switch(up_flag)
4152   3            {
4153   4                case 0: c=0; break;
4154   4              case 1: c=1; break;
4155   4              case 2: c=2; break;
4156   4              case 3: c=3; break;
4157   4              case 4: c=4; break;
4158   4              case 5: c=5; break;
4159   4              case 6: c=6; break;
4160   4              case 7: c=7; break;
4161   4              case 8: c=8; break;
4162   4              case 9: c=9; break;
4163   4              case 10: c=0; break;
4164   4                  }
4165   3            disp_emissivity_2();
4166   3               }
4167   2            while ( (shift_right_flag==2)&&(enter_flag==0) );
4168   2         }
4169   1      
4170   1         else if (shift_right_flag==3)
4171   1         {
4172   2          shift_right_flag=1;
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 68  

4173   2         }
4174   1      }
4175          void disp_emissivity_2(void)
4176          {
4177   1         if (shift_right_flag==1)     //ç¬¬ä¸€ä½é—ªçƒæ˜¾ç¤º
4178   1         {
4179   2             disp_emissivity0_2();
4180   2            // delay(100);
4181   2           delay1s();
4182   2      
4183   2          m_init();
4184   2          m_send(0x01,get_stroke(' '));
4185   2          m_send(0x02,get_stroke(c));
4186   2          m_send(0x03,get_stroke(' '));
4187   2          m_send(0x04,get_stroke(' '));
4188   2          m_send(0x05,get_stroke(' '));
4189   2          // delay(100);
4190   2           delay1s();
4191   2      
4192   2            }
4193   1        else if (shift_right_flag==2)       //ç¬¬äºŒä½é—ªçƒæ˜¾ç¤º
4194   1        {
4195   2             disp_emissivity0_2();
4196   2          // delay(100);
4197   2           delay1s();
4198   2      
4199   2          m_init();
4200   2          m_send(0x01,get_stroke(bx));
4201   2          m_send(0x02,get_stroke(' '));
4202   2          m_send(0x03,get_stroke(' '));
4203   2          m_send(0x04,get_stroke(' '));
4204   2          m_send(0x05,get_stroke(' '));
4205   2        //   delay(100);
4206   2          delay1s();
4207   2      
4208   2            }
4209   1      
4210   1          else if (shift_right_flag==3)
4211   1          {
4212   2                   shift_right_flag=1;
4213   2             }
4214   1      }
4215          
4216          
4217          void disp_emissivity0_2(void)     //æ­£å¸¸æ˜¾ç¤ºï¼Œä¸é—ª
4218          {
4219   1          m_init();
4220   1        m_send(0x01,get_stroke(bx));
4221   1        m_send(0x02,get_stroke(c));
4222   1        m_send(0x03,get_stroke(' '));
4223   1        m_send(0x04,get_stroke(' '));
4224   1        m_send(0x05,get_stroke(' '));
4225   1      }
4226          void  shift0_5(void)
4227          {
4228   1          if (shift_right_flag==1)      //ç¬¬ä¸€ä½é—ªçƒ
4229   1          {
4230   2             up_flag=a;
4231   2             do
4232   2           {
4233   3              PCA0CPH4 = 0xa0;
4234   3            switch(up_flag)
4235   3            {
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 69  

4236   4                case 0: a=0; break;
4237   4              case 1: a=1; break;
4238   4              case 2: a=2; break;
4239   4              case 3: a=3; break;
4240   4              case 4: a=4; break;
4241   4              case 5: a=5; break;
4242   4              case 6: a=6; break;
4243   4              case 7: a=7; break;
4244   4              case 8: a=8; break;
4245   4              case 9: a=9; break;
4246   4              case 10: a=0; break;
4247   4                  }
4248   3            disp_emissivity_5();
4249   3            }
4250   2                while ( (shift_right_flag==1)&&(enter_flag==0) );
4251   2          }
4252   1          else if (shift_right_flag==2)     //ç¬¬äºŒä½é—ªçƒ
4253   1          {
4254   2            up_flag=bx;
4255   2          do
4256   2          { PCA0CPH4 = 0xa0;
4257   3            switch(up_flag)
4258   3            {
4259   4                case 0: bx=0; break;
4260   4              case 1: bx=1; break;
4261   4              case 2: bx=2; break;
4262   4              case 3: bx=3; break;
4263   4              case 4: bx=4; break;
4264   4              case 5: bx=5; break;
4265   4              case 6: bx=6; break;
4266   4              case 7: bx=7; break;
4267   4              case 8: bx=8; break;
4268   4              case 9: bx=9; break;
4269   4              case 10: bx=0; break;
4270   4                  }
4271   3            disp_emissivity_5();
4272   3               }
4273   2            while ( (shift_right_flag==2)&&(enter_flag==0) );
4274   2          }
4275   1          else if (shift_right_flag==3)
4276   1          {
4277   2             up_flag=c;
4278   2             do
4279   2           {
4280   3            PCA0CPH4 = 0xa0;
4281   3            switch(up_flag)
4282   3            {
4283   4                case 0: c=0; break;
4284   4              case 1: c=1; break;
4285   4              case 2: c=2; break;
4286   4              case 3: c=3; break;
4287   4              case 4: c=4; break;
4288   4              case 5: c=5; break;
4289   4              case 6: c=6; break;
4290   4              case 7: c=7; break;
4291   4              case 8: c=8; break;
4292   4              case 9: c=9; break;
4293   4              case 10: c=0; break;
4294   4                  }
4295   3            disp_emissivity_5();
4296   3               }
4297   2            while ( (shift_right_flag==3)&&(enter_flag==0) );
4298   2         }
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 70  

4299   1        else if (shift_right_flag==4)
4300   1        {
4301   2             up_flag=d;
4302   2             do
4303   2           {
4304   3            PCA0CPH4 = 0xa0;
4305   3            switch(up_flag)
4306   3            {
4307   4                case 0: d=0; break;
4308   4              case 1: d=1; break;
4309   4              case 2: d=2; break;
4310   4              case 3: d=3; break;
4311   4              case 4: d=4; break;
4312   4              case 5: d=5; break;
4313   4              case 6: d=6; break;
4314   4              case 7: d=7; break;
4315   4              case 8: d=8; break;
4316   4              case 9: d=9; break;
4317   4              case 10: d=0; break;
4318   4                  }
4319   3            disp_emissivity_5();
4320   3               }
4321   2            while ( (shift_right_flag==4)&&(enter_flag==0) );
4322   2         }
4323   1          else if (shift_right_flag==5)
4324   1        {
4325   2             up_flag=e;
4326   2             do
4327   2           {
4328   3              PCA0CPH4 = 0xa0;
4329   3            switch(up_flag)
4330   3            {
4331   4                case 0: e=0; break;
4332   4              case 1: e=1; break;
4333   4              case 2: e=2; break;
4334   4              case 3: e=3; break;
4335   4              case 4: e=4; break;
4336   4              case 5: e=5; break;
4337   4              case 6: e=6; break;
4338   4              case 7: e=7; break;
4339   4              case 8: e=8; break;
4340   4              case 9: e=9; break;
4341   4              case 10: e=0; break;
4342   4                  }
4343   3            disp_emissivity_5();
4344   3               }
4345   2            while ( (shift_right_flag==5)&&(enter_flag==0) );
4346   2         }
4347   1         else if (shift_right_flag==6)
4348   1         {
4349   2          shift_right_flag=1;
4350   2         }
4351   1      }
4352          
4353          
4354          void disp_emissivity_5(void)
4355          {
4356   1         if (shift_right_flag==1)     //ç¬¬ä¸€ä½é—ªçƒæ˜¾ç¤º
4357   1         {
4358   2             disp_emissivity0_5();
4359   2            // delay(100);
4360   2           delay1s();
4361   2      
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 71  

4362   2          m_init();
4363   2          m_send(0x01,get_stroke(' '));
4364   2          m_send(0x02,(get_stroke(bx)|0x80));
4365   2          m_send(0x03,get_stroke(c));
4366   2          m_send(0x04,get_stroke(d));
4367   2          m_send(0x05,get_stroke(e));
4368   2          // delay(100);
4369   2           delay1s();
4370   2      
4371   2            }
4372   1        else if (shift_right_flag==2)       //ç¬¬äºŒä½é—ªçƒæ˜¾ç¤º
4373   1        {
4374   2             disp_emissivity0_5();
4375   2          // delay(100);
4376   2           delay1s();
4377   2      
4378   2          m_init();
4379   2          m_send(0x01,get_stroke(a));
4380   2          m_send(0x02,(get_stroke(' ')|0x80));
4381   2          m_send(0x03,get_stroke(c));
4382   2          m_send(0x04,get_stroke(d));
4383   2          m_send(0x05,get_stroke(e));
4384   2        //   delay(100);
4385   2          delay1s();
4386   2      
4387   2            }
4388   1          else if (shift_right_flag==3)     //ç¬¬ä¸‰ä½é—ªçƒæ˜¾ç¤º
4389   1          {
4390   2               disp_emissivity0_5();
4391   2           //  delay(100);
4392   2             delay1s();
4393   2             m_init();
4394   2      
4395   2          m_send(0x01,get_stroke(a));
4396   2          m_send(0x02,(get_stroke(bx)|0x80));
4397   2          m_send(0x03,get_stroke(' '));
4398   2          m_send(0x04,get_stroke(d));
4399   2          m_send(0x05,get_stroke(e));
4400   2           //  delay(100);
4401   2             delay1s();
4402   2      
4403   2        }
4404   1        else if (shift_right_flag==4)     //ç¬¬4ä½é—ªçƒæ˜¾ç¤º
4405   1         {
4406   2               disp_emissivity0_5();
4407   2            // delay(100);
4408   2            delay1s();
4409   2      
4410   2             m_init();
4411   2          m_send(0x01,get_stroke(a));
4412   2          m_send(0x02,(get_stroke(bx)|0x80));
4413   2          m_send(0x03,get_stroke(c));
4414   2          m_send(0x04,get_stroke(' '));
4415   2          m_send(0x05,get_stroke(e));
4416   2           //  delay(100);
4417   2             delay1s();
4418   2      
4419   2        }
4420   1        else if (shift_right_flag==5)
4421   1        {
4422   2              disp_emissivity0_5();
4423   2          //   delay(100);
4424   2            delay1s();
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 72  

4425   2      
4426   2             m_init();
4427   2          m_send(0x01,get_stroke(a));
4428   2          m_send(0x02,(get_stroke(bx)|0x80));
4429   2          m_send(0x03,get_stroke(c));
4430   2          m_send(0x04,get_stroke(d));
4431   2          m_send(0x05,get_stroke(' '));
4432   2           //  delay(100);
4433   2            delay1s();
4434   2      
4435   2        }
4436   1          else if (shift_right_flag==6)
4437   1          {
4438   2                   shift_right_flag=1;
4439   2             }
4440   1      }
4441          
4442          
4443          void disp_emissivity0_5(void)     //æ­£å¸¸æ˜¾ç¤ºï¼Œä¸é—ª
4444          {
4445   1          m_init();
4446   1        m_send(0x01,get_stroke(a));
4447   1        m_send(0x02,(get_stroke(bx)|0x80));
4448   1        m_send(0x03,get_stroke(c));
4449   1        m_send(0x04,get_stroke(d));
4450   1        m_send(0x05,get_stroke(e));
4451   1      }
4452          
4453          char data receive0[10]={' ',' ',' ',' ',' ',' ',' ',' ',' ',' '};
4454          
4455          bit nors=0;
4456          bit err_flag=0;
4457          bit uart0_rcv_ok= 0;
4458          void uart0(void) interrupt 4
4459          {
4460   1        uchar  i;
4461   1      
4462   1      
4463   1        if(RI0==1)
4464   1          {
4465   2          for(i=0;i<10;i++)
4466   2          {
4467   3            while(!RI0)
4468   3            { PCA0CPH4 = 0xa0; }
4469   3      
4470   3            receive0[i] = SBUF0;
4471   3            RI0 = 0;
4472   3      
4473   3            if(receive0[i]==0x0a)
4474   3            {
4475   4               uart0_rcv_ok =1;
4476   4            //  ES0 = 0;
4477   4              break;
4478   4            }
4479   3              }
4480   2       }
4481   1      }
4482          
4483          void direct_uart0(void)
4484          {
4485   1          uchar  i, rd1,rd2,rd3,rd4,rd5;
4486   1         if(find_key!=0)return;
4487   1         if(uart0_rcv_ok==0)return;
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 73  

4488   1          uart0_rcv_ok=0;
4489   1      
4490   1      
4491   1      
4492   1          if((receive0[3]=='.')&&(receive0[0]>=0x30)&&(receive0[0]<=0x39)&&(receive0[1]>=0x30)&&(receive0[1]<=0x
             -39)&&(receive0[2]>=0x30)&&(receive0[2]<=0x39)&&(receive0[4]>=0x30)&&(receive0[4]<=0x39)&&(receive0[5]>=0x30)&&(receive0[
             -5]<=0x39)&&(receive0[6]>=0x30)&&(receive0[6]<=0x39) )
4493   1          {
4494   2            err_flag=0;
4495   2      
4496   2      
4497   2            receive0[0]=receive0[0]-0x30;
4498   2            receive0[1]=receive0[1]-0x30;
4499   2            receive0[2]=receive0[2]-0x30;
4500   2            receive0[4]=receive0[4]-0x30;
4501   2            receive0[5]=receive0[5]-0x30;
4502   2            receive0[6]=receive0[6]-0x30;
4503   2      
4504   2      
4505   2                  rd1 = receive0[1];
4506   2                  rd2 = receive0[2];
4507   2                  rd3 = receive0[4];
4508   2                  rd4 = receive0[5];
4509   2                  rd5 = receive0[6];
4510   2      
4511   2      //            now_val = rd1*10000+rd2*1000+rd3*100+rd4*10+rd5;  // original code-- intermediate values are
             - not unsigned long int!
4512   2                  now_val = rd1;
4513   2                  now_val = now_val*10 + rd2;
4514   2                  now_val = now_val*10 + rd3;
4515   2                  now_val = now_val*10 + rd4;
4516   2                  now_val = now_val*10 + rd5;
4517   2      
4518   2                  rd1 = rd1+0x30;
4519   2                  rd2 = rd2+0x30;
4520   2                  rd3 = rd3+0x30;
4521   2                  rd4 = rd4+0x30;
4522   2                  rd5 = rd5+0x30;
4523   2      
4524   2                   m_init();
4525   2                       m_send(0x01,get_stroke(rd1));
4526   2                       m_send(0x02,(get_stroke(rd2))|0x80);
4527   2                       m_send(0x03,get_stroke(rd3));
4528   2                       m_send(0x04,get_stroke(rd4));
4529   2                       m_send(0x05,get_stroke(rd5));
4530   2      
4531   2          }
4532   1      
4533   1               else
4534   1            {
4535   2      
4536   2                for(i=0;i<10;i++)
4537   2                {
4538   3                 receive0_temp[i]=receive0[i];
4539   3               }
4540   2               if(receive0_temp[0]=='+')
4541   2              {
4542   3      
4543   3              m_init();
4544   3              m_send(0x01,get_stroke(receive0_temp[1]));
4545   3              m_send(0x02,get_stroke(receive0_temp[2]));
4546   3              m_send(0x03,0x63);
4547   3              m_send(0x04,0x00);
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 74  

4548   3              m_send(0x05,0x00);
4549   3      
4550   3      
4551   3              }
4552   2            else if(receive0_temp[0]=='E')
4553   2            {
4554   3               err_flag=1;
4555   3              m_init();
4556   3              m_send(0x01,get_stroke(receive0_temp[0]));
4557   3              m_send(0x02,get_stroke(receive0_temp[1]));
4558   3              m_send(0x03,get_stroke(receive0_temp[2]));
4559   3              m_send(0x04,get_stroke(receive0_temp[3]));
4560   3              m_send(0x05,get_stroke(receive0_temp[4]));
4561   3               }
4562   2               }
4563   1      
4564   1      
4565   1      
4566   1          alarm_state();
4567   1      
4568   1      
4569   1      }
4570          
4571          
4572          
4573          
4574          void alarm_state(void)
4575          
4576          {
4577   1      
4578   1        ulint idata alarm_over_vhh,alarm_over_vll;
4579   1        ulint idata alarm_low_vhh,alarm_low_vll;
4580   1        ulint idata upper_val,lower_val;
4581   1      
4582   1        UP=(par_buf[10]*1000+par_buf[11]*100+par_buf[12]*10+par_buf[13])*10+par_buf[14];
4583   1        LO=(par_buf[15]*1000+par_buf[16]*100+par_buf[17]*10+par_buf[18])*10+par_buf[19];
4584   1        AH = (par_buf[21]*1000+par_buf[22]*100+par_buf[23]*10+par_buf[24])*10+par_buf[25];
4585   1      
4586   1        CTR = par_buf[34];
4587   1      
4588   1      
4589   1      
4590   1      //ç»§ç”µå™¨ä½œä¸ºå‡ºé”™æ—¶æŠ¥è­¦
4591   1         if(par_buf[35]==1)
4592   1            {
4593   2            if(err_flag==1)
4594   2              {
4595   3      
4596   3             ALARM  = 0;
4597   3             delay1s();
4598   3             ALARM  = 1;
4599   3               delay1s();
4600   3               OUT0=1;
4601   3             }
4602   2           else
4603   2           {
4604   3             OUT0=0;
4605   3               }
4606   2          }
4607   1      
4608   1      
4609   1      //ç»§ç”µå™¨ä½œä¸ºè·ç¦»æŠ¥è­¦
4610   1       else if(par_buf[35]==0)
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 75  

4611   1        {
4612   2        if(err_flag==1)
4613   2              {
4614   3      
4615   3             ALARM  = 0;
4616   3             delay1s();
4617   3             ALARM  = 1;
4618   3               delay1s();
4619   3              OUT0 =1;
4620   3             }
4621   2         else if (err_flag==0)
4622   2         {
4623   3          if(CTR ==1)
4624   3         {
4625   4           upper_val = LO+(AH/2);
4626   4           lower_val = LO-(AH/2);
4627   4      
4628   4         if(now_val>=upper_val)
4629   4         {
4630   5          OUT0 = 1;
4631   5         // OUT1 = 1;
4632   5         ALARM  = 1;
4633   5         }
4634   4      
4635   4         else if(now_val<=lower_val)
4636   4          {
4637   5            OUT0 = 0;
4638   5          //  OUT1 = 0;
4639   5            ALARM = 0;
4640   5        //   OUT3=!OUT3;
4641   5          }
4642   4      
4643   4        }
4644   3      
4645   3      
4646   3        else if(CTR ==2)
4647   3        {
4648   4        alarm_over_vhh = UP+AH/2;
4649   4        alarm_over_vll = UP-AH/2;
4650   4        alarm_low_vhh  = LO+AH/2;
4651   4        alarm_low_vll  = LO-AH/2;
4652   4      
4653   4           if((now_val>=alarm_low_vhh)&&(now_val<=alarm_over_vll))
4654   4           {
4655   5            ALARM = 0;
4656   5          OUT0 = 0;
4657   5         // OUT1 = 0;
4658   5          }
4659   4           else if((now_val<alarm_low_vll)||(now_val>alarm_over_vhh))
4660   4           {
4661   5            ALARM = 1;
4662   5          OUT0 = 1;
4663   5        //  OUT1 = 1;
4664   5          }
4665   4      
4666   4        }
4667   3      else if (CTR ==3)
4668   3      {
4669   4         upper_val = UP+(AH/2);
4670   4         lower_val = UP-(AH/2);
4671   4      
4672   4      
4673   4         if(now_val>=upper_val)
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 76  

4674   4         {
4675   5          OUT0 = 0;
4676   5         // OUT1 = 0;
4677   5         ALARM  = 0;
4678   5         }
4679   4      
4680   4         else if(now_val<=lower_val)
4681   4          {
4682   5            OUT0 = 1;
4683   5          //  OUT1 = 1;
4684   5            ALARM = 1;
4685   5      
4686   5          }
4687   4        }
4688   3        }
4689   2      }
4690   1      
4691   1       //PNPä½œä¸ºå‡ºé”™æ—¶æŠ¥è­¦
4692   1       if(par_buf[36]==1)
4693   1        {
4694   2      
4695   2         if(err_flag==1)
4696   2              {
4697   3      
4698   3             ALARM  = 0;
4699   3             delay1s();
4700   3             ALARM  = 1;
4701   3               delay1s();
4702   3               OUT1=0;
4703   3             }
4704   2           else
4705   2           {
4706   3             OUT1=1;
4707   3               }
4708   2          }
4709   1      
4710   1      
4711   1      
4712   1      //PNPä½œä¸ºè·ç¦»æŠ¥è­¦
4713   1      else if(par_buf[36]==0)
4714   1      {
4715   2       if(err_flag==1)
4716   2              {
4717   3      
4718   3             ALARM  = 0;
4719   3             delay1s();
4720   3             ALARM  = 1;
4721   3               delay1s();
4722   3                OUT1 =0;
4723   3             }
4724   2      
4725   2       else if (err_flag==0)
4726   2       {
4727   3        if(CTR ==1)
4728   3       {
4729   4         upper_val = LO+(AH/2);
4730   4         lower_val = LO-(AH/2);
4731   4      
4732   4         if(now_val>=upper_val)
4733   4         {
4734   5          //OUT0 = 1;
4735   5          OUT1 = 0;
4736   5         ALARM  = 1;
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 77  

4737   5         }
4738   4      
4739   4         else if(now_val<=lower_val)
4740   4          {
4741   5          //  OUT0 = 0;
4742   5            OUT1 = 1;
4743   5            ALARM = 0;
4744   5      
4745   5          }
4746   4      
4747   4        }
4748   3      
4749   3      
4750   3      else if(CTR ==2)
4751   3      {
4752   4        alarm_over_vhh = UP+AH/2;
4753   4        alarm_over_vll = UP-AH/2;
4754   4        alarm_low_vhh  = LO+AH/2;
4755   4        alarm_low_vll  = LO-AH/2;
4756   4      
4757   4           if((now_val>=alarm_low_vhh)&&(now_val<=alarm_over_vll))
4758   4           {
4759   5            ALARM = 0;
4760   5         // OUT0 = 0;
4761   5          OUT1 = 1;
4762   5          }
4763   4           else if((now_val<alarm_low_vll)||(now_val>alarm_over_vhh))
4764   4           {
4765   5            ALARM = 1;
4766   5         // OUT0 = 1;
4767   5          OUT1 = 0;
4768   5          }
4769   4      
4770   4        }
4771   3      else if (CTR ==3)
4772   3      {
4773   4         upper_val = UP+(AH/2);
4774   4         lower_val = UP-(AH/2);
4775   4      
4776   4      
4777   4         if(now_val>=upper_val)
4778   4         {
4779   5          //OUT0 = 0;
4780   5          OUT1 = 1;
4781   5         ALARM  = 0;
4782   5         }
4783   4      
4784   4         else if(now_val<=lower_val)
4785   4          {
4786   5          //  OUT0 = 1;
4787   5            OUT1 = 0;
4788   5            ALARM = 1;
4789   5      
4790   5          }
4791   4        }
4792   3        }
4793   2       }
4794   1      }
4795          
4796          
4797          
4798          void uart1(void) interrupt 16
4799          {
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 78  

4800   1        uchar data i;
4801   1      
4802   1        if((SCON1 & 0x01)==1)
4803   1        {
4804   2            tl0timer0=0;//å®šæ—¶å™¨0ç´¯åŠ æ¸…0
4805   2            SCON1 &= ~0x10;//REN1=0;RI1=0;å…³æ¥æ”¶
4806   2      
4807   2          i=SBUF1;//è¯»æ•°æ®
4808   2      
4809   2          if(uart1_receve_end==0)//ä¸Šæ¬¡çš„æ•°æ®è¿˜æ²¡æœ‰å¤„ç†ï¼Œä¸å†æ¥æ”¶
4810   2          {
4811   3            if(i==0x23)
4812   3            {
4813   4              b_head_sure=1;//æ•°æ®å¸§æ­£ç¡®
4814   4              rcv_count=1;//é‡æ–°è®¡æ•°
4815   4              receive1[0]=i;//ä¿å­˜æ•°æ®
4816   4            }
4817   3            else if(b_head_sure==1)
4818   3            {
4819   4              if(rcv_count<12)//åªæ¥æ”¶12ä¸ªå­—èŠ‚
4820   4              {
4821   5      
4822   5                receive1[rcv_count]=i;//ä¿å­˜æ•°æ®
4823   5      
4824   5                rcv_count++;
4825   5                if(rcv_count==12)
4826   5                {uart1_receve_end=1;
4827   6                b_head_sure=0;}//æ¥æ”¶å®Œæˆ
4828   5              }
4829   4            }
4830   3          }
4831   2         SCON1 |= 0x10;//å¼€å¯æ¥æ”¶REN1=1
4832   2         SCON1 &= ~0x01;//æ¸…é›¶RI1
4833   2      
4834   2        }
4835   1      
4836   1          if((SCON1&0x02)==0x02)//å‘é€æ•°æ®
4837   1        {
4838   2      
4839   2          if(txcount0!=0)//è¿˜æœ‰æ•°æ®éœ€è¦å‘é€
4840   2          {
4841   3            SBUF1=send_buf[txptr0];//è£…æ•°æ®
4842   3            txptr0++;//æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ªåœ°å€
4843   3            txcount0--;//å·²å‘é€æ•°æ®æ•°é‡+1
4844   3          }
4845   2            else//å·²ç»å‘é€å®Œçš„å¤„ç†
4846   2          {
4847   3            if(par_buf[37]==1)
4848   3             {
4849   4            RXEN=1;//å¼€å¯485æ¥æ”¶
4850   4                  DXEN=0;//
4851   4            }
4852   3          tl0timer0=0;//å®šæ—¶å™¨0ç´¯åŠ æ¸…0
4853   3          }
4854   2          SCON1 &= ~0x02;//æ¸…é›¶TI1;
4855   2        }
4856   1      }
4857          void direct_uart1()
4858          {
4859   1        uchar i;
4860   1        uchar data ADD;
4861   1        // uchar check_sum = 0;
4862   1         bit  check_ok  = 0;
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 79  

4863   1         uchar order_val1 = 0;
4864   1         uchar order_val2 = 0;
4865   1      
4866   1          if(tl0timer0<5)return;
4867   1        if(find_key!=0)return;
4868   1        if(uart1_receve_end==0)return;
4869   1           uart1_receve_end = 0;
4870   1      //check_sum=receive1[1]^receive1[2]^receive1[3]^receive1[4]^receive1[5]^receive1[6]^receive1[7]^receive1[8
             -]^receive1[9];
4871   1          ADD = par_buf[20]+0x41;
4872   1         if((receive1[11]==0x0a)&&(receive1[1]==ADD))
4873   1         {
4874   2           check_ok=1;
4875   2      
4876   2         }
4877   1         else
4878   1         {
4879   2            check_ok=0;
4880   2        }
4881   1      
4882   1      
4883   1       if(check_ok==1)
4884   1         {
4885   2            order_val1=receive1[2];
4886   2            order_val2=receive1[3];
4887   2      
4888   2            if (( order_val1=='D')&&(order_val2=='T'))
4889   2          {
4890   3      
4891   3             send_enable = 1;
4892   3                 if(par_buf[37]==1)
4893   3             {
4894   4            send_dt();
4895   4               }
4896   3      
4897   3          }
4898   2          else if ((order_val1=='R')&&(order_val2=='B'))
4899   2          {
4900   3      
4901   3                send_enable = 0;
4902   3            rb1();
4903   3            send_rb();
4904   3      
4905   3          }
4906   2          else if ((order_val1=='R')&&(order_val2=='E'))
4907   2          {
4908   3      
4909   3              send_enable = 0;
4910   3            re1();
4911   3              send_re();
4912   3      
4913   3          }
4914   2          else if ((order_val1=='O')&&(order_val2=='P'))
4915   2          {
4916   3      
4917   3            send_enable = 0;
4918   3            opt();
4919   3            send_opt();
4920   3      
4921   3      
4922   3      
4923   3          }
4924   2          else if ((order_val1=='D')&&(order_val2=='L'))
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 80  

4925   2          {
4926   3      
4927   3            send_enable = 0;
4928   3            dl1();
4929   3            send_dl();
4930   3      
4931   3      
4932   3      
4933   3          }
4934   2          else if ((order_val1=='D')&&(order_val2=='H'))
4935   2          {
4936   3      
4937   3            send_enable = 0;
4938   3            dh1();
4939   3            send_dh();
4940   3          }
4941   2      
4942   2          else if ((order_val1=='A')&&(order_val2=='H'))
4943   2          {
4944   3      
4945   3            send_enable = 0;
4946   3            ah1();
4947   3            send_ah();
4948   3      
4949   3          }
4950   2             else if ((order_val1=='R')&&(order_val2=='L'))
4951   2          {
4952   3      
4953   3            send_enable = 0;
4954   3            rl();
4955   3            send_rl();
4956   3      
4957   3          }
4958   2          else if ((order_val1=='P')&&(order_val2=='O'))
4959   2          {
4960   3      
4961   3            send_enable = 0;
4962   3            po();
4963   3            send_po();
4964   3      
4965   3          }
4966   2          else if ((order_val1=='P')&&(order_val2=='A'))  //æ˜¾ç¤ºå‚æ•°
4967   2          {
4968   3      
4969   3            send_enable = 0;
4970   3      
4971   3            pa();
4972   3      
4973   3      
4974   3          }
4975   2            else if ((order_val1=='P')&&(order_val2=='R'))  //å¤ä½å‚æ•°
4976   2          {
4977   3      
4978   3                send_enable = 0;
4979   3      
4980   3                  EA=0;
4981   3                erase_par();
4982   3                 init_par();
4983   3             EA =1;
4984   3      
4985   3          }
4986   2               for(i=0;i<10;i++)
4987   2         {
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 81  

4988   3           receive1[i]=' ';
4989   3      
4990   3            }
4991   2      
4992   2        }
4993   1      }
4994          void pa(void)
4995          {
4996   1      
4997   1            send_rb();
4998   1                delay1s();
4999   1            send_re();
5000   1                delay1s();
5001   1            send_opt();
5002   1                delay1s();
5003   1            send_dl();
5004   1                delay1s();
5005   1            send_dh();
5006   1                delay1s();
5007   1            send_ah();
5008   1                delay1s();
5009   1            send_rl();
5010   1                delay1s();
5011   1            send_po();
5012   1                delay1s();
5013   1            send_ver();
5014   1      
5015   1      }
5016          
5017          void send_crc_buf(void)//å‘å›ºå®šçš„12å­—èŠ‚çš„æ•°æ®
5018          {
5019   1        send_buf[0]='#';
5020   1          send_buf[1]=par_buf[20]+0x41;
5021   1        send_buf[10]=0x0d;
5022   1          //send_buf[10]=send_buf[1]^send_buf[2]^send_buf[3]^send_buf[4]^send_buf[5]^send_buf[6]^send_buf[7]^sen
             -d_buf[8]^send_buf[9];
5023   1        send_buf[11]=0x0a;
5024   1         if(par_buf[37]==0x01)
5025   1        {
5026   2          DXEN = 1;
5027   2          RXEN = 0;
5028   2         }
5029   1      
5030   1        txcount0=11;
5031   1        txptr0=1;//ä»ç¬¬1ä¸ªå­—èŠ‚å¼€å§‹å‘é€
5032   1        SBUF1=send_buf[0];//å‘æ•°æ®
5033   1      }
5034          
5035          
5036           void send_dt(void)
5037          {
5038   1        uchar idata  rd1,rd2,rd3,rd4,rd5;
5039   1      
5040   1        ulint data now_val_temp;
5041   1      
5042   1        if(find_key!=0) return;
5043   1      
5044   1          now_val_temp = now_val;
5045   1      
5046   1        rd1 = now_val_temp/10000;
5047   1        rd2 = (now_val_temp%10000)/1000;
5048   1        rd3 = (now_val_temp%1000)/100;
5049   1        rd4 = (now_val_temp%100)/10;
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 82  

5050   1        rd5 = now_val_temp%10;
5051   1      
5052   1          rd1 = rd1+0x30;
5053   1          rd2 = rd2+0x30;
5054   1          rd3 = rd3+0x30;
5055   1          rd4 = rd4+0x30;
5056   1          rd5 = rd5+0x30;
5057   1      
5058   1      
5059   1      if(send_enable==1)
5060   1      {
5061   2      
5062   2            send_buf[2]= 'D';
5063   2            send_buf[3]= 'T';
5064   2         if(err_flag==0)
5065   2         {
5066   3      
5067   3            send_buf[4]=rd1;
5068   3            send_buf[5]=rd2;
5069   3            send_buf[6]='.';
5070   3            send_buf[7]= rd3;
5071   3            send_buf[8]=rd4;
5072   3            send_buf[9]=rd5;
5073   3        }
5074   2        else if(err_flag==1)
5075   2          {
5076   3            send_buf[4]=receive0_temp[0];
5077   3            send_buf[5]= receive0_temp[1];
5078   3            send_buf[6]=receive0_temp[2];
5079   3            send_buf[7]=' ';
5080   3            send_buf[8]=' ';
5081   3            send_buf[9]=' ';
5082   3      
5083   3      
5084   3          }
5085   2        send_crc_buf();
5086   2      
5087   2      
5088   2      
5089   2      
5090   2        }
5091   1      
5092   1      
5093   1      
5094   1      }
5095          
5096           void send_dt1(void)
5097          {
5098   1        uchar idata  rd1,rd2,rd3,rd4,rd5;
5099   1      
5100   1        ulint data now_val_temp;
5101   1          if(tl0timer0<5)return;//æ­¤å€¼ä¸º5æ¯”è¾ƒå¥½ï¼Œå¤ªå°äº†ï¼Œå‘é€å€¼å¤ªå¿«ï¼Œä¼šå½±å“UART0çš„æ¥æ”¶ã€‚
5102   1        if(find_key!=0) return;
5103   1      
5104   1          now_val_temp = now_val;
5105   1      
5106   1        rd1 = now_val_temp/10000;
5107   1        rd2 = (now_val_temp%10000)/1000;
5108   1        rd3 = (now_val_temp%1000)/100;
5109   1        rd4 = (now_val_temp%100)/10;
5110   1        rd5 = now_val_temp%10;
5111   1      
5112   1          rd1 = rd1+0x30;
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 83  

5113   1          rd2 = rd2+0x30;
5114   1          rd3 = rd3+0x30;
5115   1          rd4 = rd4+0x30;
5116   1          rd5 = rd5+0x30;
5117   1      
5118   1      
5119   1      if(send_enable==1)
5120   1      {
5121   2      
5122   2      
5123   2         if(err_flag==0)
5124   2         {
5125   3      
5126   3            send_buf[0]=rd1;
5127   3            send_buf[1]=rd2;
5128   3            send_buf[2]='.';
5129   3            send_buf[3]= rd3;
5130   3            send_buf[4]=rd4;
5131   3            send_buf[5]=rd5;
5132   3        }
5133   2        else if(err_flag==1)
5134   2          {
5135   3            send_buf[0]=receive0_temp[0];
5136   3            send_buf[1]= receive0_temp[1];
5137   3            send_buf[2]=receive0_temp[2];
5138   3            send_buf[3]=' ';
5139   3            send_buf[4]=' ';
5140   3            send_buf[5]=' ';
5141   3      
5142   3      
5143   3          }
5144   2          send_buf[6]=0x0d;
5145   2          send_buf[7]=0x0a;
5146   2        txcount0=7;
5147   2        txptr0=1;//ä»ç¬¬1ä¸ªå­—èŠ‚å¼€å§‹å‘é€
5148   2        SBUF1=send_buf[0];//å‘æ•°æ®
5149   2        delay1s();
5150   2      
5151   2      
5152   2      
5153   2        }
5154   1      
5155   1      
5156   1      
5157   1      }
5158          void rb1(void)
5159          {
5160   1      
5161   1      
5162   1              if((receive1[6]=='.')&&(receive1[4]>=0x30)&&(receive1[4]<=0x39)&&(receive1[5]>=0x30)&&(receive1[5]
             -<=0x39)&&(receive1[7]>=0x30)&&(receive1[7]<=0x39)&&(receive1[8]>=0x30)&&(receive1[8]<=0x39)&&(receive1[9]>=0x30)&&(recei
             -ve1[9]<=0x39))
5163   1            {
5164   2            receive1[4]=receive1[4]-0x30;
5165   2            receive1[5]=receive1[5]-0x30;
5166   2            receive1[7]=receive1[7]-0x30;
5167   2            receive1[8]=receive1[8]-0x30;
5168   2            receive1[9]=receive1[9]-0x30;
5169   2      
5170   2            par_buf[0]=receive1[4];
5171   2            par_buf[1]=receive1[5];
5172   2            par_buf[2]=receive1[7];
5173   2            par_buf[3]=receive1[8];
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 84  

5174   2            par_buf[4]=receive1[9];
5175   2      
5176   2      
5177   2      
5178   2              EA=0;
5179   2      
5180   2              erase_par();
5181   2              write_par();  //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
5182   2               EA =1;
5183   2      
5184   2                send_rb0();
5185   2              }
5186   1      
5187   1      
5188   1      }
5189          
5190          void send_rb(void)
5191          {
5192   1            send_buf[2]= 'R';
5193   1            send_buf[3]= 'B';
5194   1            send_buf[4]=par_buf[0]+0x30;
5195   1            send_buf[5]=par_buf[1]+0x30;
5196   1            send_buf[6]='.';
5197   1            send_buf[7]=par_buf[2]+0x30;
5198   1            send_buf[8]=par_buf[3]+0x30;
5199   1            send_buf[9]=par_buf[4]+0x30;
5200   1      
5201   1            send_crc_buf();
5202   1      
5203   1      }
5204          void send_rb0()
5205          {
5206   1        // SCON0 = 0x00;
5207   1        ES0=0;
5208   1         PCA0CPH4 = 0xa0;
5209   1        SBUF0 = 'R';  while(!TI0);TI0 = 0;
5210   1      SBUF0 = 'B';  while(!TI0);TI0 = 0;
5211   1      SBUF0 = par_buf[0]+0x30;while(!TI0);TI0 = 0;
5212   1      SBUF0 = par_buf[1]+0x30;while(!TI0);TI0 = 0;
5213   1      SBUF0 = '.';            while(!TI0);TI0 = 0;
5214   1      SBUF0 = par_buf[2]+0x30;while(!TI0);TI0 = 0;
5215   1      SBUF0 = par_buf[3]+0x30;while(!TI0);TI0 = 0;
5216   1      SBUF0 = par_buf[4]+0x30;while(!TI0);TI0 = 0;
5217   1      SBUF0 = 0x0d;           while(!TI0);TI0 = 0;
5218   1      SBUF0 = 0x0a;           while(!TI0);TI0 = 0;
5219   1      delay1s();
5220   1      delay1s();
5221   1      SBUF0 = 'D';while(!TI0);TI0 = 0;
5222   1      SBUF0 = 'T';while(!TI0);TI0 = 0;
5223   1      SBUF0 = 0x0d;           while(!TI0);TI0 = 0;
5224   1      SBUF0 = 0x0a;           while(!TI0);TI0 = 0;
5225   1      
5226   1      delay1s();
5227   1      delay1s();
5228   1      
5229   1        // SCON0 = 0x10;
5230   1         ES0=1;
5231   1      }
5232          void send_rb3()
5233          {
5234   1        // SCON0 = 0x00;
5235   1        ES0=0;
5236   1         PCA0CPH4 = 0xa0;
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 85  

5237   1        SBUF0 = 'R';  while(!TI0);TI0 = 0;
5238   1      SBUF0 = 'B';  while(!TI0);TI0 = 0;
5239   1      SBUF0 = par_buf[0]+0x30;while(!TI0);TI0 = 0;
5240   1      SBUF0 = par_buf[1]+0x30;while(!TI0);TI0 = 0;
5241   1      SBUF0 = '.';            while(!TI0);TI0 = 0;
5242   1      SBUF0 = par_buf[2]+0x30;while(!TI0);TI0 = 0;
5243   1      SBUF0 = par_buf[3]+0x30;while(!TI0);TI0 = 0;
5244   1      SBUF0 = par_buf[4]+0x30;while(!TI0);TI0 = 0;
5245   1      SBUF0 = 0x0d;           while(!TI0);TI0 = 0;
5246   1      SBUF0 = 0x0a;           while(!TI0);TI0 = 0;
5247   1      delay1s();
5248   1      delay1s();
5249   1      
5250   1         ES0=1;
5251   1      }
5252          void re1(void)
5253          {
5254   1      
5255   1      
5256   1      
5257   1              if((receive1[6]=='.')&&(receive1[4]>=0x30)&&(receive1[4]<=0x39)&&(receive1[5]>=0x30)&&(receive1[5]
             -<=0x39)&&(receive1[7]>=0x30)&&(receive1[7]<=0x39)&&(receive1[8]>=0x30)&&(receive1[8]<=0x39)&&(receive1[9]>=0x30)&&(recei
             -ve1[9]<=0x39))
5258   1            {
5259   2            receive1[4]=receive1[4]-0x30;
5260   2            receive1[5]=receive1[5]-0x30;
5261   2            receive1[7]=receive1[7]-0x30;
5262   2            receive1[8]=receive1[8]-0x30;
5263   2            receive1[9]=receive1[9]-0x30;
5264   2      
5265   2            par_buf[5]=receive1[4];
5266   2            par_buf[6]=receive1[5];
5267   2            par_buf[7]=receive1[7];
5268   2            par_buf[8]=receive1[8];
5269   2            par_buf[9]=receive1[9];
5270   2      
5271   2      
5272   2      
5273   2      
5274   2      
5275   2      
5276   2              EA=0;
5277   2      
5278   2              erase_par();
5279   2              write_par();  //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
5280   2                EA =1;
5281   2                send_re0();
5282   2            }
5283   1      
5284   1      
5285   1      }
5286          void send_re(void)
5287          {
5288   1      
5289   1      
5290   1            send_buf[2]= 'R';
5291   1            send_buf[3]= 'E';
5292   1            send_buf[4]=par_buf[5]+0x30;
5293   1            send_buf[5]=par_buf[6]+0x30;
5294   1            send_buf[6]='.';
5295   1            send_buf[7]=par_buf[7]+0x30;
5296   1            send_buf[8]=par_buf[8]+0x30;
5297   1            send_buf[9]=par_buf[9]+0x30;
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 86  

5298   1      
5299   1            send_crc_buf();
5300   1      
5301   1      }
5302          void send_re0()
5303          {
5304   1        // SCON0 = 0x00;
5305   1         ES0=0;
5306   1         PCA0CPH4 = 0xa0;
5307   1      SBUF0 = 'R';           while(!TI0);TI0 = 0;
5308   1      SBUF0 = 'E';             while(!TI0);TI0 = 0;
5309   1      SBUF0 = par_buf[5]+0x30; while(!TI0);TI0 = 0;
5310   1      SBUF0 = par_buf[6]+0x30; while(!TI0);TI0 = 0;
5311   1      SBUF0 = '.';             while(!TI0);TI0 = 0;
5312   1      SBUF0 = par_buf[7]+0x30; while(!TI0);TI0 = 0;
5313   1      SBUF0 = par_buf[8]+0x30; while(!TI0);TI0 = 0;
5314   1      SBUF0 = par_buf[9]+0x30; while(!TI0);TI0 = 0;
5315   1      SBUF0 = 0x0d;            while(!TI0);TI0 = 0;
5316   1      SBUF0 = 0x0a;            while(!TI0);TI0 = 0;
5317   1      delay1s();
5318   1      delay1s();
5319   1      SBUF0 = 'D';while(!TI0);TI0 = 0;
5320   1      SBUF0 = 'T';while(!TI0);TI0 = 0;
5321   1      SBUF0 = 0x0d;           while(!TI0);TI0 = 0;
5322   1      SBUF0 = 0x0a;           while(!TI0);TI0 = 0;
5323   1      delay1s();
5324   1      delay1s();
5325   1      // SCON0 = 0x10;
5326   1       ES0=1;
5327   1      }
5328          void send_re3()
5329          {
5330   1        // SCON0 = 0x00;
5331   1         ES0=0;
5332   1         PCA0CPH4 = 0xa0;
5333   1      SBUF0 = 'R';           while(!TI0);TI0 = 0;
5334   1      SBUF0 = 'E';             while(!TI0);TI0 = 0;
5335   1      SBUF0 = par_buf[5]+0x30; while(!TI0);TI0 = 0;
5336   1      SBUF0 = par_buf[6]+0x30; while(!TI0);TI0 = 0;
5337   1      SBUF0 = '.';             while(!TI0);TI0 = 0;
5338   1      SBUF0 = par_buf[7]+0x30; while(!TI0);TI0 = 0;
5339   1      SBUF0 = par_buf[8]+0x30; while(!TI0);TI0 = 0;
5340   1      SBUF0 = par_buf[9]+0x30; while(!TI0);TI0 = 0;
5341   1      SBUF0 = 0x0d;            while(!TI0);TI0 = 0;
5342   1      SBUF0 = 0x0a;            while(!TI0);TI0 = 0;
5343   1      delay1s();
5344   1      delay1s();
5345   1      
5346   1       ES0=1;
5347   1      }
5348          
5349          void dl1(void)
5350          {
5351   1      
5352   1      
5353   1      
5354   1              if((receive1[6]=='.')&&(receive1[4]>=0x30)&&(receive1[4]<=0x39)&&(receive1[5]>=0x30)&&(receive1[5]
             -<=0x39)&&(receive1[7]>=0x30)&&(receive1[7]<=0x39)&&(receive1[8]>=0x30)&&(receive1[8]<=0x39)&&(receive1[9]>=0x30)&&(recei
             -ve1[9]<=0x39))
5355   1            {
5356   2            receive1[4]=receive1[4]-0x30;
5357   2            receive1[5]=receive1[5]-0x30;
5358   2            receive1[7]=receive1[7]-0x30;
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 87  

5359   2            receive1[8]=receive1[8]-0x30;
5360   2            receive1[9]=receive1[9]-0x30;
5361   2      
5362   2            par_buf[15]=receive1[4];
5363   2            par_buf[16]=receive1[5];
5364   2            par_buf[17]=receive1[7];
5365   2            par_buf[18]=receive1[8];
5366   2            par_buf[19]=receive1[9];
5367   2      
5368   2      
5369   2      
5370   2      
5371   2              EA=0;
5372   2      
5373   2              erase_par();
5374   2              write_par();  //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
5375   2                EA=1;
5376   2      
5377   2        }
5378   1      
5379   1      }
5380          
5381          void send_dl(void)
5382          {
5383   1      
5384   1            send_buf[2]= 'D';
5385   1            send_buf[3]= 'L';
5386   1            send_buf[4]=par_buf[15]+0x30;
5387   1            send_buf[5]=par_buf[16]+0x30;
5388   1            send_buf[6]='.';
5389   1            send_buf[7]=par_buf[17]+0x30;
5390   1            send_buf[8]=par_buf[18]+0x30;
5391   1            send_buf[9]=par_buf[19]+0x30;
5392   1      
5393   1              send_crc_buf();
5394   1      
5395   1      }
5396          void dh1(void)
5397          {
5398   1      
5399   1      
5400   1      
5401   1              if((receive1[6]=='.')&&(receive1[4]>=0x30)&&(receive1[4]<=0x39)&&(receive1[5]>=0x30)&&(receive1[5]
             -<=0x39)&&(receive1[7]>=0x30)&&(receive1[7]<=0x39)&&(receive1[8]>=0x30)&&(receive1[8]<=0x39)&&(receive1[9]>=0x30)&&(recei
             -ve1[9]<=0x39))
5402   1            {
5403   2            receive1[4]=receive1[4]-0x30;
5404   2            receive1[5]=receive1[5]-0x30;
5405   2            receive1[7]=receive1[7]-0x30;
5406   2            receive1[8]=receive1[8]-0x30;
5407   2            receive1[9]=receive1[9]-0x30;
5408   2      
5409   2            par_buf[10]=receive1[4];
5410   2            par_buf[11]=receive1[5];
5411   2            par_buf[12]=receive1[7];
5412   2            par_buf[13]=receive1[8];
5413   2            par_buf[14]=receive1[9];
5414   2              EA=0;
5415   2      
5416   2              erase_par();
5417   2              write_par();  //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
5418   2                EA=1;
5419   2            }
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 88  

5420   1      
5421   1      
5422   1      
5423   1      
5424   1      }
5425          void send_dh(void)
5426          {
5427   1      
5428   1            send_buf[2]= 'D';
5429   1            send_buf[3]= 'H';
5430   1            send_buf[4]=par_buf[10]+0x30;
5431   1            send_buf[5]=par_buf[11]+0x30;
5432   1            send_buf[6]='.';
5433   1            send_buf[7]=par_buf[12]+0x30;
5434   1            send_buf[8]=par_buf[13]+0x30;
5435   1            send_buf[9]=par_buf[14]+0x30;
5436   1              send_crc_buf();
5437   1      
5438   1      }
5439          
5440          void ah1(void)
5441          {
5442   1      
5443   1      
5444   1      
5445   1              if((receive1[6]=='.')&&(receive1[4]>=0x30)&&(receive1[4]<=0x39)&&(receive1[5]>=0x30)&&(receive1[5]
             -<=0x39)&&(receive1[7]>=0x30)&&(receive1[7]<=0x39)&&(receive1[8]>=0x30)&&(receive1[8]<=0x39)&&(receive1[9]>=0x30)&&(recei
             -ve1[9]<=0x39))
5446   1            {
5447   2            receive1[4]=receive1[4]-0x30;
5448   2            receive1[5]=receive1[5]-0x30;
5449   2            receive1[7]=receive1[7]-0x30;
5450   2            receive1[8]=receive1[8]-0x30;
5451   2            receive1[9]=receive1[9]-0x30;
5452   2      
5453   2            par_buf[21]=receive1[4];
5454   2            par_buf[22]=receive1[5];
5455   2            par_buf[23]=receive1[7];
5456   2            par_buf[24]=receive1[8];
5457   2            par_buf[25]=receive1[9];
5458   2      
5459   2      
5460   2      
5461   2      
5462   2      
5463   2              EA=0;
5464   2      
5465   2              erase_par();
5466   2              write_par();  //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
5467   2               EA=1;
5468   2        }
5469   1      
5470   1      
5471   1      
5472   1      
5473   1      }
5474          void send_ah(void)
5475          {
5476   1      
5477   1            send_buf[2]= 'A';
5478   1            send_buf[3]= 'H';
5479   1            send_buf[4]=par_buf[21]+0x30;
5480   1            send_buf[5]=par_buf[22]+0x30;
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 89  

5481   1            send_buf[6]='.';
5482   1            send_buf[7]=par_buf[23]+0x30;
5483   1            send_buf[8]=par_buf[24]+0x30;
5484   1            send_buf[9]=par_buf[25]+0x30;
5485   1              send_crc_buf();
5486   1      }
5487          
5488          
5489          void opt(void)
5490          {
5491   1      
5492   1          if((receive1[4]>=0x31)&&(receive1[4]<=0x33)&&(receive1[5]==0x30)&&(receive1[6]==0x30)&&(receive1[7]==0
             -x30)&&(receive1[8]==0x30)&&(receive1[9]==0x30))
5493   1            {
5494   2            receive1[4]=receive1[4]-0x30;
5495   2      
5496   2            par_buf[34]=receive1[4];
5497   2      
5498   2      
5499   2      
5500   2               EA=0;
5501   2      
5502   2              erase_par();
5503   2              write_par();  //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
5504   2              EA=1;
5505   2      
5506   2              }
5507   1      }
5508          
5509          
5510          void send_opt(void)
5511          {
5512   1            send_buf[2]= 'O';
5513   1            send_buf[3]= 'P';
5514   1            send_buf[4]=par_buf[34]+0x30;
5515   1            send_buf[5]=' ';
5516   1            send_buf[6]=' ';
5517   1            send_buf[7]=' ';
5518   1            send_buf[8]=' ';
5519   1            send_buf[9]=' ';
5520   1              send_crc_buf();
5521   1      }
5522           void rl(void)
5523          {
5524   1      
5525   1          if((receive1[4]>=0x30)&&(receive1[4]<=0x31)&&(receive1[5]==0x30)&&(receive1[6]==0x30)&&(receive1[7]==0
             -x30)&&(receive1[8]==0x30)&&(receive1[9]==0x30))
5526   1            {
5527   2            receive1[4]=receive1[4]-0x30;
5528   2      
5529   2            par_buf[35]=receive1[4];
5530   2      
5531   2      
5532   2      
5533   2               EA=0;
5534   2      
5535   2              erase_par();
5536   2              write_par();  //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
5537   2              EA=1;
5538   2      
5539   2              }
5540   1      }
5541          
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 90  

5542          
5543          void send_rl(void)
5544          {
5545   1            send_buf[2]= 'R';
5546   1            send_buf[3]= 'L';
5547   1            send_buf[4]=par_buf[35]+0x30;
5548   1            send_buf[5]=' ';
5549   1            send_buf[6]=' ';
5550   1            send_buf[7]=' ';
5551   1            send_buf[8]=' ';
5552   1            send_buf[9]=' ';
5553   1              send_crc_buf();
5554   1      }
5555          void po(void)
5556          {
5557   1      
5558   1          if((receive1[4]>=0x30)&&(receive1[4]<=0x31)&&(receive1[5]==0x30)&&(receive1[6]==0x30)&&(receive1[7]==0
             -x30)&&(receive1[8]==0x30)&&(receive1[9]==0x30))
5559   1            {
5560   2            receive1[4]=receive1[4]-0x30;
5561   2      
5562   2            par_buf[36]=receive1[4];
5563   2      
5564   2      
5565   2      
5566   2               EA=0;
5567   2      
5568   2              erase_par();
5569   2              write_par();  //å°†ä¿®æ”¹å¥½åçš„å†…å®¹å†™å…¥flash
5570   2      
5571   2                 EA=1;
5572   2              }
5573   1      }
5574          
5575          
5576          void send_po(void)
5577          {
5578   1            send_buf[2]= 'P';
5579   1            send_buf[3]= 'O';
5580   1            send_buf[4]=par_buf[36]+0x30;
5581   1            send_buf[5]=' ';
5582   1            send_buf[6]=' ';
5583   1            send_buf[7]=' ';
5584   1            send_buf[8]=' ';
5585   1            send_buf[9]=' ';
5586   1              send_crc_buf();
5587   1      }
5588          void send_ver()
5589          {
5590   1            send_buf[2]= 'V';
5591   1            send_buf[3]= 'e';
5592   1            send_buf[4]='r';
5593   1            send_buf[5]=version_major;
5594   1            send_buf[6]='.';
5595   1            send_buf[7]=version_minor;
5596   1            send_buf[8]='0';
5597   1            send_buf[9]='0';
5598   1            send_crc_buf();
5599   1      
5600   1      }
5601          
5602          
5603          /////////////////////////////////////////////////////
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 91  

5604          /*                     ä¸»ç¨‹åº                      */
5605          /////////////////////////////////////////////////////
5606          void main(void)
5607          {
5608   1          uchar i;
5609   1      
5610   1          Init_Device();
5611   1      
5612   1        delay1s();
5613   1        delay1s();
5614   1        delay1s();
5615   1      
5616   1        m_init();
5617   1        m_send(0x01,0x7f);
5618   1        m_send(0x02,0x7f);
5619   1        m_send(0x03,0x7f);
5620   1        m_send(0x04,0x7f);
5621   1        m_send(0x05,0x7f);
5622   1      
5623   1      
5624   1          POWER = 0;
5625   1          EA = 0;
5626   1         read_par();
5627   1      
5628   1        if (( (par_buf[26]==0x01)&&(par_buf[27]==0x02)&&(par_buf[28]==0x03))==0)
5629   1        {
5630   2          erase_par();
5631   2          init_par();
5632   2      
5633   2        }
5634   1      
5635   1        for (i=0;i<38;i++)
5636   1        {
5637   2          if ( par_buf[i]>9)
5638   2          {
5639   3              PCA0CPH4 = 0xa0;
5640   3              erase_par();
5641   3              init_par();
5642   3      
5643   3          }
5644   2        }
5645   1      
5646   1      
5647   1      
5648   1        //STC1387init
5649   1          SLEW = 1;
5650   1        if(par_buf[37]==0x00)
5651   1        {
5652   2        MODE = 0;//RS232 mode
5653   2        }
5654   1        else if(par_buf[37]==0x01)
5655   1        {MODE = 1;}//RS485 mode
5656   1      
5657   1      
5658   1        RXEN = 1;
5659   1        DXEN = 0;
5660   1      
5661   1      
5662   1        UP = par_buf[10]*10000+par_buf[11]*1000+par_buf[12]*100+par_buf[13]*10+par_buf[14];
5663   1        LO = par_buf[15]*10000+par_buf[16]*1000+par_buf[17]*100+par_buf[18]*10+par_buf[19];
5664   1        AH = par_buf[21]*10000+par_buf[22]*1000+par_buf[23]*100+par_buf[24]*10+par_buf[25];
5665   1      
5666   1      
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 92  

5667   1        CTR = par_buf[34];
5668   1      
5669   1      
5670   1      
5671   1          read_par();
5672   1      
5673   1      
5674   1        // æ¿€å…‰æµ‹è·ä»ªåˆå§‹åŒ–æ—¶é—´
5675   1      
5676   1        delay1s();
5677   1        delay1s();
5678   1          delay1s();
5679   1        delay1s();
5680   1        delay1s();
5681   1        delay1s();
5682   1      
5683   1      
5684   1        trans0("ASdt\r\n");
5685   1        delay1s();
5686   1        delay1s();
5687   1        trans0("ASdt\r\n");
5688   1        delay1s();
5689   1        delay1s();
5690   1      
5691   1        trans0("SE2\r\n");
5692   1        delay1s();
5693   1        delay1s();
5694   1      
5695   1        send_rb3();
5696   1        send_re3();
5697   1      
5698   1        trans0("DT\r\n");
5699   1        delay1s();
5700   1        delay1s();
5701   1          trans0("DT\r\n");
5702   1        delay1s();
5703   1      
5704   1          function_flag = 0;
5705   1        find_key = 0;
5706   1      
5707   1        //Added to fix Comm lockup problem MD 20210409
5708   1        i=SBUF1;        // flush UART1 input buffer
5709   1        i=SBUF1;        // flush UART1 input buffer
5710   1        rcv_count = 0;      // state: waiting for '#'
5711   1        uart1_receve_end = 0; // state: no complete message received
5712   1        b_head_sure=0;      // state: no '#' found
5713   1        UART1_Init();     // reinitialize UART1
5714   1        RXEN = 1;       // RS-485 driver receive enable
5715   1        DXEN = 0;       // RS-485 driver transmit disable
5716   1      
5717   1        EA = 1;
5718   1        RI0 = 0;
5719   1        ES0 = 1;
5720   1        SCON1 |= 0x01;//å¼€å¯ä¸€æ¬¡ä¸­æ–­ï¼Œè§£å†³UART1ä¼˜å…ˆçº§é«˜å¯¼è‡´UART0ä¸å·¥ä½œçš„æƒ…å†µï¼ˆUART1ä¸­æ–­ä
             -¸€æ¬¡åUART0æ‰èƒ½è¿›å…¥ä¸­æ–­ï¼‰
5721   1        i=SBUF1;        // flush UART1 input buffer
5722   1        i=SBUF1;        // flush UART1 input buffer
5723   1        // delay1s();
5724   1      
5725   1          delay20ms();
5726   1        while(1)
5727   1        {
5728   2             PCA0CPH4 = 0xa0;
C51 COMPILER V9.60.0.0   DISTANCEMAIN                                                      06/05/2024 10:08:10 PAGE 93  

5729   2      
5730   2           scan_keyboard();
5731   2      
5732   2            direct_uart0();
5733   2      
5734   2           direct_uart1();
5735   2           if(par_buf[37]==0)
5736   2           {send_dt1();  }
5737   2      
5738   2        }
5739   1      }
5740          
5741          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   9950    ----
   CONSTANT SIZE    =    138    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     71      22
   IDATA SIZE       =     48      34
   BIT SIZE         =      7       1
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
